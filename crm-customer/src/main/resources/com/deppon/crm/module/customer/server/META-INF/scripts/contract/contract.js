Ext.JSON.encodeDate=function(d){return d.getTime();};String.prototype.replaceAll=function(AFindText,ARepText){raRegExp=new RegExp(AFindText,"g");return this.replace(raRegExp,ARepText);};DpUtil=function(){};DpUtil.isEmpty=function(str){return Ext.isEmpty(str);};DpUtil.requestJsonAjax=function(url,params,successFn,failFn,timeout)
{Ext.Ajax.request({url:url,jsonData:params,timeout:(Ext.isEmpty(timeout))?600000:timeout,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.requestJsonAjaxSync=function(url,params,successFn,failFn,timeout)
{Ext.Ajax.request({url:url,async:false,jsonData:params,timeout:(Ext.isEmpty(timeout))?600000:timeout,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.requestFileUploadAjax=function(url,form,successFn,failFn)
{Ext.Ajax.request({url:url,form:form,isUpload:true,success:function(form,action){var result=action.result;if(result.success){successFn(result);}else{failFn(result);}},failure:function(form,action){var result=action.result;failFn(result);}});};DpUtil.requestAjax=function(url,params,successFn,failFn)
{Ext.Ajax.request({url:url,params:params,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.changeLongToDate=function(value){if(value!=null){var date=new Date(value);return date;}else{return null;}};DpUtil.renderDate=function(value){if(value!=null){return Ext.Date.format(new Date(value),'Y-m-d');}else{return null;}};DpUtil.changeDictionaryDescipToCode=function(store,descrip){var record=store.findRecord('codeDesc',descrip);if(!DpUtil.isEmpty(record)){return record.get('code');}else{return"";}};DpUtil.changeDictionaryCodeToDescrip=function(value,dataDictionary){if(value!=null&&dataDictionary!=null){for(var i=0;i<dataDictionary.length;i++){if(value==dataDictionary[i].code){return dataDictionary[i].codeDesc;}}}else{return null;}};DpUtil.changeBooleanToDescrip=function(value){if(value==false){return i18n('i18n.ChangeContactAffiliatedRelationView.no');}else if(value==true){return i18n('i18n.ChangeContactAffiliatedRelationView.yes');}
return null;};DpUtil.changeIntToDescrip=function(value){if(value==0){return i18n('i18n.ChangeContactAffiliatedRelationView.no');}else if(value==1){return i18n('i18n.ChangeContactAffiliatedRelationView.yes');}
return null;};DpUtil.changeNullToEmptyString=function(value){if(value==null){return'';}else{return value}};DpUtil.compareRecordFieldIsChange=function(oldValue,newValue){if(oldValue==newValue){return false;}else if(DpUtil.changeNullToEmptyString(oldValue)==DpUtil.changeNullToEmptyString(newValue)){return false;}else{return true;}};DpUtil.keyPress=function(e,getData,param,limit,successFn){var paramValue=e.target.value;if(Ext.isEmpty(paramValue)){return;}
if(paramValue.length<limit){return;}
if(e.getKey()==Ext.EventObject.ENTER&&paramValue!=""&&paramValue.length>=limit)
{var failureFn=function(json){DpUtil.showMessage(json.message);};getData(param,successFn,failureFn);}};DpUtil.showMessage=function(meaage){top.Ext.MessageBox.alert(i18n('i18n.PotentialCustManagerView.message'),meaage);};DpUtil.showConfimMessageBox=function(msg,message,yesFn,noFn){Ext.MessageBox.confirm(msg,message,function(e){if(e=='yes'){yesFn;}else{noFn;}});};DpUtil.createStore=function(storeId,model,fields,data){var store=Ext.data.StoreManager.lookup(storeId);if(Ext.isEmpty(data)){data=[];}
if(!Ext.isEmpty(model)){if(store===undefined){store=Ext.create('Ext.data.Store',{storeId:storeId,model:model,data:data});}}
if(!Ext.isEmpty(fields)){if(store===undefined){store=Ext.create('Ext.data.Store',{storeId:storeId,fields:fields,data:data});}}
return store;};DpUtil.changeLongToDate=function(value){if(value!=null){var date=new Date(value);return date;}else{return null;}};DpUtil.trimString=function(value){if(!Ext.isEmpty(value)){return value.trim();}
return value;};DpUtil.createDateCombo=function(fieldLabel,name,store,allowBlank,readOnly,labelWidth,width,blankText,changEvent){var fn=function(){};var chang=function(field,newValue){if(Ext.isEmpty(newValue)){field.setValue(null);}};var combo=Ext.create('Ext.form.ComboBox',{fieldLabel:fieldLabel,xtype:'combobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',allowBlank:allowBlank,readOnly:readOnly,name:name,labelWidth:labelWidth,width:width,store:store,blankText:blankText,listeners:{change:(changEvent==null)?fn:((changEvent==true)?chang:changEvent)}});return combo;};Ext.define('DpComboBox',{extend:'Ext.form.ComboBox',alias:['widget.dpcombobox','widget.dpcombo'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpNumberField',{extend:'Ext.form.Number',alias:['widget.dpnumberfield','widget.dpnumber'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpDateField',{extend:'Ext.form.Date',alias:['widget.dpdatefield','widget.dpdate'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpTimeField',{extend:'Ext.form.Time',alias:'widget.dpdtimefield',setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});DpUtil.getCurrentMonthDays=function(month){var currentMonth=month+1;switch(currentMonth){case 1:case 3:case 5:case 7:case 8:case 10:case 12:return 31;break;case 2:return 28;break;default:return 30;break;　　}}
DpUtil.keyPress=function(e,getData,param,limit,successFn){var paramValue=e.target.value;if(Ext.isEmpty(paramValue)){return;}
if(paramValue.length<limit){return;}
if(e.getKey()==Ext.EventObject.ENTER&&paramValue!=""&&paramValue.length>=limit)
{var failureFn=function(json){DpUtil.showMessage(json.message);};getData(param,successFn,failureFn);}};DpUtil.checkDataInOneYear=function(objPre,objNext){var success=true;var message='';if((DpUtil.isEmpty(objPre.getValue())||DpUtil.isEmpty(objNext.getValue()))){var success=false;var message=i18n('i18n.DpUtil.d_notAllDateNull');}else if(!DpUtil.isEmpty(objPre.getValue())&&!DpUtil.isEmpty(objNext.getValue())){if(objPre.getValue()>objNext.getValue()){var success=false;var message=i18n('i18n.DpUtil.d_startNotBigger');}else{if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()<=1){if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()==1){var monthsNext=objNext.getValue().getMonth()-objPre.getValue().getMonth()+12;if(monthsNext<=12){if(monthsNext==12){if(objNext.getValue().getDate()>objPre.getValue().getDate()){var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}else{var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}else{var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}
return{success:success,message:message};}
DpUtil.checkDataInOneYear1=function(year,month,day){var data=new Date();data.setYear(new Date().getYear()+year);data.setYear(new Date().getMonth()+month);data.setYear(new Date().getDay()+day);if((DpUtil.isEmpty(objPre.getValue())||DpUtil.isEmpty(objNext.getValue()))){var success=false;var message=i18n('i18n.DpUtil.d_notAllDateNull');}else if(!DpUtil.isEmpty(objPre.getValue())&&!DpUtil.isEmpty(objNext.getValue())){if(objPre.getValue()>objNext.getValue()){var success=false;var message=i18n('i18n.DpUtil.d_startNotBigger');}else{if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()<=1){var monthsNext=objNext.getValue().getMonth()-objPre.getValue().getMonth()+12;if(monthsNext>=0&&monthsNext<=12){if(monthsNext==12){if(objNext.getValue().getDate()>objPre.getValue().getDate()){var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}}}}}
DpUtil.linkWayLimit=function(regText){var mobil=/^1\d{10}$/;var tel=/^\d{3}[\d\*-/]{4,17}$/;var idCard=/^([\d]{15}|[\d]{18}|[\d]{17}X)$/;var defaultValue=/^\d{11}$/;switch(regText){case'M':return mobil;break;case'T':return tel;break;case'I':return tel;break;default:return defaultValue;break;　　}}
DpUtil.defaultDept=function(form,fieldName){var dept=form.getForm().findField(fieldName);dept.store.add(Ext.create('CurrentUserDeptListModel',{'deptId':top.User.deptId,'deptName':top.User.deptName}));dept.setValue(top.User.deptId);}
Ext.define('SearchMemberDataDictionaryModel',{extend:'Ext.data.Model',fields:['code','codeDesc']});var SearchMemberDataDictionary={};Ext.define('SearchMemberMemberGradeStore',{extend:'Ext.data.Store',model:'SearchMemberDataDictionaryModel',data:null});Ext.define('SearchMemberConditionModel',{extend:'Ext.data.Model',fields:[{name:'deptId'},{name:'custNumber'},{name:'custName'},{name:'custGrad'},{name:'linkManNumber'},{name:'linkManName'},{name:'mobile'},{name:'telePhone'},{name:'idCard'}]});Ext.define('SearchMemberResultModel',{extend:'Ext.data.Model',fields:[{name:'custId',type:'string'},{name:'contactId',type:'string'},{name:'custNum',type:'string'},{name:'custName',type:'string'},{name:'custGrade',type:'string'},{name:'custGroup',type:'string'},{name:'isMainLinkMan',type:'boolean'},{name:'contactNum',type:'string'},{name:'contactName',type:'string'},{name:'mobileNum',type:'string'},{name:'telNum',type:'string'},{name:'deptId',type:'string'},{name:'deptName',type:'string'},{name:'address',type:'string'},{name:'remark',type:'string'},{name:'status'},{name:'trade',type:'string'},{name:'custType',type:'string'},{name:'taxregNum',type:'string'},{name:'idCard',type:'string'},{name:'cityId',type:'string'},{name:'cityName',type:'string'}]});Ext.define('MemberSearchStore',{extend:'Ext.data.Store',model:'SearchMemberResultModel',proxy:{type:'ajax',api:{read:'searchMemberInfoList.action'},actionMethods:'POST',reader:{type:'json',root:'memberResultList'}},groupers:[{property:'custGroup',direction:'ASC'},{property:'custId',direction:'ASC'}]});Ext.define('SearchMemberData',{searchMemberGradeStore:null,searchMemberResultStore:null,loginUserDeptListStore:null,getMemberGradeStore:function(){if(this.searchMemberGradeStore==null){this.searchMemberGradeStore=getDataDictionaryByName(DataDictionary,'MEMBER_GRADE');}
return this.searchMemberGradeStore;},getDictionary:function(params,successFn,failFn){Ext.Ajax.request({url:'../common/queryAllDataDictionaryByKeys.action',async:false,jsonData:params,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});},getSearchMemberResultStore:function(){return this.searchMemberResultStore;},initSearchMemberResultStore:function(beforeLoadTransactionFn){if(this.searchMemberResultStore==null){if(beforeLoadTransactionFn!=null){this.searchMemberResultStore=Ext.create('MemberSearchStore',{listeners:{beforeload:beforeLoadTransactionFn}});}else{this.searchMemberResultStore=Ext.create('MemberSearchStore');}}
return this.searchMemberResultStore;}});
var CurrentUser={};Ext.define('ApproveDataModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'className',type:'string'},{name:'classId',type:'string'},{name:'fieldName',type:'string'},{name:'newValue',type:'string'},{name:'oldValue',type:'string'},{name:'workFlowId',type:'string'},{name:'handleType',type:'int'}]});Ext.define('WorkflowModel',{extend:'Ext.data.Model',fields:[{name:'deptName',type:'string'},{name:'workflowId',type:'string'},{name:'operatorType',type:'string'},{name:'approvalState',type:'string'},{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'approvalMan',type:'string'},{name:'contractDeptId',type:'string'}]});Ext.define('ContractViewModel',{extend:'Ext.data.Model',fields:[{name:'custId',type:'string'},{name:'custName',type:'string'},{name:'custNum',type:'string'},{name:'trade',type:'string'},{name:'custGrade',type:'string'},{name:'contactName',type:'string'},{name:'mobileNum',type:'string'},{name:'telNum',type:'string'},{name:'custType',type:'string'},{name:'taxregNum',type:'string'},{name:'idCard',type:'string'},{name:'cityId',type:'number'},{name:'city',type:'string'},{name:'address',type:'string'},{name:'contract'}]});Ext.define('ContractModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'payWay',type:'string'},{name:'arrearaMount',type:'number'},{name:'linkManName',type:'string'},{name:'linkManPhone',type:'string'},{name:'linkManMobile',type:'string'},{name:'linkManAddress',type:'string'},{name:'reconDate',type:'string'},{name:'invoicDate',type:'string'},{name:'resultDate',type:'string'},{name:'contractBeginDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},{name:'contractendDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},{name:'application',type:'string'},{name:'custId',type:'string'},{name:'deptId',type:'string'},{name:'deptName',type:'string'},{name:'iddisCount',type:'boolean'},{name:'contractStatus',type:'string'},{name:'contractSubject',type:'string'},{name:'regicapital',type:'string'},{name:'beforeContractNum',type:'string'},{name:'contractNum',type:'string'},{name:'goodsName',type:'string'},{name:'custCompany',type:'string'},{name:'contactId',type:'string'},{name:'preferentialType',type:'String'},{name:'contractStatus',type:'String'},{name:'contractWorkflowList',defaultValue:null},{name:'createUser',type:'string'},{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},{name:'modifyUser',type:'string'}]});Ext.define('ContractStore',{extend:'Ext.data.Store',model:'ContractModel',pageSize:20,proxy:{type:'ajax',api:{read:'searchContractList.action'},actionMethods:'POST',reader:{type:'json',root:'contractList',totalProperty:'totalCount'}}});Ext.define('ContractBondDeptModel',{extend:'Ext.data.Model',fields:[{name:'deptId',type:'string'},{name:'deptName',type:'string'},{name:'boundTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null}]});Ext.define('ContractDeptModel',{extend:'Ext.data.Model',fields:[{name:'contractId',type:'string'},{name:'deptId',type:'string'},{name:'deptName',type:'string'},{name:'boundTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},{name:'removeTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},{name:'workflowId',type:'string'},{name:'approvalState',type:'string'},{name:'approvalMan',type:'string'},{name:'workflowType',type:'string'},{name:'state',type:'boolean'},{name:'isDept',type:'boolean'},{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null}]});Ext.define('WorkflowStore',{extend:'Ext.data.Store',model:'WorkflowModel',proxy:{type:'memory'}});Ext.define('ContractDeptStore',{extend:'Ext.data.Store',model:'ContractBondDeptModel',proxy:{type:'memory'}});Ext.define('FileInfoModel',{extend:'Ext.data.Model',fields:[{name:'sourceId',type:'string'},{name:'sourceType',type:'string'},{name:'fileName',type:'string'},{name:'fileType',type:'string'},{name:'savePath',type:'string'},{name:'fileSize',type:'number'}]});Ext.define('ContractNounModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'contractName',type:'string'},{name:'savePath',type:'string'},{name:'fileName',type:'string'},{name:'contractId',type:'string'},{name:'contractDeptId',type:'string'}]});Ext.define('FileInfoStore',{extend:'Ext.data.Store',model:'FileInfoModel',proxy:{type:'memory'}});Ext.define('PreferentialModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'contractId',type:'string'},{name:'chargeRebate',type:'number',defaultValue:1},{name:'agentgathRate',type:'number',defaultValue:1},{name:'insuredPriceRate',type:'number',defaultValue:1},{name:'receivePriceRate',type:'number',defaultValue:1},{name:'deliveryPriceRate',type:'number',defaultValue:1}]});Ext.define('PreferentialStore',{extend:'Ext.data.Store',model:'PreferentialModel',proxy:{type:'memory'}});Ext.define('BooleanModel',{extend:'Ext.data.Model',fields:['name',{name:'value',type:'boolean'}]});Ext.define('BooleanStore',{extend:'Ext.data.Store',model:'BooleanModel',data:[{'name':'是','value':true},{'name':'否','value':false}]});Ext.define('ProtoContactStore',{extend:'Ext.data.Store',model:'SearchMemberResultModel',proxy:{type:'memory'}});Ext.define('CurrentUserDeptModel',{extend:'Ext.data.Model',fields:['deptId','deptName']});Ext.define('CurrentUserDeptStore',{extend:'Ext.data.Store',model:'CurrentUserDeptModel'});var ContractDate=[];for(var i=0;i<31;i++){var contractDateCell={};if(i!=0){contractDateCell={dateValue:i,dateDesc:i};}else{contractDateCell={dateValue:0,dateDesc:' '};}
ContractDate.push(contractDateCell);}
Ext.define('ContractDateStore',{extend:'Ext.data.Store',fields:['dateValue','dateDesc'],proxy:{type:'memory'}});Ext.define('ContractBasicData',{reckonWayStore:null,privilegeTypeStore:null,customerTypeStore:null,memberGradeStore:null,tradeStore:null,contractStore:null,contractDeptStore:null,fileInfoStore:null,preferentialStore:null,workflowStore:null,booleanStore:null,contractStateStore:null,protoContactStore:null,contractDateStore:null,getBooleanStore:function(){if(this.booleanStore==null){this.booleanStore=Ext.create('BooleanStore');}
return this.booleanStore;},getContractStateStore:function(){if(this.contractStateStore==null){this.contractStateStore=getDataDictionaryByName(DataDictionary,'CONTACT_STATUS');}
return this.contractStateStore;},getReckonWayStore:function(){if(this.reckonWayStore==null){this.reckonWayStore=getDataDictionaryByName(DataDictionary,'RECKON_WAY');}
return this.reckonWayStore;},getPrivilegeTypeStore:function(){if(this.privilegeTypeStore==null){this.privilegeTypeStore=getDataDictionaryByName(DataDictionary,'PRIVILEGE_TYPE');}
return this.privilegeTypeStore;},getCustomerTypeStore:function(){if(this.customerTypeStore==null){this.customerTypeStore=getDataDictionaryByName(DataDictionary,'CUSTOMER_TYPE');}
return this.customerTypeStore;},getMemberGradeStore:function(){if(this.memberGradeStore==null){this.memberGradeStore=getDataDictionaryByName(DataDictionary,'MEMBER_GRADE');}
return this.memberGradeStore;},getProtoContactStore:function(){if(this.protoContactStore==null){this.protoContactStore=Ext.create('ProtoContactStore');}
return this.protoContactStore;},getTradeStore:function(){if(this.tradeStore==null){this.tradeStore=getDataDictionaryByName(DataDictionary,'TRADE');}
return this.tradeStore;},getPreferentialStore:function(){if(this.preferentialStore==null){this.preferentialStore=Ext.create('PreferentialStore');}
return this.preferentialStore;},getFileInfoStore:function(){if(this.fileInfoStore==null){this.fileInfoStore=Ext.create('FileInfoStore');}
return this.fileInfoStore;},getContractDeptStore:function(){if(this.contractDeptStore==null){this.contractDeptStore=Ext.create('ContractDeptStore');}
return this.contractDeptStore;},getWorkflowStore:function(){if(this.workflowStore==null){this.workflowStore=Ext.create('WorkflowStore');}
return this.workflowStore;},saveContract:function(params,successFn,failFn){DpUtil.requestJsonAjax('saveContract.action',params,successFn,failFn);},updateContract:function(params,successFn,failFn){DpUtil.requestJsonAjax('updateContract.action',params,successFn,failFn);},getContractDateStore:function(){if(this.contractDateStore==null){this.contractDateStore=Ext.create('ContractDateStore',{data:ContractDate});}
return this.contractDateStore;},uploadFile:function(form,successFn,failFn){DpUtil.requestFileUploadAjax('../common/upload1.action',form,successFn,failFn);},changeFileInfo2ContractNoun:function(fileInfo,contractNoun){if(fileInfo!=null&&contractNoun!=null){contractNoun.contractId=fileInfo.sourceId;contractNoun.savePath=fileInfo.savePath;contractNoun.fileName=fileInfo.fileName;}
return contractNoun;},changeContractNoun2FileInfo:function(fileInfo,contractNoun){if(fileInfo!=null&&contractNoun!=null){fileInfo.sourceId=contractNoun.contractId;fileInfo.savePath=contractNoun.savePath;fileInfo.fileName=contractNoun.fileName;fileInfo.sourceType='CONTRACT';}
return fileInfo;},getCurrentUser:function(){Ext.Ajax.request({url:'../common/queryUserInfo.action',async:false,jsonData:{},success:function(response){var result=Ext.decode(response.responseText);if(result.success){CurrentUser=result.user;}else{Ext.Msg.alert('温馨提示',result.message)}},failure:function(response){var result=Ext.decode(response.responseText);Ext.Msg.alert('温馨提示',result.message)}});}});
var ContractConditionSearchStartTime=new Date();ContractConditionSearchStartTime.setDate(1);Ext.define('ContractConditionModel',{extend:'Ext.data.Model',fields:[{name:'deptId',type:'string'},{name:'custNumber',type:'string'},{name:'custCompany',type:'string'},{name:'contractNum',type:'string'},{name:'contactName',type:'string'},{name:'searchStartTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:(new Date().setDate(new Date().getDate()-30))},{name:'searchEndTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()}]});Ext.define('ContractManagerData',{extend:'ContractBasicData',contractStore:null,getContractStore:function(){return this.contractStore;},initContractStore:function(beforeLoadFn){if(this.contractStore==null){if(beforeLoadFn!=null){this.contractStore=Ext.create('ContractStore',{listeners:{beforeload:beforeLoadFn}});}else{this.contractStore=Ext.create('ContractStore');}}
return this.contractStore;},viewContractDetail:function(params,successFn,failFn){var viewContractDetailUrl='viewContractDetail.action';DpUtil.requestJsonAjax(viewContractDetailUrl,params,successFn,failFn);},viewUpdateContractDetail:function(params,successFn,failFn){DpUtil.requestJsonAjax('viewUpdateContractDetail.action',params,successFn,failFn);},invalidContract:function(params,successFn,failFn){var invalidContractUrl='invalidContract.action';DpUtil.requestJsonAjax(invalidContractUrl,params,successFn,failFn);},boundContract:function(params,successFn,failFn){var boundContractUrl='boundContract.action';DpUtil.requestJsonAjax(boundContractUrl,params,successFn,failFn);},relieveContract:function(params,successFn,failFn){var viewContractDetailUrl='relieveContract.action';DpUtil.requestJsonAjax(viewContractDetailUrl,params,successFn,failFn);},belongDeptChange:function(params,successFn,failFn){var belongDeptChangeUrl='belongDeptChange.action';DpUtil.requestJsonAjax(belongDeptChangeUrl,params,successFn,failFn);},expordContract:function(window,contractCondition){window.location.href='excelDownload.action?'+'deptId='+DpUtil.trimString(contractCondition.deptId)+'&custNumber='+DpUtil.trimString(contractCondition.custNumber)+'&custCompany='+DpUtil.trimString(contractCondition.custCompany)+'&contractNum='+DpUtil.trimString(contractCondition.contractNum)+'&contactName='+DpUtil.trimString(contractCondition.contactName)+'&searchStartTime='+contractCondition.searchStartTime.getTime()+'&searchEndTime='+contractCondition.searchEndTime.getTime();},contractIsAuditing:function(params,successFn,failFn){DpUtil.requestJsonAjax('contractIsAuditing.action',params,successFn,failFn);}});
BelongDeptView=function(){};Ext.define('CurrentUserDeptListModel',{extend:'Ext.data.Model',fields:['deptId','deptName']});var DurrentUserBelongDept=[];Ext.define('Ext.ux.data.PagingMemoryProxy',{extend:'Ext.data.proxy.Memory',alias:'proxy.pagingmemory',alternateClassName:'Ext.data.PagingMemoryProxy',read:function(operation,callback,scope){var reader=this.getReader(),result=reader.read(this.data),sorters,filters,sorterFn,records;scope=scope||this;filters=operation.filters;if(filters.length>0){records=[];Ext.each(result.records,function(record){var isMatch=true,length=filters.length,i;for(i=0;i<length;i++){var filter=filters[i],fn=filter.filterFn,scope=filter.scope;isMatch=isMatch&&fn.call(scope,record);}
if(isMatch){records.push(record);}},this);result.records=records;result.totalRecords=result.total=records.length;}
sorters=operation.sorters;if(sorters.length>0){sorterFn=function(r1,r2){var result=sorters[0].sort(r1,r2),length=sorters.length,i;for(i=1;i<length;i++){result=result||sorters[i].sort.call(this,r1,r2);}
return result;};result.records.sort(sorterFn);}
if(operation.start!==undefined&&operation.limit!==undefined){result.records=result.records.slice(operation.start,operation.start+operation.limit);result.count=result.records.length;}
Ext.apply(operation,{resultSet:result});operation.setCompleted();operation.setSuccessful();Ext.Function.defer(function(){Ext.callback(callback,scope,[operation]);},10);}});Ext.define('BelongDeptCombox',{extend:'QueryCombox',alias:'widget.belongdeptcombox',fieldLabel:i18n('i18n.ScatterUpgradeView.belongdeptName'),displayField:'deptName',valueField:'deptId',name:'dept',queryMode:'local',pageSize:10,labelWidth:65,typeAhead:true,minChars:1,currentUserDeptStore:null,listConfig:{minWidth:330},enableKeyEvents:true,initComponent:function(){var me=this;DurrentUserBelongDept=new BelongDeptView().getDeptListDate();me.store=me.getCurrentUserDeptListStore();this.callParent();},getCurrentUserDeptListStore:function(){var me=this;var currentUserDeptListDate=[];var deptList=[];try{deptList=currentUserDeptList;}catch(e){}
if(deptList.length>0){currentUserDeptListDate=deptList;}else if(DurrentUserBelongDept.length>0){currentUserDeptListDate=DurrentUserBelongDept;}
this.currentUserDeptStore=Ext.create('Ext.data.Store',{pageSize:me.pageSize,model:'CurrentUserDeptListModel',autoLoad:true,proxy:{type:'pagingmemory',data:currentUserDeptListDate}});return this.currentUserDeptStore;}});BelongDeptView.prototype.getDeptListDate=function(){var me=this;var currentUserDeptListDate=[];var successDeptListFn=function(response){currentUserDeptListDate=response.currentUserDeptList;};var failDeptListFn=function(response){MessageUtil.showMessage(response.message);}
me.getDeptList({},successDeptListFn,failDeptListFn);return currentUserDeptListDate;}
BelongDeptView.prototype.getDeptList=function(params,successFn,failFn){Ext.Ajax.request({url:'../authorization/acquireCurrentUserDeptList.action',async:false,jsonData:params,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});}
var searchMemberDataControl=new SearchMemberData();SearchMemberView=function(){};Ext.define('MemberSearchCombox',{extend:'QueryCombox',alias:'widget.membersearchcombox',fieldLabel:i18n('i18n.Integral.menberName'),name:null,searchWindow:null,store:null,displayField:'custName',valueField:'custId',queryMode:'local',queryDelay:2000,forceSelection:true,enableKeyEvents:true,initComponent:function(){var me=this;me.addListener('change',me.changeFn);me.addListener('expand',me.expandFn);me.addListener('keypress',me.keypressFn);this.callParent();},changeFn:function(memberSearchCombox){if(DpUtil.isEmpty(memberSearchCombox.getValue())){memberSearchCombox.setValue(null);}},expandFn:function(memberSearchCombox){this.showSearchMemberWinFn(memberSearchCombox);},keypressFn:function(memberSearchCombox,e){if(e.getKey()==Ext.EventObject.ENTER){this.showSearchMemberWinFn(memberSearchCombox);}},setValueComeBack:function(memberResult,resultRecords){},showSearchMemberWinFn:function(memberSearchCombox){if(memberSearchCombox.searchWindow==null){SearchMemberView.showSearchMemberWin(memberSearchCombox);}else{var custName=memberSearchCombox.getRawValue();if(DpUtil.isEmpty(custName)){custName=memberSearchCombox.getValue();}
memberSearchCombox.searchWindow.loadCustName(custName);memberSearchCombox.searchWindow.show();}
memberSearchCombox.store.removeAll();}});SearchMemberView.showSearchMemberWin=function(parentCombox){var params=['MEMBER_GRADE'];initDataDictionary(params);if(parentCombox.searchWindow==null&&DataDictionary.MEMBER_GRADE.length!=0){var searchMemberWin=Ext.create('SearchMemberWin',{'searchMemberData':searchMemberDataControl,'parent':parentCombox});parentCombox.searchWindow=searchMemberWin;searchMemberWin.show();}};Ext.define('SearchMemberWin',{extend:'PopWindow',width:790,height:350,title:i18n('i18n.SearchMemberView.custInfo'),parent:null,searchConditionForm:null,searchResultGrid:null,searchButtonPanel:null,selectButtonPanel:null,searchMemberData:null,layout:{type:'vbox',align:'stretch'},listeners:{beforeclose:function(memberSearchWin){memberSearchWin.hide();return false;}},items:null,initComponent:function(){var me=this;var record=new SearchMemberConditionModel();me.searchConditionForm=Ext.create('SearchConditionForm',{'parent':me.parent,'record':record,'parentWin':me});me.searchResultGrid=Ext.create('SearchResultGrid',{'searchMemberData':me.searchMemberData,'searchConditionForm':me.searchConditionForm});me.searchButtonPanel=Ext.create('SearchButtonPanel',{'searchConditionForm':me.searchConditionForm,'searchMemberData':me.searchMemberData});me.items=me.getItems();me.fbar=me.getFbar();me.parent.store=me.searchMemberData.getSearchMemberResultStore();this.callParent();record.set('custName',me.parent.getValue());me.searchConditionForm.loadRecord(record);},getFbar:function(){var me=this;return[{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_ensure'),scope:me,handler:me.setMemberValueBack},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),handler:function(){me.hide();}}];},getItems:function(){var me=this;return[{xtype:'basicpanel',height:80,items:[me.searchConditionForm]},me.searchButtonPanel,{xtype:'basicpanel',flex:1,items:[me.searchResultGrid]}];},setMemberValueBack:function(){var me=this;var selection=me.searchResultGrid.getSelectionModel().getSelection();if(selection.length!=1){MessageUtil.showMessage(i18n('i18n.SearchMemberView.pleaseSelectCustInfoOp'))}else{me.parent.setValueComeBack(selection[0],me.searchMemberData.getSearchMemberResultStore().getRange());me.parent.setValue(selection[0].get('custId'));me.hide();}},loadCustName:function(custName){var me=this;me.searchConditionForm.getForm().reset();me.searchConditionForm.getForm().updateRecord(me.searchConditionForm.record);if(!DpUtil.isEmpty(custName)){var searchRecord=me.searchConditionForm.record;searchRecord.set('custName',custName);me.searchConditionForm.loadRecord(searchRecord);}}});Ext.define('SearchButtonPanel',{extend:'NormalButtonPanel',id:'SearchMemberView_SearchButtonPanel_id',items:null,searchConditionForm:null,searchMemberData:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'middlebuttonpanel'},{xtype:'rightbuttonpanel',items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.search'),scope:me,handler:me.searchEvent},{xtype:'button',text:i18n('i18n.MemberCustEditView.reset'),scope:me,handler:me.resetEvent}]}];},searchEvent:function(){var me=this;me.searchMemberData.getSearchMemberResultStore().loadPage(1);},beforeSearch:function(me){if(Ext.isEmpty(me)){me=this;}
if(!me.validateCondition()){MessageUtil.showMessage(i18n('i18n.MemberUpgradeView.message_notAllNull'));return false;}
if(!me.searchConditionForm.getForm().isValid()){MessageUtil.showMessage(i18n('i18n.MyWorkFlowDealManagerView.m_changeAllRight'));return false;}
return true;},resetEvent:function(){var me=this;me.searchConditionForm.getForm().reset();},validateCondition:function(){var me=this;var flag=false;me.searchConditionForm.getForm().getFields().each(function(field){if(!(DpUtil.isEmpty(field.getValue()))){flag=true;}});return flag;}});Ext.define('SearchConditionForm',{extend:'SearchFormPanel',id:'searchConditionFormId',parentWin:null,layout:{type:'table',columns:4},defaultType:'textfield',initComponent:function(){var me=this;me.defaults=me.getDefaultsContainer();me.items=me.getItems();this.callParent();},getItems:function(){var me=this;return[{fieldLabel:i18n('i18n.MemberCustEditView.custNo'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'custNumber'},{fieldLabel:i18n('i18n.PotentialCustManagerView.customerName'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'custName'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactName'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'linkManName'},{fieldLabel:i18n('i18n.MemberCustEditView.contactNo'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'linkManNumber'},{fieldLabel:i18n('i18n.MemberCustEditView.mobileNo'),regex:DpUtil.linkWayLimit('M'),regexText:i18n('i18n.MemberCustEditView.pleaseInputCorrectMobilePhone'),name:'mobile'},{fieldLabel:i18n('i18n.SearchMemberView.phoneNumber'),regex:DpUtil.linkWayLimit('T'),regexText:i18n('i18n.MemberManagerView.pleaseEnterTheCorrectPhoneNumber'),name:'telePhone'},{fieldLabel:i18n('i18n.ScatterCustManagerView.idNumber'),maxLength:18,minLength:15,regex:DpUtil.linkWayLimit('I'),regexText:i18n('i18n.MemberCustEditView.cardNum15118LastxX'),name:'idCard'}];},getDefaultsContainer:function(){var me=this;return{labelAlign:'right',labelWidth:65,width:185,enableKeyEvents:true,listeners:{keypress:function(field,event){if(event.getKey()==Ext.EventObject.ENTER){if(!Ext.isEmpty(field.next())){field.next().focus();}else{me.parentWin.searchButtonPanel.searchEvent();}}}}};}});Ext.define('SearchResultGrid',{extend:'PopupGridPanel',searchConditionForm:null,searchMemberData:null,initComponent:function(){var me=this;me.store=me.searchMemberData.initSearchMemberResultStore(me.beforeLoadScatterFn);me.columns=me.getColumns();this.callParent();},getColumns:function(){var me=this;return[{header:i18n('i18n.MemberManagerView.customerGrouping'),dataIndex:'custGroup'},{header:i18n('i18n.ChangeContactAffiliatedRelationView.custId'),hidden:true,dataIndex:'custId'},{header:i18n('i18n.MemberCustEditView.custNo'),dataIndex:'custNum',hidden:true},{header:i18n('i18n.PotentialCustManagerView.customerName'),dataIndex:'custName',hidden:true},{header:i18n('i18n.ManualRewardIntegralEditView.id'),dataIndex:'contactId',hidden:true},{header:i18n('i18n.MemberCustEditView.isMainContact'),dataIndex:'isMainLinkMan',xtype:'booleancolumn',trueText:i18n('i18n.ChangeContactAffiliatedRelationView.yes'),falseText:i18n('i18n.ChangeContactAffiliatedRelationView.no')},{header:i18n('i18n.MemberCustEditView.contactNo'),dataIndex:'contactNum'},{header:i18n('i18n.ManualRewardIntegralEditView.name'),dataIndex:'contactName'},{header:i18n('i18n.SearchMemberView.mobileTelephone'),dataIndex:'mobileNum'},{header:i18n('i18n.MemberCustEditView.telephoneNo'),dataIndex:'telNum'},{header:i18n('i18n.PotentialCustEditView.address'),dataIndex:'address'},{header:i18n('i18n.ScatterCustManagerView.remark'),dataIndex:'remark'}];},features:[{ftype:'groupingsummary',groupHeaderTpl:'{name} ({rows.length})',hideGroupedHeader:true,enableGroupingMenu:false}],beforeLoadScatterFn:function(store,operation,eOpts){var searchConditionForm=Ext.getCmp('searchConditionFormId');var serchButton=Ext.getCmp('SearchMemberView_SearchButtonPanel_id');if(searchConditionForm!=null&&serchButton.beforeSearch(serchButton)){searchConditionForm.getForm().updateRecord(searchConditionForm.record);var searchCustCondition=searchConditionForm.record.data;var searchParams={'searchCustCondition.custNumber':DpUtil.trimString(searchCustCondition.custNumber),'searchCustCondition.custName':DpUtil.trimString(searchCustCondition.custName),'searchCustCondition.linkManNumber':DpUtil.trimString(searchCustCondition.linkManNumber),'searchCustCondition.linkManName':DpUtil.trimString(searchCustCondition.linkManName),'searchCustCondition.mobile':DpUtil.trimString(searchCustCondition.mobile),'searchCustCondition.telePhone':DpUtil.trimString(searchCustCondition.telePhone),'searchCustCondition.idCard':DpUtil.trimString(searchCustCondition.idCard)};Ext.apply(operation,{params:searchParams});}}});
var contractControl=Ext.create('ContractBasicData');Ext.define('ContractEditWin',{extend:'PopWindow',width:800,y:30,height:545,title:i18n('i18n.ContractEditView.contractEditer'),status:'NEW',contractView:null,layout:{type:'fit'},initComponent:function(){var me=this;me.items=[Ext.create('ContractEditView',{'parentWin':me,'contractData':contractControl,'contractView':me.contractView,'status':me.status})];this.callParent();}});Ext.form.field.VTypes.dateRange=function(val,field){var date=field.parseDate(val);if(!date){return false;}
if(field.startDateFieldName&&(!this.dateRangeMax||(date.getTime()!=this.dateRangeMax.getTime()))){var start=field.up('form').getForm().findField(field.startDateFieldName);start.setMaxValue(date);start.validate();this.dateRangeMax=date;}
else if(field.endDateFieldName&&(!this.dateRangeMin||(date.getTime()!=this.dateRangeMin.getTime()))){var end=field.up('form').getForm().findField(field.endDateFieldName);end.setMinValue(date);end.validate();this.dateRangeMin=date;if(end.getValue()<new Date()){end.setMinValue(new Date());}}
return true;};Ext.form.field.VTypes.dateRangeText=i18n('i18n.ContractEditView.contractStartDateSmallEndDate');Ext.define('ContractEditView',{extend:'BasicPanel',items:null,layout:{type:'vbox',align:'stretch'},custInfo:null,contractInfo:null,applyReasonInfo:null,fileInfo:null,parentWin:null,contractData:null,contractView:null,status:null,initComponent:function(){var me=this;me.custInfo=Ext.create('ContractForm',{'contractData':me.contractData,'custInfoRecord':me.getCustInfoRecord()});me.contractInfo=Ext.create('ContractTabPanel',{'status':me.status,'contractData':me.contractData,'contractInfoRecord':me.getContractInfoRecord(),'preferentialRecord':me.getPreferentialData(),'deptData':me.getDeptData(),'workFlowData':me.getWorkFlowData()});me.applyReasonInfo=Ext.create('ApplyReasonPanel',{'contractData':me.contractData,'application':me.getApplication()});me.fileInfo=Ext.create('ContractAttachment',{'status':me.status,'operateType':'DELAY','contractData':me.contractData,'attachData':me.getAttachData()});me.items=me.getItems();me.fbar=me.getFbar();this.callParent();me.loadContractViewDataAfterRender(me.contractView);var contractInfoForm=me.contractInfo.contractTabBasicInfo.contractBasicInfo.getForm();if('UPDATE'==me.status){me.unLockAllComponents();me.custInfo.getForm().findField('custName').setReadOnly(true);contractInfoForm.findField('linkManName').setReadOnly(true);var linkMan=contractInfoForm.findField('linkManName');if(!Ext.isEmpty(me.contractView.contract.contactId)){linkMan.store.add(0,Ext.create('SearchMemberResultModel',{'contactId':me.contractView.contract.contactId,'contactName':me.contractView.contract.linkManName}));linkMan.setValue(me.contractView.contract.contactId);}}else if('VIEW'==me.status){me.lockAllComponents();var custName=me.custInfo.getForm().findField('custName');custName.setValue(me.contractView.contract.custId);custName.setRawValue(me.contractView.custName);var linkMan=contractInfoForm.findField('linkManName');linkMan.setValue(me.contractView.contract.contactId);linkMan.setRawValue(me.contractView.contract.linkManName);}
if('NEW'==me.status){contractInfoForm.reset();contractInfoForm.findField('beforeContractNum').setReadOnly(true);var deptName=contractInfoForm.findField('deptName');deptName.setValue(CurrentUser.deptName);var dept=contractInfoForm.findField('deptId');dept.setValue(CurrentUser.deptId);}},getItems:function(){var me=this;return[{xtype:'basicpanel',height:120,items:[me.custInfo]},{xtype:'basicpanel',height:255,items:[me.contractInfo]},{xtype:'basicpanel',flex:1,layout:{type:'hbox',align:'stretch'},items:[{xtype:'basicpanel',flex:1,items:[me.applyReasonInfo]},{xtype:'basicpanel',width:5},{xtype:'basicpanel',flex:1,items:[me.fileInfo]}]}];},getFbar:function(){var me=this;return[{xtype:'button',id:'contractSaveButton',text:i18n('i18n.MemberCustEditView.submit'),scope:me,handler:me.saveContract},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),handler:function(){if(me.parentWin!=null){me.parentWin.close();}}}];},validateContractInfo:function(){var me=this;var form=me.contractInfo.down('form').getForm();var payWay=form.findField('payWay').getValue();if('NOT_MONTH_END'==payWay&&!me.contractInfo.down('form').getForm().findField('iddisCount').getValue()){MessageUtil.showMessage(i18n('i18n.ContractEditView.m_payWay_preference'));return false;}
var reconDate=Ext.isEmpty(form.findField('reconDate').getRawValue())||form.findField('reconDate').getRawValue()==' ';var invoicDate=Ext.isEmpty(form.findField('invoicDate').getRawValue())||form.findField('invoicDate').getRawValue()==' ';var resultDate=Ext.isEmpty(form.findField('resultDate').getRawValue())||form.findField('resultDate').getRawValue()==' ';var payWay=me.contractInfo.down('form').getForm().findField('payWay').getValue();if(('MONTH_END'==payWay||'HALF_MONTH_END'==payWay)&&(reconDate||invoicDate||resultDate)){MessageUtil.showMessage('结款方式选择月结或非月结时对账，开发票，结款日期不能为空！');return false;}
if(!me.custInfo.getForm().isValid()||!me.contractInfo.down('form').getForm().isValid()||!me.applyReasonInfo.getForm().isValid()){MessageUtil.showMessage(i18n('i18n.ContractEditView.m_checkAllRight'));return false;}
var preferenceTypeField=me.contractInfo.down('form').getForm().findField('preferentialType');if(preferenceTypeField.getValue()=='PRICE_REBATE'){if(me.contractData.getPreferentialStore().getCount()==0){MessageUtil.showMessage(i18n('i18n.ContractEditView.m_mustDetail'));return false;}else{var chargeRebate=me.contractData.getPreferentialStore().getAt(0).get('chargeRebate');if(chargeRebate<0.85||chargeRebate>1){MessageUtil.showMessage(i18n('i18n.ContractEditView.m_mustScope'));return false;}}}
if(Ext.getCmp('contractStartTime_id').getValue().getTime()==Ext.getCmp('contractEndTime_id').getValue().getTime()){MessageUtil.showMessage(i18n('i18n.ContractEditView.contractStartDateSmallEndDate'));return;}
if(me.contractData.getFileInfoStore().getCount()<=0){MessageUtil.showMessage(i18n('i18n.ContractEditView.pleaseInputAttachment'));return false;}
return true;},saveContract:function(button){var me=this;var saveParams={};if('NEW'==me.status){if(!me.validateContractInfo()){return;}
button.setDisabled(true);saveParams=me.assembleNewContractData();var saveSuccess=function(result){if(Ext.isEmpty(result.workFlowNum)){MessageUtil.showInfoMes(i18n('i18n.PotentialCustEditView.saveSuccess'));}else{MessageUtil.showInfoMes(i18n('i18n.ContractEditView.contractSaveSuccessWorkFlow')+result.workFlowNum);}
button.setDisabled(false);me.parentWin.close();}
var saveFail=function(result){MessageUtil.showErrorMes(result.message);button.setDisabled(false);}
me.contractData.saveContract(saveParams,saveSuccess,saveFail);}else if('UPDATE'==me.status){saveParams=me.assembleNewContractData();if(Ext.isEmpty(saveParams.fileInfoList)){MessageUtil.showMessage(i18n('i18n.ChangeContactAffiliatedRelationView.m_uploadFile'));return;}
if(!me.validateContractInfo()){MessageUtil.showMessage(i18n('i18n.ContractEditView.m_checkAllFull'))
return;}
var saveSuccess=function(result){if(result.workFlowNum==null){MessageUtil.showInfoMes(i18n('i18n.ContractEditView.updateSuccessWar'));}else{MessageUtil.showInfoMes(i18n('i18n.ContractEditView.contractUpdateSuccessWorkFlow')+result.workFlowNum);}
button.setDisabled(false);me.parentWin.close();}
var saveFail=function(result){MessageUtil.showErrorMes(result.message);button.setDisabled(false);}
me.contractData.updateContract(saveParams,saveSuccess,saveFail);}},lockAllComponents:function(){var me=this;var memberBasicBasicForm=me.custInfo.getForm();memberBasicBasicForm.findField('custName').setReadOnly(true);var contractInfo=me.contractInfo.contractTabBasicInfo.contractBasicInfo.getForm();contractInfo.getFields().each(function(field){field.setReadOnly(true);});me.applyReasonInfo.getForm().findField('application').setReadOnly(true);Ext.getCmp('contractSaveButton').setDisabled(true);Ext.getCmp('fileUpLoadButton').setDisabled(true);},unLockAllComponents:function(){var me=this;var memberBasicBasicForm=me.custInfo.getForm();memberBasicBasicForm.findField('custName').setReadOnly(true);var contractInfo=me.contractInfo.contractTabBasicInfo.contractBasicInfo.getForm();contractInfo.getFields().each(function(field){field.setReadOnly(false);});contractInfo.findField('deptName').setReadOnly(true);contractInfo.findField('contractStatus').setReadOnly(true);contractInfo.findField('linkManMobile').setReadOnly(true);contractInfo.findField('linkManPhone').setReadOnly(true);if(contractInfo.findField('payWay').getValue()=='NOT_MONTH_END'){contractInfo.findField('arrearaMount').setValue();contractInfo.findField('reconDate').setValue(0);contractInfo.findField('invoicDate').setValue(0);contractInfo.findField('resultDate').setValue(0);contractInfo.findField('arrearaMount').setReadOnly(true);contractInfo.findField('reconDate').setReadOnly(true);contractInfo.findField('invoicDate').setReadOnly(true);contractInfo.findField('resultDate').setReadOnly(true);contractInfo.findField('arrearaMount').allowBlank=true;contractInfo.findField('reconDate').allowBlank=true;contractInfo.findField('invoicDate').allowBlank=true;contractInfo.findField('resultDate').allowBlank=true;me.doLayout();}else{contractInfo.findField('arrearaMount').setReadOnly(false);contractInfo.findField('reconDate').setReadOnly(false);contractInfo.findField('invoicDate').setReadOnly(false);contractInfo.findField('resultDate').setReadOnly(false);contractInfo.findField('arrearaMount').allowBlank=false;contractInfo.findField('reconDate').allowBlank=false;contractInfo.findField('invoicDate').allowBlank=false;contractInfo.findField('resultDate').allowBlank=false;me.doLayout();}
me.applyReasonInfo.getForm().findField('application').setReadOnly(false);Ext.getCmp('contractSaveButton').setDisabled(false);Ext.getCmp('fileUpLoadButton').setDisabled(false);},loadContractViewDataAfterRender:function(contractView){var me=this;var custInfoRecord=me.getCustInfoRecord();var contractInfoRecord=me.getContractInfoRecord();var preferentialRecord=me.getPreferentialData();var applyReasonInfoRecord=me.getApplication();var fileInfoData=me.getAttachData();var deptData=me.getDeptData();var workFlowData=me.getWorkFlowData();me.custInfo.loadCustInfoData(custInfoRecord);me.contractInfo.contractTabBasicInfo.contractBasicInfo.loadContractInfoRecord(contractInfoRecord);me.contractInfo.contractTabBasicInfo.preferentialInfo.loadPreferentialData(preferentialRecord);me.applyReasonInfo.loadApplication(applyReasonInfoRecord);me.fileInfo.loadAttachData(fileInfoData);me.contractInfo.contractTabOtherInfo.deptInfo.loadDeptData(deptData);me.contractInfo.contractTabOtherInfo.workFlowInfo.loadWorkFlowData(workFlowData);},getCustInfoRecord:function(){var me=this;var custInfoRecord=null;if(me.contractView!=null){custInfoRecord=Ext.create('ContractViewModel',me.contractView);}else{custInfoRecord=Ext.create('ContractViewModel');}
return custInfoRecord;},getPreferentialData:function(){var me=this;var preferentialData=[];if(me.contractView!=null){if(me.contractView.contract.preferential!=null){var preferentialRecord=Ext.create('PreferentialModel',me.contractView.contract.preferential).data;preferentialData.push(preferentialRecord)}}
return preferentialData;},getContractInfoRecord:function(){var me=this;var contractInfoRecord=null;if(me.contractView!=null){contractInfoRecord=Ext.create('ContractModel',me.contractView.contract);}else{contractInfoRecord=Ext.create('ContractModel');}
return contractInfoRecord;},getApplication:function(){var me=this;var application='';if(me.contractView!=null){application=me.contractView.contract.application;}
return application;},getAttachData:function(){var me=this;var attachData=[];if(me.contractView!=null&&'VIEW'==me.status){attachData=me.contractView.contract.fileInfoList;}
return attachData;},getDeptData:function(){var me=this;var deptData=[];var returnDeptData=[];if(me.contractView!=null){deptData=me.contractView.contract.contractDepartList;for(var i=0;i<deptData.length;i++){if(!deptData[i].dept){returnDeptData.push(deptData[i]);}}}
return returnDeptData;},getWorkFlowData:function(){var me=this;var workFlowData=[];var returnWorkFlowData=[];if(me.contractView!=null){workFlowData=me.contractView.contract.contractWorkflowList;for(var i=0;i<workFlowData.length;i++){if(!Ext.isEmpty(workFlowData[i].workflowId)){returnWorkFlowData.push(workFlowData[i]);}}}
return returnWorkFlowData;},assembleNewContractData:function(){var me=this;var saveParams={};var custId=me.custInfo.getForm().findField('custId').getValue();var custAddress=me.custInfo.getForm().findField('address').getValue();var contractInfoForm=me.contractInfo.down('form');var contract=contractInfoForm.contractInfoRecord;contractInfoForm.getForm().updateRecord(contract);var linkManName=contractInfoForm.getForm().findField('linkManName').getRawValue();var preferentialInfo=null;var store=me.contractInfo.contractTabBasicInfo.preferentialInfo.store;if(store.getCount()>0){preferentialInfo=store.getAt(0).data;}
var application=me.applyReasonInfo.getForm().findField('application').getValue();var alterAddAttachList=new Array();me.fileInfo.collectAlterAttachData(alterAddAttachList);if(alterAddAttachList.length>0){var fileInfoList=[];fileInfoList.push(alterAddAttachList[0])
saveParams.fileInfoList=fileInfoList;;}else{saveParams.fileInfoList=[];}
if(!Ext.isEmpty(custId)){contract.set('custId',custId);}
contract.set('linkManAddress',custAddress);contract.set('preferential',preferentialInfo);contract.set('application',application);contract.set('linkManName',linkManName);saveParams.contract=contract.data;return saveParams;},assembleAlterContractData:function(){var me=this;var params={};var approveDataList=new Array();var alterContractList=new Array();var alterPreferential=new Array();var alterDeletePreferentialList=new Array();var alterAddPreferentialList=new Array();var alterDeleteList=new Array();var alterAddAttachList=new Array();me.contractInfo.contractTabBasicInfo.contractBasicInfo.collectAlterContractData(alterContractList);me.contractInfo.contractTabBasicInfo.preferentialInfo.collectAlterPreferentialData(alterPreferential,alterDeletePreferentialList,alterAddPreferentialList);me.fileInfo.collectAlterAttachData(alterAddAttachList);if(me.contractView.custId!=me.custInfo.getForm().findField('custId').getValue()){var custIdApproveData=Ext.create('ApproveDataModel');custIdApproveData.set('className','Contract');custIdApproveData.set('classId',me.contractView.contract.id);custIdApproveData.set('fieldName','custId');custIdApproveData.set('newValue',me.custInfo.getForm().findField('custId').getValue());alterContractList.push(custIdApproveData.data);}
if(me.contractView.contract.application!=me.applyReasonInfo.getForm().findField('application').getValue()){var applicationApproveData=Ext.create('ApproveDataModel');applicationApproveData.set('className','Contract');applicationApproveData.set('classId',me.contractView.contract.id);applicationApproveData.set('fieldName','application');applicationApproveData.set('newValue',me.applyReasonInfo.getForm().findField('application').getValue());alterContractList.push(applicationApproveData.data);}
params.contractId=me.contractInfo.contractInfoRecord.get('id');approveDataList.push(alterPreferential);params.approveDataList=alterContractList;if(alterAddPreferentialList.length>0){params.addPreferential=alterAddPreferentialList[0];}else{params.addPreferential=null;}
new Date().getTime();if(alterAddAttachList.length>0){params.fileInfo=alterAddAttachList[0];}else{params.fileInfo=null;}
return params;}});Ext.define('ContractForm',{extend:'PopTitleFormPanel',items:null,record:null,contractData:null,custInfoRecord:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'fieldset',layout:{type:'table',columns:4},defaultType:'textfield',defaults:{labelWidth:70,width:180,readOnly:true},title:i18n('i18n.ContractEditView.t_custInfo'),items:[{xtype:'membersearchcombox',fieldLabel:'<span style="color:red;">*</span>客户名称',name:'custName',readOnly:false,allowBlank:false,forceSelection:false,blankText:i18n('i18n.ContractEditView.m_selectCustName'),setValueComeBack:function(memberRecord,resultRecords){var custId=memberRecord.get('custId');var protoContactStore=me.contractData.getProtoContactStore();protoContactStore.removeAll();var mainLinkmanRecord=null;for(var i=0;i<resultRecords.length;i++){if(resultRecords[i].get('custId')==custId){if(resultRecords[i].get('isMainLinkMan')==true){mainLinkmanRecord=resultRecords[i];}
protoContactStore.insert(0,resultRecords[i]);}}
if(mainLinkmanRecord!=null){me.getForm().loadRecord(mainLinkmanRecord);}else{memberRecord.set('mobileNum',null);memberRecord.set('telNum',null);memberRecord.set('idCard',null);memberRecord.set('contactName',null);memberRecord.set('address',null);me.getForm().loadRecord(memberRecord);}}},{fieldLabel:i18n('i18n.MemberCustEditView.custNo'),name:'custNum'},{fieldLabel:i18n('i18n.PotentialCustManagerView.industry'),name:'trade',xtype:'dpcombo',forceSelection:true,store:me.contractData.getTradeStore(),displayField:'codeDesc',valueField:'code',queryMode:'local'},{fieldLabel:i18n('i18n.MemberCustEditView.custLevel'),name:'custGrade',xtype:'dpcombo',forceSelection:true,store:me.contractData.getMemberGradeStore(),displayField:'codeDesc',valueField:'code',queryMode:'local'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactName'),name:'contactName'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactPhone'),name:'mobileNum'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactTel'),name:'telNum'},{fieldLabel:i18n('i18n.MemberCustEditView.custType'),name:'custType',xtype:'dpcombo',forceSelection:true,store:me.contractData.getCustomerTypeStore(),displayField:'codeDesc',valueField:'code',queryMode:'local'},{fieldLabel:i18n('i18n.ScatterCustManagerView.taxId'),name:'taxregNum'},{fieldLabel:i18n('i18n.ScatterCustManagerView.idNumber'),name:'idCard'},{xtype:'fieldcontainer',layout:{type:'hbox'},colspan:2,width:360,defaultType:'textfield',defaults:{labelWidth:70,readOnly:true},items:[{fieldLabel:i18n('i18n.PotentialCustEditView.city'),name:'cityName',width:130},{fieldLabel:i18n('i18n.PotentialCustEditView.address'),name:'address',flex:1},{fieldLabel:i18n('i18n.ScatterUpgradeView.custId'),name:'custId',hidden:true},{fieldLabel:i18n('i18n.ContractEditView.cityId'),name:'cityId',hidden:true}]}]}];},loadCustInfoData:function(custInfoRecord){var me=this;me.getForm().loadRecord(custInfoRecord);}});Ext.define('ContractTabPanel',{extend:'NormalTabPanel',items:null,activeTab:0,contractInfoRecord:null,preferentialRecord:null,deptData:null,workFlowData:null,contractData:null,status:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;me.contractTabBasicInfo=Ext.create('ContractTabContent',{'status':me.status,'contractData':me.contractData,'contractInfoRecord':me.contractInfoRecord,'preferentialRecord':me.preferentialRecord});me.contractTabOtherInfo=Ext.create('OtherTabContent',{'contractData':me.contractData,'deptData':me.deptData,'workFlowData':me.workFlowData});return[me.contractTabBasicInfo,me.contractTabOtherInfo];}});Ext.define('ContractTabContent',{extend:'TabContentPanel',title:i18n('i18n.ContractEditView.contractInfo'),contractInfoRecord:null,preferentialRecord:null,contractBaiscInfo:null,preferentialInfo:null,contractTabContentData:null,contractData:null,status:null,layout:{type:'vbox',align:'stretch'},initComponent:function(){var me=this;this.contractBasicInfo=Ext.create('ContractBasicForm',{'contractData':me.contractData,'contractInfoRecord':me.contractInfoRecord});this.preferentialInfo=Ext.create('PreferentialGrid',{'status':me.status,'contractData':me.contractData,'preferentialRecord':me.preferentialRecord});this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[me.contractBasicInfo,{xtype:'basicpanel',flex:1,items:[me.preferentialInfo]}];}});var cellEditor=Ext.create('Ext.grid.plugin.CellEditing',{clicksToEdit:1});Ext.define('PreferentialGrid',{extend:'PopupGridPanel',contractData:null,preferentialRecord:null,status:null,columns:null,store:null,plugins:[cellEditor],initComponent:function(){var me=this;me.columns=me.getColumns();me.store=me.contractData.getPreferentialStore();this.callParent();},getColumns:function(){var me=this;return[{text:'id',dataIndex:'id',hidden:true},{text:i18n('i18n.ContractEditView.contractId'),dataIndex:'contractId',hidden:true},{text:i18n('i18n.ContractEditView.postageDiscounts'),dataIndex:'chargeRebate',flex:1,xtype:'numbercolumn',editor:{xtype:'dpnumberfield',disabled:('VIEW'==me.status)?true:false,minValue:0.85,maxValue:1,hideTrigger:true}},{text:i18n('i18n.ContractEditView.collectionOfRatesDiscount'),dataIndex:'agentgathRate',xtype:'numbercolumn',flex:1,editor:{xtype:'dpnumberfield',disabled:('VIEW'==me.status)?true:false,minValue:0,maxValue:1,hideTrigger:true}},{text:i18n('i18n.ContractEditView.insuredRateDiscount'),dataIndex:'insuredPriceRate',xtype:'numbercolumn',flex:1,editor:{xtype:'dpnumberfield',disabled:('VIEW'==me.status)?true:false,minValue:0,maxValue:1,hideTrigger:true}},{text:i18n('i18n.ContractEditView.toAcceptTheGoodsFeeDiscounts'),dataIndex:'receivePriceRate',xtype:'numbercolumn',flex:1,editor:{xtype:'dpnumberfield',disabled:('VIEW'==me.status)?true:false,minValue:0,maxValue:1,hideTrigger:true}},{text:i18n('i18n.ContractEditView.deliveryFeeDiscount'),dataIndex:'deliveryPriceRate',xtype:'numbercolumn',flex:1,editor:{xtype:'dpnumberfield',disabled:('VIEW'==me.status)?true:false,minValue:0,maxValue:1,hideTrigger:true}}];},loadPreferentialData:function(preferentialData){var me=this;me.store.loadData(preferentialData);},collectAlterPreferentialData:function(alterPreferentialList,alterDeletePreferentialList,alterAddPreferentialList){var me=this;var preferentialRecord=me.contractData.getPreferentialStore().getUpdatedRecords();if(preferentialRecord.length>0){var fieldsArray=preferentialRecord.fields.items;for(var i=0;i<fieldsArray.length;i++){var fieldName=fieldsArray[i].name;if(preferentialRecord.isModified(fieldName)){var basicApproveData=me.getEmptyPreferentialApproveData();basicApproveData.set('fieldName',fieldName);basicApproveData.set('newValue',preferentialRecord.get(fieldName));alterPreferentialList.push(basicApproveData.data);}}}
var deletePreferentialRecords=me.store.getRemovedRecords();for(var i=0;i<deletePreferentialRecords.length;i++){alterDeletePreferentialList.push(me.getEmptyPreferentialApproveData(deletePreferentialRecords[i]));}
var addPreferentialRecords=me.store.getNewRecords();for(var i=0;i<addPreferentialRecords.length;i++){alterAddPreferentialList.push(addPreferentialRecords[i].data);}},getEmptyPreferentialApproveData:function(){var me=this;var basicApproveData=Ext.create('ApproveDataModel');basicApproveData.set('className','Preferential');basicApproveData.set('classId',me.preferentialRecord.get('id'));return basicApproveData;}});Ext.define('ContractBasicForm',{extend:'BasicFormPanel',contractInfoRecord:null,contractData:null,layout:{type:'table',columns:4},defaultType:'textfield',defaults:{labelWidth:70,width:180,maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20)},height:160,initComponent:function(){var me=this;me.items=me.getItems();this.callParent();var reconDate=me.getForm().findField('reconDate');me.selectFirst(reconDate);var invoicDate=me.getForm().findField('invoicDate');me.selectFirst(invoicDate);var resultDate=me.getForm().findField('resultDate');me.selectFirst(resultDate);},getItems:function(){var me=this;return[{fieldLabel:i18n('i18n.Integral.dept'),name:'deptName',maxLength:Number.MAX_VALUE,readOnly:true},{fieldLabel:i18n('i18n.ContractEditView.contractStatus'),name:'contractStatus',xtype:'dpcombo',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.contractData.getContractStateStore(),readOnly:true},{fieldLabel:i18n('i18n.ContractEditView.oldContractNum'),name:'beforeContractNum',readOnly:true},{fieldLabel:i18n('i18n.ContractEditView.c_contractNum'),allowBlank:false,name:'contractNum'},{fieldLabel:i18n('i18n.ContractEditView.c_mainTitle'),name:'contractSubject',allowBlank:false,emptyText:i18n('i18n.ContractEditView.launchSectorBranch')},{fieldLabel:i18n('i18n.ContractEditView.c_cust_fullName'),name:'custCompany',allowBlank:false,blankText:i18n('i18n.ContractEditView.pleaseEnterYourFullName')},{fieldLabel:i18n('i18n.ContractEditView.c_isFavorable'),name:'iddisCount',xtype:'dpcombo',queryMode:'local',forceSelection:true,displayField:'name',valueField:'value',store:me.contractData.getBooleanStore(),allowBlank:false,blankText:i18n('i18n.ContractEditView.pleaseIsureIsPreferential'),listeners:{scope:me,select:me.selectIsdisCountFn}},{fieldLabel:i18n('i18n.ContractEditView.c_typeFavorable'),name:'preferentialType',xtype:'dpcombo',forceSelection:true,store:me.contractData.getPrivilegeTypeStore(),displayField:'codeDesc',valueField:'code',queryMode:'local',readOnly:true,listeners:{scope:me,select:me.selectPreferentialFn}},{fieldLabel:i18n('i18n.ContractEditView.c_goodName'),allowBlank:false,name:'goodsName'},{fieldLabel:i18n('i18n.ContractEditView.c_registerAmonut'),name:'regicapital',regex:/^\d{1,10}$/,regexText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',10),allowBlank:false,hideTrigger:true},{fieldLabel:i18n('i18n.ContractEditView.c_payWay'),name:'payWay',xtype:'dpcombo',forceSelection:true,store:me.contractData.getReckonWayStore(),displayField:'codeDesc',valueField:'code',queryMode:'local',allowBlank:false,blankText:i18n('i18n.ContractEditView.pleaseSelectResultsSectionBy'),listeners:{scope:me,select:me.selectPayWayFn}},{fieldLabel:i18n('i18n.ContractEditView.c_applyAmonut'),name:'arrearaMount',regex:/^\d{1,10}$/,regexText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',10),hideTrigger:true,readOnly:true},{fieldLabel:i18n('i18n.ContractEditView.c_startDate'),id:'contractStartTime_id',name:'contractBeginDate',xtype:'dpdatefield',endDateFieldName:'contractendDate',vtype:'dateRange',allowBlank:false,blankText:i18n('i18n.ContractEditView.pleaseInputContractStartDate'),format:'Y-m-d'},{fieldLabel:i18n('i18n.ContractEditView.c_agreement_contract'),name:'linkManName',xtype:'dpcombo',forceSelection:true,store:me.contractData.getProtoContactStore(),displayField:'contactName',valueField:'contactId',queryMode:'local',listeners:{scope:me,select:function(combox,selectedRecords){if(selectedRecords.length>0){var record=selectedRecords[0];var basicForm=me.getForm();basicForm.findField('linkManMobile').setValue(record.get('mobileNum'));basicForm.findField('linkManPhone').setValue(record.get('telNum'));basicForm.findField('contactId').setValue(record.get('contactId'));}},expand:function(combox){if(combox.store.getCount()==0){MessageUtil.showMessage(i18n('i18n.ContractEditView.pleaseSelectCustNameFrist'));}},change:function(field,newValue){var me=this;if(Ext.isEmpty(newValue)){field.setValue(null);}}},allowBlank:false,blankText:i18n('i18n.ContractEditView.pleaseSelectTheProtocolContacts')},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactPhone'),name:'linkManMobile',readOnly:true},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactTel'),name:'linkManPhone',readOnly:true},{fieldLabel:i18n('i18n.ContractEditView.c_endDate'),id:'contractEndTime_id',name:'contractendDate',xtype:'dpdatefield',startDateFieldName:'contractBeginDate',vtype:'dateRange',minValue:new Date(),allowBlank:false,blankText:i18n('i18n.ContractEditView.pleaseInputContractEndDate'),format:'Y-m-d'},{fieldLabel:i18n('i18n.ContractEditView.c_accountDate'),name:'reconDate',xtype:'dpcombo',queryMode:'local',forceSelection:true,displayField:'dateDesc',valueField:'dateValue',store:me.contractData.getContractDateStore()},{fieldLabel:i18n('i18n.ContractEditView.c_billDate'),name:'invoicDate',xtype:'dpcombo',queryMode:'local',forceSelection:true,displayField:'dateDesc',valueField:'dateValue',store:me.contractData.getContractDateStore()},{fieldLabel:i18n('i18n.ContractEditView.c_payDate'),name:'resultDate',xtype:'dpcombo',queryMode:'local',forceSelection:true,displayField:'dateDesc',valueField:'dateValue',store:me.contractData.getContractDateStore()},{xtype:'hiddenfield',fieldLabel:i18n('i18n.ManualRewardIntegralEditView.id'),maxLength:Number.MAX_VALUE,name:'contactId'},{xtype:'hiddenfield',fieldLabel:i18n('i18n.ContractEditView.deptid'),maxLength:Number.MAX_VALUE,name:'deptId'}];},selectPayWayFn:function(combox,selectedRecords){var me=this;var basicForm=me.getForm();me.dealPayWayValue(combox,basicForm);},selectIsdisCountFn:function(combox,selectedRecords){var me=this;var basicForm=me.getForm();if(combox.getValue()==1){basicForm.findField('preferentialType').setReadOnly(false);basicForm.findField('preferentialType').allowBlank=false;me.doLayout();}else{var preferentialType=basicForm.findField('preferentialType');basicForm.findField('preferentialType').setReadOnly(true);basicForm.findField('preferentialType').setValue();me.contractData.getPreferentialStore().removeAll();basicForm.findField('preferentialType').allowBlank=true;me.doLayout();}},selectPreferentialFn:function(combox,selectedRecords){var me=this;if(combox.getValue()=='PRICE_REBATE'){var emptyPreferentModel=Ext.create('PreferentialModel');me.contractData.getPreferentialStore().insert(0,emptyPreferentModel);cellEditor.startEditByPosition({row:0,column:0});}else{me.contractData.getPreferentialStore().removeAll();}},loadContractInfoRecord:function(contractInfoRecord){var me=this;me.getForm().loadRecord(contractInfoRecord);var basicForm=me.getForm();me.dealPayWayValue(basicForm.findField('payWay'),basicForm);},dealPayWayValue:function(obj,basicForm){var me=this;if(obj.getValue()=='NOT_MONTH_END'){basicForm.findField('arrearaMount').setValue();basicForm.findField('reconDate').setValue(0);basicForm.findField('invoicDate').setValue(0);basicForm.findField('resultDate').setValue(0);basicForm.findField('arrearaMount').setReadOnly(true);basicForm.findField('reconDate').setReadOnly(true);basicForm.findField('invoicDate').setReadOnly(true);basicForm.findField('resultDate').setReadOnly(true);basicForm.findField('arrearaMount').allowBlank=true;basicForm.findField('reconDate').allowBlank=true;basicForm.findField('invoicDate').allowBlank=true;basicForm.findField('resultDate').allowBlank=true;me.doLayout();}else{basicForm.findField('arrearaMount').setReadOnly(false);basicForm.findField('reconDate').setReadOnly(false);basicForm.findField('invoicDate').setReadOnly(false);basicForm.findField('resultDate').setReadOnly(false);basicForm.findField('arrearaMount').allowBlank=false;basicForm.findField('reconDate').allowBlank=false;basicForm.findField('invoicDate').allowBlank=false;basicForm.findField('resultDate').allowBlank=false;me.doLayout();}},selectFirst:function(param){var me=this;param.store.on('load',function(obj){if(param.store.getCount()>0){param.setValue(param.store.getAt(0));}});},collectContractBasicData:function(){var me=this;me.getForm().updateRecord(me.contractInfoRecord);return me.memberBasicRecord.data;},collectAlterContractData:function(alterContractList){var me=this;var contractBeginDate=me.contractInfoRecord.get('contractBeginDate').toLocaleDateString();var contractendDate=me.contractInfoRecord.get('contractendDate').toLocaleDateString();me.getForm().updateRecord(me.contractInfoRecord);var fieldsArray=me.contractInfoRecord.fields.items;for(var i=0;i<fieldsArray.length;i++){var fieldName=fieldsArray[i].name;if(me.contractInfoRecord.isModified(fieldName)){if('contractBeginDate'==fieldName){if(contractBeginDate!=me.contractInfoRecord.get(fieldName).toLocaleDateString()){me.getContractApproveCellData(alterContractList,fieldName,me.contractInfoRecord);}}else if('contractendDate'==fieldName){if(contractendDate!=me.contractInfoRecord.get(fieldName).toLocaleDateString()){me.getContractApproveCellData(alterContractList,fieldName,me.contractInfoRecord);}}else{me.getContractApproveCellData(alterContractList,fieldName,me.contractInfoRecord);}}}},getEmptyContractApproveData:function(){var me=this;var basicApproveData=Ext.create('ApproveDataModel');basicApproveData.set('className','Contract');basicApproveData.set('classId',me.contractInfoRecord.get('id'));return basicApproveData;},getContractApproveCellData:function(alterContractList,fieldName,contractInfoRecord){var me=this;var basicApproveData=me.getEmptyContractApproveData();basicApproveData.set('fieldName',fieldName);basicApproveData.set('newValue',contractInfoRecord.get(fieldName));alterContractList.push(basicApproveData.data);}});Ext.define('OtherTabContent',{extend:'TabContentPanel',deptData:null,workFlowData:null,contractData:null,title:i18n('i18n.ContractEditView.otherInfo'),deptInfo:null,workFlowInfo:null,layout:{type:'vbox',align:'stretch'},initComponent:function(){var me=this;me.deptInfo=Ext.create('DeptGrid',{'contractData':me.contractData});me.workFlowInfo=Ext.create('WorkFlowGrid',{'contractData':me.contractData});me.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'basicpanel',flex:1,layout:{type:'vbox',align:'stretch'},items:[{xtype:'titlepanel',items:[{xtype:'displayfield',value:i18n('i18n.ContractEditView.hasBindingDept'),width:100}]},{xtype:'basicpanel',flex:1,items:[me.deptInfo]}]},{xtype:'basicpanel',flex:1,layout:{type:'vbox',align:'stretch'},items:[{xtype:'titlepanel',items:[{xtype:'displayfield',value:i18n('i18n.ContractEditView.workFlowInfo'),width:100}]},{xtype:'basicpanel',flex:1,items:[me.workFlowInfo]}]}];}});Ext.define('DeptGrid',{extend:'PopupGridPanel',contractData:null,deptData:null,initComponent:function(){var me=this;me.columns=me.getColumns();me.store=me.contractData.getContractDeptStore();this.callParent();},getColumns:function(){var me=this;return[{text:i18n('i18n.ManualRewardIntegralManagerView.deptName'),dataIndex:'deptName',flex:1},{text:i18n('i18n.ContractEditView.BindingTime'),dataIndex:'boundTime',flex:1,renderer:function(value){return DpUtil.renderDate(value);}}];},loadDeptData:function(deptData){var me=this;me.store.loadData(deptData);}});Ext.define('WorkFlowGrid',{extend:'PopupGridPanel',contractData:null,workFlowData:null,initComponent:function(){var me=this;me.columns=me.getColumns();me.store=me.contractData.getWorkflowStore();this.callParent();},getColumns:function(){var me=this;return[{text:i18n('i18n.ManualRewardIntegralManagerView.deptName'),dataIndex:'deptName',flex:1},{text:'工作流的类型',dataIndex:'operatorType',flex:1,renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.WORKFLOWTYPE);}},{text:i18n('i18n.ContractEditView.workFlowNum'),dataIndex:'workflowId',flex:1},{text:i18n('i18n.ContractEditView.OAApprovalStatus'),dataIndex:'approvalState',flex:1,renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.CONTRACT_WORKFLOW_STATUS);}},{text:i18n('i18n.PotentialCustManagerView.createTime'),dataIndex:'createDate',flex:1,renderer:function(value){return DpUtil.renderDate(value);}},{text:i18n('i18n.ContractEditView.lastApprovalTime'),dataIndex:'modifyDate',flex:1,renderer:function(value){return DpUtil.renderDate(value);}},{text:i18n('i18n.ContractEditView.loatApprovalUser'),dataIndex:'approvalMan',flex:1}];},loadWorkFlowData:function(workFlowData){var me=this;me.store.loadData(workFlowData);}});Ext.define('ApplyReasonPanel',{extend:'BasicVboxFormPanel',contractData:null,application:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'titlepanel',items:[{xtype:'displayfield',value:i18n('i18n.ContractEditView.c_applyReason')}]},{xtype:'textareapanel',flex:1,items:[{xtype:'textareafield',name:'application',allowBlank:false,maxLength:200,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',200),blankText:i18n('i18n.ContractEditView.m_notNull'),emptyText:i18n('i18n.ContractEditView.pleaseInputReasonForApplication')}]}];},loadApplication:function(application){var me=this;me.getForm().findField('application').setValue(application);}});Ext.define('ContractAttachment',{extend:'BasicVboxPanel',contractData:null,attachData:null,status:null,operateType:'DELAY',initComponent:function(){var me=this;me.items=me.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'toppanel',items:[{xtype:'titlepanel',flex:1,items:[{xtype:'displayfield',value:i18n('i18n.ContractEditView.c_file')}]},{xtype:'btnpanel',items:[{xtype:'button',id:'fileUpLoadButton',text:i18n('i18n.ChangeContactAffiliatedRelationView.uploadFile'),scope:me,handler:me.showUploadAttachWin},{xtype:'button',text:'删除',disabled:('VIEW'==me.status)?true:false,scope:me,handler:function(){var grid=me.down('grid');var store=grid.store;selection=grid.getSelectionModel().getSelection();for(var i=0;i<selection.length;i++){if(!Ext.isEmpty(selection[i].get('id'))){MessageUtil.showMessage(i18n('i18n.contractEditView.cannotDel',selection[i].get('fileName')));return;}
store.remove(selection[i]);}}}]}]},{xtype:'popupgridpanel',id:'attachPanelId',flex:1,store:me.contractData.getFileInfoStore(),columns:[new Ext.grid.RowNumberer(),{header:i18n('i18n.ChangeContactAffiliatedRelationView.fileName'),flex:1,dataIndex:'fileName'},{header:i18n('i18n.ChangeContactAffiliatedRelationView.savePath'),dataIndex:'savePath',hidden:true}]}];},showUploadAttachWin:function(){var me=this;Ext.create('UploadAttachmentWin',{'operateType':me.operateType,'parent':me,'contractData':me.contractData}).show();},addAttachData:function(attachData){var me=this;Ext.getCmp('attachPanelId').store.add(attachData);},loadAttachData:function(attachData){var me=this;Ext.getCmp('attachPanelId').store.loadData(attachData);},collectAlterAttachData:function(alterAddAttachList){var me=this;var addAttachRecords=me.contractData.getFileInfoStore().getNewRecords();for(var i=0;i<addAttachRecords.length;i++){alterAddAttachList.push(addAttachRecords[i].data);}}});Ext.define('UploadAttachmentWin',{extend:'PopWindow',title:i18n('i18n.PotentialCustManagerView.messageTip'),layout:{type:'vbox',align:'stretch'},operateType:null,contractData:null,width:400,height:150,parent:null,attachmentForm:null,initComponent:function(){var me=this;me.items=[{xtype:'titlepanel',items:[{xtype:'displayfield',value:i18n('i18n.ContractEditView.pleaseInputContractAttachment'),width:100}]},{xtype:'basicformpanel',flex:1,layout:{type:'hbox'},defaults:{margins:'0 5 0 0'},items:[{xtype:'filefield',name:'file',fieldLabel:i18n('i18n.ContractEditView.contractAttachment'),labelWidth:60,allowBlank:false,buttonText:i18n('i18n.ChangeContactAffiliatedRelationView.view'),flex:3},{text:i18n('i18n.ChangeContactAffiliatedRelationView.sourceType'),name:'type',xtype:'hiddenfield',value:'contractAttDir'}]}];me.fbar=me.getFbar();this.callParent();},getFbar:function(){var me=this;return[{text:i18n('i18n.ChangeContactAffiliatedRelationView.button_upload'),xtype:'button',scope:me,handler:me.uploadFile},{text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),xtype:'button',handler:function(){me.close();}}];},uploadFile:function(){var me=this;var form=me.down('form');if(!form.getForm().isValid()){MessageUtil.showMessage(i18n('i18n.ContractEditView.m_uploadFile'));return;}
form.submit({url:'../common/fileUpload.action',waitMsg:i18n('i18n.ChangeContactAffiliatedRelationView.uploading'),success:function(form,response){var result=response.result;if(result.success){var fileInfo=result.fileInfoList[0];MessageUtil.showInfoMes(i18n('i18n.ChangeContactAffiliatedRelationView.file')+fileInfo.fileName+i18n('i18n.ChangeContactAffiliatedRelationView.uploadSeccess'));me.parent.addAttachData(fileInfo);me.close();}else{MessageUtil.showErrorMes(result.message);me.close();}},failure:function(form,response){var result=response.result;if(!result.success){MessageUtil.showErrorMes(result.message);}}});}});
var contractManagerDataControl=new ContractManagerData();Ext.define('ContractManagerPanel',{extend:'BasicPanel',parent:null,contractManagerConditionForm:null,contractManagerResultGrid:null,contractManagerButtonPanel:null,contractData:null,layout:{type:'vbox',align:'stretch'},initComponent:function(){var me=this;var record=new ContractConditionModel();me.contractManagerConditionForm=Ext.create('ContractManagerConditionForm',{'parent':me,'record':record});me.contractManagerButtonPanel=Ext.create('ContractManagerButtonPanel',{'parent':me,'contractData':me.contractData,'contractManagerConditionForm':me.contractManagerConditionForm});me.contractManagerResultGrid=Ext.create('ContractManagerResultGrid',{'parent':me,'contractData':me.contractData});me.items=[{xtype:'basicpanel',height:80,items:[me.contractManagerConditionForm]},{xtype:'basicpanel',height:36,items:[me.contractManagerButtonPanel]},{xtype:'basicpanel',flex:1,items:[me.contractManagerResultGrid]}];this.callParent();me.contractManagerConditionForm.loadRecord(record);DpUtil.defaultDept(me.contractManagerConditionForm,'deptId');}});Ext.define('ContractManagerButtonPanel',{extend:'NormalButtonPanel',contractManagerConditionForm:null,contractData:null,parent:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'leftbuttonpanel',width:580,items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.add'),hidden:!isPermission('/customer/ContractABtn.action'),scope:me,handler:me.addRecord},{xtype:'button',text:i18n('i18n.ContractManagerView.update'),hidden:!isPermission('/customer/ContractUBtn.action'),scope:me,handler:me.updateRecord},{xtype:'button',text:i18n('i18n.ContractManagerView.invalid'),hidden:!isPermission('/customer/ContractDBtn.action'),scope:me,handler:me.invalidContract},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.viewDetails'),hidden:!isPermission('/customer/ContractVBtn.action'),scope:me,handler:me.viewContractDetail},{xtype:'button',text:i18n('i18n.ContractManagerView.bindingContract'),hidden:!isPermission('/customer/ContractBindBtn.action'),scope:me,handler:me.boundContract},{xtype:'button',text:i18n('i18n.ContractManagerView.unbind'),hidden:!isPermission('/customer/ContractUnBindBtn.action'),scope:me,handler:me.relieveContract},{xtype:'button',text:i18n('i18n.ContractManagerView.attributableToChange'),hidden:!isPermission('/customer/ContractBelongChangeBtn.action'),scope:me,handler:me.belongDeptChange}]},{xtype:'middlebuttonpanel'},{xtype:'rightbuttonpanel',width:150,items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.search'),hidden:!isPermission('/customer/ContractSBtn.action'),scope:me,handler:me.searchContractList}]}];},addRecord:function(){Ext.create('ContractEditWin').show();Ext.getCmp('contractSaveButton').setDisabled(false);},updateRecord:function(){var me=this;if(me.selectDate('ONE')){var params={};var record=me.selectedRecord()[0];if(record.get('contractStatus')==2){MessageUtil.showMessage(i18n('i18n.ContractManagerView.failureOfContractCanNotUpdate'));return;}
var operate=i18n('i18n.ContractManagerView.update');params.contractId=record.get('id');var checkSuccess=function(response){success=response.checked;if(success){var viewContractDetailSuccess=function(response){var contractView=response.contractView;Ext.create('ContractEditWin',{'contractView':contractView,'status':'UPDATE'}).show();Ext.getCmp('contractSaveButton').setDisabled(false);};var viewContractDetailFail=function(response){MessageUtil.showErrorMes(response.message);}
me.contractData.viewUpdateContractDetail(params,viewContractDetailSuccess,viewContractDetailFail);}else{MessageUtil.showErrorMes(i18n('i18n.ContractManagerView.contractFailNotOperate',operate));}};var checklFail=function(response){MessageUtil.showErrorMes(response.message);}
me.contractData.contractIsAuditing(params,checkSuccess,checklFail);}},searchContractList:function(){var me=this;if(!me.contractManagerConditionForm.getForm().isValid()){MessageUtil.showErrorMes(i18n('i18n.ContractManagerView.mustIputCreateTimeSub'));return;}
if(!me.checkDataOpposite()){MessageUtil.showErrorMes(i18n('i18n.ContractManagerView.createTimeSubSmallOneYear'));return;}
me.contractData.getContractStore().loadPage(1);},viewContractDetail:function(){var me=this;if(me.selectDate('ONE')){var selection=me.selectedRecord();me.viewContractInfo(me.contractData,selection[0],'VIEW');}},viewContractInfo:function(contractData,record,status){var params={};params.contractId=record.get('id');var viewContractDetailSuccess=function(result){var contractView=result.contractView;Ext.create('ContractEditWin',{'contractView':contractView,'status':status}).show();};var viewContractDetailFail=function(result){MessageUtil.showErrorMes(result.message);}
contractData.viewContractDetail(params,viewContractDetailSuccess,viewContractDetailFail);},invalidContract:function(){var me=this;if(me.selectDate('ONE')){var params={};var record=me.selectedRecord()[0];if(record.get('contractStatus')==2){MessageUtil.showMessage(i18n('i18n.ContractManagerView.contractFailAgainInvalid'));return;}
var operate=i18n('i18n.ContractManagerView.invalid');params.contractId=record.get('id');var checkSuccess=function(response){success=response.checked;if(success){MessageUtil.showQuestionMes(i18n('i18n.ContractManagerView.insureInvalid'),function(e){if(e=='yes'){var invalidContractSuccess=function(result){if(result.workFlowNum==null){MessageUtil.showInfoMes(i18n('i18n.ContractManagerView.operatorSuccess'));}else{MessageUtil.showInfoMes(i18n('i18n.ContractManagerView.opareatorSuccessWorkFlowNum')+result.workFlowNum);}};var invalidContractFail=function(result){MessageUtil.showErrorMes(result.message);}
me.contractData.invalidContract(params,invalidContractSuccess,invalidContractFail);}});}else{MessageUtil.showErrorMes(i18n('i18n.ContractManagerView.contractFailNotOperate',operate));}};var checklFail=function(response){MessageUtil.showErrorMes(response.message);}
me.contractData.contractIsAuditing(params,checkSuccess,checklFail);}},boundContract:function(){var me=this;if(me.selectDate('ONE')){var params={};var record=me.selectedRecord()[0];if(record.get('contractStatus')==2){MessageUtil.showMessage(i18n('i18n.ContractManagerView.failureOfContractCanNotBinding'));return;}
if(CurrentUser.deptId==record.get('deptId')){MessageUtil.showMessage(i18n('i18n.ContractManagerView.attributableToChangeNotrBinding'));return;}
var operate=i18n('i18n.ContractManagerView.bindingContract');params.contractId=record.get('id');var checkSuccess=function(response){success=response.checked;if(success){var BoundContractWin=Ext.create('BoundContractWin',{'operateType':'DELAY','contractData':me.contractData,'record':record});BoundContractWin.down('grid').store.removeAll();BoundContractWin.show();}else{MessageUtil.showErrorMes(i18n('i18n.ContractManagerView.contractFailNotOperate',operate));}};var checklFail=function(response){MessageUtil.showErrorMes(response.message);}
me.contractData.contractIsAuditing(params,checkSuccess,checklFail);}},relieveContract:function(){var me=this;if(me.selectDate('ONE')){MessageUtil.showQuestionMes(i18n('i18n.ContractManagerView.pleaseIseurDeptContractBinding'),function(e){if(e=='yes'){var params={};var record=me.selectedRecord()[0];if(record.get('contractStatus')==2){MessageUtil.showMessage(i18n('i18n.ContractManagerView.failureOfContractNotUnbind'));return;}
var operate=i18n('i18n.ContractManagerView.unbind');params.contractId=record.get('id');var checkSuccess=function(response){success=response.checked;if(success){params.deptId=record.get('deptId');var relieveContractSuccess=function(result){MessageUtil.showInfoMes(i18n('i18n.BoundContactNumView.operateSuccess'));};var relieveContractFail=function(result){MessageUtil.showErrorMes(result.message);}
me.contractData.relieveContract(params,relieveContractSuccess,relieveContractFail);}else{MessageUtil.showErrorMes(i18n('i18n.ContractManagerView.contractFailNotOperate',operate));}};var checklFail=function(response){MessageUtil.showErrorMes(response.message);}
me.contractData.contractIsAuditing(params,checkSuccess,checklFail);}});}},belongDeptChange:function(){var me=this;if(me.selectDate('ONE')){var record=me.selectedRecord()[0];if(record.get('contractStatus')==2){MessageUtil.showMessage(i18n('i18n.ContractManagerView.failureOfContractCanNotAttributableToChange'));return;}
var params={};var operate=i18n('i18n.ContractManagerView.attributableToChange');params.contractId=record.get('id');var checkSuccess=function(response){success=response.checked;if(success){if(CurrentUser.deptId==record.get('deptId')){MessageUtil.showMessage(i18n('i18n.ContractManagerView.attributableDeptHasNowDeptConNotChange'));return;}
var belongDeptChange=Ext.create('BelongDeptChangeWin',{'operateType':'DELAY','contractData':me.contractData,'record':record});var form=belongDeptChange.down('form').getForm();form.findField('beforeChangeDeptName').setValue(record.get('deptName'));form.findField('changedDeptName').setValue(CurrentUser.deptName);form.findField('changedDeptId').setValue(CurrentUser.deptId);Ext.getCmp('attachPanelId').store.removeAll();belongDeptChange.show();}else{MessageUtil.showErrorMes(i18n('i18n.ContractManagerView.contractFailNotOperate',operate));}};var checklFail=function(response){MessageUtil.showErrorMes(response.message);}
me.contractData.contractIsAuditing(params,checkSuccess,checklFail);}},expordContract:function(){var me=this;if(!me.contractManagerConditionForm.getForm().isValid()){MessageUtil.showMessage(i18n('i18n.ContractManagerView.mustIputCreateTimeSub'));return;}
if(!me.checkDataOpposite()){MessageUtil.showMessage(i18n('i18n.ContractManagerView.createTimeSubSmallOneYear'));return;}
var searchConditionForm=Ext.getCmp('contractManagerConditionFormId');searchConditionForm.getForm().updateRecord(searchConditionForm.record);var searchCustCondition=searchConditionForm.record.data;var contractCondition={'deptId':DpUtil.trimString(searchCustCondition.deptId),'custNumber':DpUtil.trimString(searchCustCondition.custNumber),'custCompany':DpUtil.trimString(searchCustCondition.custCompany),'contractNum':DpUtil.trimString(searchCustCondition.contractNum),'contactName':DpUtil.trimString(searchCustCondition.contactName),'searchStartTime':searchCustCondition.searchStartTime,'searchEndTime':searchCustCondition.searchEndTime}
var expordContractSuccess=function(response){};var expordContractFail=function(result){MessageUtil.showErrorMes(result.message);}
me.contractData.expordContract(window,contractCondition);},selectDate:function(sum){var me=this;var selection=me.selectedRecord();if('ONE'==sum&&selection.length!=1){MessageUtil.showMessage(i18n('i18n.ManualRewardIntegralEditView.m_selectOnlyOne'));return false;}
if('MANY'==sum&&selection.length==0){MessageUtil.showMessage(i18n('i18n.ManualRewardIntegralEditView.m_selectOne'));return false;}
return true;},selectedRecord:function(){var me=this;var grid=me.parent.contractManagerResultGrid;return grid.getSelectionModel().getSelection();},checkDataOpposite:function(){var me=this;var flag=false;var form=me.contractManagerConditionForm;var objPre=form.getForm().findField('searchStartTime');var objNext=form.getForm().findField('searchEndTime');if(!DpUtil.isEmpty(objPre.getValue())&&!DpUtil.isEmpty(objNext.getValue())){if(objPre.getValue()<=objNext.getValue()){if((objNext.getValue().getTime()-objPre.getValue().getTime())<=1000*3600*24*365){return true;}}}
return flag;},validateCondition:function(){var me=this;var form=me.contractManagerConditionForm;var flag=false;form.getForm().getFields().each(function(field){if(i18n('i18n.Integral.dept')==field.fieldLabel){if(!Ext.isEmpty(field.getRawValue())){flag=true;}}
if(!(DpUtil.isEmpty(field.getValue()))&&field.getValue()!=i18n('i18n.PotentialCustManagerView.searchEndTime')&&'searchStartTime'!=field.name&&'searchEndTime'!=field.name){flag=true;}});return flag;},contractIsAuditing:function(contract,operate){var me=this;var success=true;var message='';var params={};params.contractId=contract.get('id');var checkSuccess=function(response){success=response.checked;if(!success){message=i18n('i18n.ContractManagerView.contractFailNotOperate',operate);}};var checklFail=function(response){success=false;message=response.message;}
me.contractData.contractIsAuditing(params,checkSuccess,checklFail);return{success:success,message:message};}});Ext.define('ContractManagerConditionForm',{extend:'SearchFormPanel',id:'contractManagerConditionFormId',record:null,parent:null,layout:{type:'table',columns:4},defaultType:'textfield',initComponent:function(){var me=this;me.defaults=me.getDefaultsContainer();me.items=me.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'belongdeptcombox',forceSelection:true,fieldLabel:i18n('i18n.Integral.dept'),name:'deptId'},{fieldLabel:i18n('i18n.ContractEditView.customersFullName'),maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20),name:'custCompany'},{fieldLabel:i18n('i18n.MemberCustEditView.custNo'),maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20),name:'custNumber'},{fieldLabel:i18n('i18n.ContractEditView.contractNum'),maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20),name:'contractNum'},{fieldLabel:i18n('i18n.MemberCustEditView.agreementContact'),maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20),name:'contactName'},{xtype:'fieldcontainer',colspan:2,border:0,width:400,layout:'column',defaultType:'datefield',defaults:{enableKeyEvents:true,listeners:{scope:me,keypress:me.keypressEvent}},items:[{fieldLabel:i18n('i18n.PotentialCustManagerView.createTime'),labelWidth:65,width:200,format:'Y-m-d',maxValue:new Date(),name:'searchStartTime',allowBlank:false},{xtype:'displayfield',width:10,value:i18n('i18n.PotentialCustManagerView.searchEndTime')},{xtype:'datefield',allowBlank:false,width:130,format:'Y-m-d',maxValue:new Date(),name:'searchEndTime'}]}];},getDefaultsContainer:function(){var me=this;return{labelWidth:65,width:195,enableKeyEvents:true,listeners:{scope:me,keypress:me.keypressEvent,change:me.changeEvent}};},keypressEvent:function(field,event){var me=this;if(event.getKey()==Ext.EventObject.ENTER){me.parent.contractManagerButtonPanel.searchContractList();}},changeEvent:function(field,newValue){var me=this;if(('belongdeptcombox'==field.getXType()||'combobox'==field.getXType())&&Ext.isEmpty(newValue)){field.setValue(null);}}});Ext.define('ContractManagerResultGrid',{extend:'SearchGridPanel',searchConditionForm:null,contractData:null,initComponent:function(){var me=this;me.store=me.contractData.initContractStore(me.beforeLoadFn);me.dockedItems=me.getMyDockedItems();me.listeners=me.getMyListeners();me.selModel=Ext.create('Ext.selection.CheckboxModel');me.columns=me.getColumns();this.callParent();me.store.on('load',function(s,records){var girdcount=0;s.each(function(r){if(2==r.get('contractStatus')){var cells=me.getView().getNodes()[girdcount].children;for(var i=0;i<cells.length;i++){cells[i].style.backgroundColor='#FFEEDD';}}
girdcount++;});});},getColumns:function(){var me=this;return[{header:i18n('i18n.ContractManagerView.contractid'),hidden:true,dataIndex:'id'},{header:i18n('i18n.ContractEditView.contractNum'),dataIndex:'contractNum'},{header:i18n('i18n.ContractManagerView.attributableDept'),dataIndex:'deptName'},{header:i18n('i18n.ContractEditView.customersFullName'),dataIndex:'custCompany'},{header:i18n('i18n.ContractEditView.preferentialType'),dataIndex:'preferentialType',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.PRIVILEGE_TYPE);}},{header:i18n('i18n.ContractEditView.resultsSectionBy'),dataIndex:'payWay',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.RECKON_WAY);}},{header:i18n('i18n.ContractManagerView.arrearsAmount'),dataIndex:'arrearaMount'},{header:i18n('i18n.IntegralRuleEdit.validateDate'),dataIndex:'contractBeginDate',renderer:DpUtil.renderDate},{header:i18n('i18n.ContractManagerView.expirationDate'),dataIndex:'contractendDate',renderer:DpUtil.renderDate},{header:i18n('i18n.ContractEditView.contractStatus'),dataIndex:'contractStatus',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.CONTACT_STATUS);}},{header:i18n('i18n.MemberCustEditView.agreementContact'),dataIndex:'linkManName'},{header:i18n('i18n.PotentialCustManagerView.contactPhone'),dataIndex:'linkManMobile'},{header:i18n('i18n.PotentialCustManagerView.contactTel'),dataIndex:'linkManPhone'},{header:i18n('i18n.PotentialCustManagerView.creator'),dataIndex:'createUser'},{header:i18n('i18n.PotentialCustManagerView.createTime'),dataIndex:'createDate',renderer:function(value){return DpUtil.renderDate(value);}},{header:i18n('i18n.PotentialCustManagerView.lastUpdate'),dataIndex:'modifyUser'},{header:i18n('i18n.PotentialCustManagerView.lastUpdateTime'),dataIndex:'modifyDate',renderer:function(value){return DpUtil.renderDate(value);}}];},getMyDockedItems:function(){var me=this;return[{xtype:'pagingtoolbar',store:me.store,dock:'bottom',displayInfo:true}];},getMyListeners:function(){var me=this;return{itemdblclick:function(grid,record){me.parent.contractManagerButtonPanel.viewContractInfo(me.contractData,record,'VIEW');}};},beforeLoadFn:function(store,operation,eOpts){var searchConditionForm=Ext.getCmp('contractManagerConditionFormId');if(searchConditionForm!=null){searchConditionForm.getForm().updateRecord(searchConditionForm.record);var searchCustCondition=searchConditionForm.record.data;var searchParams={'contractCondition.deptId':DpUtil.trimString(searchCustCondition.deptId),'contractCondition.custNumber':DpUtil.trimString(searchCustCondition.custNumber),'contractCondition.custCompany':DpUtil.trimString(searchCustCondition.custCompany),'contractCondition.contractNum':DpUtil.trimString(searchCustCondition.contractNum),'contractCondition.contactName':DpUtil.trimString(searchCustCondition.contactName),'contractCondition.searchStartTime':searchCustCondition.searchStartTime,'contractCondition.searchEndTime':searchCustCondition.searchEndTime};Ext.apply(operation,{params:searchParams});}},getViewConfig:function(){var me=this;return{getRowClass:function(record,rowIndex,rp,ds){if(2==record.data.contractStatus)
{return'background: red';}}}}});Ext.define('BoundContractWin',{extend:'PopWindow',title:i18n('i18n.ContractManagerView.bindingContract'),width:600,height:200,layout:'fit',contractData:null,record:null,contractAttachment:null,initComponent:function(){var me=this;me.contractAttachment=Ext.create('ContractAttachment',{'operateType':'DELAY','contractData':me.contractData,'record':me.record})
me.items=[me.contractAttachment];me.fbar=me.getFbar();this.callParent();},getFbar:function(){var me=this;return[{xtype:'button',scope:me,text:i18n('i18n.MemberCustEditView.submit'),handler:me.submitBound},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),scope:me,handler:me.cancelBound}];},submitBound:function(button){var me=this;var params={};var alterAddAttachList=new Array();button.setDisabled(true);me.contractAttachment.collectAlterAttachData(alterAddAttachList);var contractId=me.record.get('id');params.contractId=contractId;if(alterAddAttachList.length<=0){button.setDisabled(false);MessageUtil.showMessage(i18n('i18n.ContractManagerView.contractBindingNeedUploadReLoad'));return;}
params.fileInfo=alterAddAttachList[0];params.fileInfo.contractId=contractId;var boundContractSuccess=function(result){button.setDisabled(false);if(result.workFlowNum==null){MessageUtil.showInfoMes(i18n('i18n.ContractManagerView.operatorSuccess'));}else{MessageUtil.showInfoMes(i18n('i18n.ContractManagerView.opareatorSuccessWorkFlowNum')+result.workFlowNum);}
me.close();};var boundContractFail=function(result){button.setDisabled(false);MessageUtil.showErrorMes(result.message);}
me.contractData.boundContract(params,boundContractSuccess,boundContractFail);},cancelBound:function(){var me=this;me.close();}});Ext.define('BelongDeptChangeWin',{extend:'PopWindow',title:i18n('i18n.ContractManagerView.attributableToChange'),contractData:null,operateType:null,contractAttachment:null,record:null,width:600,height:230,record:null,layout:{type:'vbox',align:'stretch'},initComponent:function(){var me=this;me.contractAttachment=Ext.create('ContractAttachment',{'operateType':me.operateType,'contractData':me.contractData,'record':me.record,width:300,height:100})
me.items=me.getItems();me.fbar=me.getFbar();this.callParent();},getItems:function(){var me=this;return[{xtype:'basicformpanel',layout:'column',height:30,defaultType:'textfield',items:[{fieldLabel:i18n('i18n.ContractManagerView.beforeCangeDept'),name:'beforeChangeDeptName',readOnly:true},{name:'changedDeptName',fieldLabel:i18n('i18n.ContractManagerView.afterChangeDept'),readOnly:true},{fieldLabel:i18n('i18n.ContractManagerView.afterChangeDeptId'),xtype:'hiddenfield',name:'changedDeptId',readOnly:true}]},me.contractAttachment];},getFbar:function(){var me=this;return[{xtype:'button',scope:me,text:i18n('i18n.MemberCustEditView.submit'),handler:me.changeDeptSubmit},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),scope:me,handler:me.changeDeptCancel}];},changeDeptSubmit:function(button){var me=this;var form=me.down('form').getForm();var params={};var deptId=form.findField('changedDeptId').getValue();var contractId=me.record.get('id');button.setDisabled(true);var alterAddAttachList=new Array();me.contractAttachment.collectAlterAttachData(alterAddAttachList);if(alterAddAttachList.length!=1){button.setDisabled(false);MessageUtil.showMessage(i18n('i18n.ContractManagerView.changeDeptNeedUpLoad'));return;}
params.deptId=deptId;params.contractId=contractId;params.fileInfo=alterAddAttachList[0];params.fileInfo.contractId=contractId;var belongDeptChangeSuccess=function(result){button.setDisabled(false);if(result.workFlowNum==null){MessageUtil.showInfoMes(i18n('i18n.ContractManagerView.operatorSuccess'));}else{MessageUtil.showInfoMes(i18n('i18n.ContractManagerView.opareatorSuccessWorkFlowNum')+result.workFlowNum);}
me.close();};var belongDeptChangeFail=function(result){button.setDisabled(false);MessageUtil.showErrorMes(result.message);}
me.contractData.belongDeptChange(params,belongDeptChangeSuccess,belongDeptChangeFail);},changeDeptCancel:function(){var me=this;me.close();}});Ext.define('InitSearchMemberFieldContainer',{extend:'Ext.form.FieldContainer',fieldLabel:'searchMemberFieldText',winTitle:i18n('i18n.ContractEditView.contractInfo'),winWidth:860,winHeight:350,contractData:null,name:'searchMemberField',initComponent:function(){var me=this;this.callParent();},getItems:function(){var me=this;return[{xtype:'displayfield',width:10,value:me.fieldLabel},{xtype:'textfield',name:me.name,hideLabel:true,width:65,labelWidth:10}];}});Ext.onReady(function(){var params=['RECKON_WAY','PRIVILEGE_TYPE','CUSTOMER_TYPE','MEMBER_GRADE','TRADE','CONTACT_STATUS','CONTRACT_WORKFLOW_STATUS','WORKFLOWTYPE'];initDataDictionary(params);DurrentUserBelongDept=new BelongDeptView().getDeptListDate();contractManagerDataControl.getCurrentUser();Ext.create('Ext.container.Viewport',{layout:'fit',items:[Ext.create('ContractManagerPanel',{'contractData':contractManagerDataControl})]});});