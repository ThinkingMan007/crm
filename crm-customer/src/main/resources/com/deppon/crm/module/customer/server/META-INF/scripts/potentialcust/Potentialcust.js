Ext.JSON.encodeDate=function(d){return d.getTime();};String.prototype.replaceAll=function(AFindText,ARepText){raRegExp=new RegExp(AFindText,"g");return this.replace(raRegExp,ARepText);};DpUtil=function(){};DpUtil.isEmpty=function(str){return Ext.isEmpty(str);};DpUtil.requestJsonAjax=function(url,params,successFn,failFn,timeout)
{Ext.Ajax.request({url:url,jsonData:params,timeout:(Ext.isEmpty(timeout))?600000:timeout,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.requestJsonAjaxSync=function(url,params,successFn,failFn,timeout)
{Ext.Ajax.request({url:url,async:false,jsonData:params,timeout:(Ext.isEmpty(timeout))?600000:timeout,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.requestFileUploadAjax=function(url,form,successFn,failFn)
{Ext.Ajax.request({url:url,form:form,isUpload:true,success:function(form,action){var result=action.result;if(result.success){successFn(result);}else{failFn(result);}},failure:function(form,action){var result=action.result;failFn(result);}});};DpUtil.requestAjax=function(url,params,successFn,failFn)
{Ext.Ajax.request({url:url,params:params,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.changeLongToDate=function(value){if(value!=null){var date=new Date(value);return date;}else{return null;}};DpUtil.renderDate=function(value){if(value!=null){return Ext.Date.format(new Date(value),'Y-m-d');}else{return null;}};DpUtil.changeDictionaryDescipToCode=function(store,descrip){var record=store.findRecord('codeDesc',descrip);if(!DpUtil.isEmpty(record)){return record.get('code');}else{return"";}};DpUtil.changeDictionaryCodeToDescrip=function(value,dataDictionary){if(value!=null&&dataDictionary!=null){for(var i=0;i<dataDictionary.length;i++){if(value==dataDictionary[i].code){return dataDictionary[i].codeDesc;}}}else{return null;}};DpUtil.changeBooleanToDescrip=function(value){if(value==false){return i18n('i18n.ChangeContactAffiliatedRelationView.no');}else if(value==true){return i18n('i18n.ChangeContactAffiliatedRelationView.yes');}
return null;};DpUtil.changeIntToDescrip=function(value){if(value==0){return i18n('i18n.ChangeContactAffiliatedRelationView.no');}else if(value==1){return i18n('i18n.ChangeContactAffiliatedRelationView.yes');}
return null;};DpUtil.changeNullToEmptyString=function(value){if(value==null){return'';}else{return value}};DpUtil.compareRecordFieldIsChange=function(oldValue,newValue){if(oldValue==newValue){return false;}else if(DpUtil.changeNullToEmptyString(oldValue)==DpUtil.changeNullToEmptyString(newValue)){return false;}else{return true;}};DpUtil.keyPress=function(e,getData,param,limit,successFn){var paramValue=e.target.value;if(Ext.isEmpty(paramValue)){return;}
if(paramValue.length<limit){return;}
if(e.getKey()==Ext.EventObject.ENTER&&paramValue!=""&&paramValue.length>=limit)
{var failureFn=function(json){DpUtil.showMessage(json.message);};getData(param,successFn,failureFn);}};DpUtil.showMessage=function(meaage){top.Ext.MessageBox.alert(i18n('i18n.PotentialCustManagerView.message'),meaage);};DpUtil.showConfimMessageBox=function(msg,message,yesFn,noFn){Ext.MessageBox.confirm(msg,message,function(e){if(e=='yes'){yesFn;}else{noFn;}});};DpUtil.createStore=function(storeId,model,fields,data){var store=Ext.data.StoreManager.lookup(storeId);if(Ext.isEmpty(data)){data=[];}
if(!Ext.isEmpty(model)){if(store===undefined){store=Ext.create('Ext.data.Store',{storeId:storeId,model:model,data:data});}}
if(!Ext.isEmpty(fields)){if(store===undefined){store=Ext.create('Ext.data.Store',{storeId:storeId,fields:fields,data:data});}}
return store;};DpUtil.changeLongToDate=function(value){if(value!=null){var date=new Date(value);return date;}else{return null;}};DpUtil.trimString=function(value){if(!Ext.isEmpty(value)){return value.trim();}
return value;};DpUtil.createDateCombo=function(fieldLabel,name,store,allowBlank,readOnly,labelWidth,width,blankText,changEvent){var fn=function(){};var chang=function(field,newValue){if(Ext.isEmpty(newValue)){field.setValue(null);}};var combo=Ext.create('Ext.form.ComboBox',{fieldLabel:fieldLabel,xtype:'combobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',allowBlank:allowBlank,readOnly:readOnly,name:name,labelWidth:labelWidth,width:width,store:store,blankText:blankText,listeners:{change:(changEvent==null)?fn:((changEvent==true)?chang:changEvent)}});return combo;};Ext.define('DpComboBox',{extend:'Ext.form.ComboBox',alias:['widget.dpcombobox','widget.dpcombo'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpNumberField',{extend:'Ext.form.Number',alias:['widget.dpnumberfield','widget.dpnumber'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpDateField',{extend:'Ext.form.Date',alias:['widget.dpdatefield','widget.dpdate'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpTimeField',{extend:'Ext.form.Time',alias:'widget.dpdtimefield',setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});DpUtil.getCurrentMonthDays=function(month){var currentMonth=month+1;switch(currentMonth){case 1:case 3:case 5:case 7:case 8:case 10:case 12:return 31;break;case 2:return 28;break;default:return 30;break;　　}}
DpUtil.keyPress=function(e,getData,param,limit,successFn){var paramValue=e.target.value;if(Ext.isEmpty(paramValue)){return;}
if(paramValue.length<limit){return;}
if(e.getKey()==Ext.EventObject.ENTER&&paramValue!=""&&paramValue.length>=limit)
{var failureFn=function(json){DpUtil.showMessage(json.message);};getData(param,successFn,failureFn);}};DpUtil.checkDataInOneYear=function(objPre,objNext){var success=true;var message='';if((DpUtil.isEmpty(objPre.getValue())||DpUtil.isEmpty(objNext.getValue()))){var success=false;var message=i18n('i18n.DpUtil.d_notAllDateNull');}else if(!DpUtil.isEmpty(objPre.getValue())&&!DpUtil.isEmpty(objNext.getValue())){if(objPre.getValue()>objNext.getValue()){var success=false;var message=i18n('i18n.DpUtil.d_startNotBigger');}else{if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()<=1){if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()==1){var monthsNext=objNext.getValue().getMonth()-objPre.getValue().getMonth()+12;if(monthsNext<=12){if(monthsNext==12){if(objNext.getValue().getDate()>objPre.getValue().getDate()){var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}else{var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}else{var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}
return{success:success,message:message};}
DpUtil.checkDataInOneYear1=function(year,month,day){var data=new Date();data.setYear(new Date().getYear()+year);data.setYear(new Date().getMonth()+month);data.setYear(new Date().getDay()+day);if((DpUtil.isEmpty(objPre.getValue())||DpUtil.isEmpty(objNext.getValue()))){var success=false;var message=i18n('i18n.DpUtil.d_notAllDateNull');}else if(!DpUtil.isEmpty(objPre.getValue())&&!DpUtil.isEmpty(objNext.getValue())){if(objPre.getValue()>objNext.getValue()){var success=false;var message=i18n('i18n.DpUtil.d_startNotBigger');}else{if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()<=1){var monthsNext=objNext.getValue().getMonth()-objPre.getValue().getMonth()+12;if(monthsNext>=0&&monthsNext<=12){if(monthsNext==12){if(objNext.getValue().getDate()>objPre.getValue().getDate()){var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}}}}}
DpUtil.linkWayLimit=function(regText){var mobil=/^1\d{10}$/;var tel=/^\d{3}[\d\*-/]{4,17}$/;var idCard=/^([\d]{15}|[\d]{18}|[\d]{17}X)$/;var defaultValue=/^\d{11}$/;switch(regText){case'M':return mobil;break;case'T':return tel;break;case'I':return tel;break;default:return defaultValue;break;　　}}
DpUtil.defaultDept=function(form,fieldName){var dept=form.getForm().findField(fieldName);dept.store.add(Ext.create('CurrentUserDeptListModel',{'deptId':top.User.deptId,'deptName':top.User.deptName}));dept.setValue(top.User.deptId);}
CurrentCity={id:'',name:''};Ext.define('DataDictionaryModel',{extend:'Ext.data.Model',fields:['code','codeDesc']});Ext.define('CustSourceStore',{extend:'Ext.data.Store',model:'DataDictionaryModel',data:null});Ext.define('IndustryStore',{extend:'Ext.data.Store',model:'DataDictionaryModel',data:null});Ext.define('CoopertationCompanyStore',{extend:'Ext.data.Store',model:'DataDictionaryModel',data:null});Ext.define('CoopertationIntensionStore',{extend:'Ext.data.Store',model:'DataDictionaryModel',data:null});Ext.define('GoodsPotentialStore',{extend:'Ext.data.Store',model:'DataDictionaryModel',data:null});Ext.define('BusinessOpportunityStore',{extend:'Ext.data.Store',model:'DataDictionaryModel',data:null});Ext.define('PotentialCustModel',{extend:'Ext.data.Model',fields:['id','custName','trade','custbase','linkManName','linkManMobile','linkManPhone','post','bussinesState','city','cityName','address','recentcoop','coopIntention','volumePotential','recentGoods','custNeed','createUser',{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},'modifyUser',{name:'reviTimes',type:'int'},{name:'finalreviTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null},'developState',{name:'programmeTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:null}]});Ext.define('PotentialCustStore',{extend:'Ext.data.Store',model:'PotentialCustModel',pageSize:20,proxy:{type:'ajax',api:{read:'searchPotentialCustomerList.action'},actionMethods:'POST',reader:{type:'json',root:'potentialCustlist',totalProperty:'totalCount'},writer:{type:'json',root:'potentialCust'}}});Ext.define('PotentialCustBasicData',{custSourceStore:null,industryStore:null,coopertationCompanyStore:null,coopertationIntensionStore:null,goodsPotentialStore:null,businessOpportunityStore:null,cityStore:null,getCustSourceStore:function(){if(this.custSourceStore==null){this.custSourceStore=Ext.create('CustSourceStore',{data:DataDictionary.CUST_SOURCE});}
return this.custSourceStore;},getIndustryStore:function(){if(this.industryStore==null){this.industryStore=Ext.create('IndustryStore',{data:DataDictionary.TRADE});}
return this.industryStore;},getCoopertationCompanyStore:function(){if(this.coopertationCompanyStore==null){this.coopertationCompanyStore=Ext.create('CoopertationCompanyStore',{data:DataDictionary.COOPERATION_LOGISTICS});}
return this.coopertationCompanyStore;},getCoopertationIntensionStore:function(){if(this.coopertationIntensionStore==null){this.coopertationIntensionStore=Ext.create('CoopertationIntensionStore',{data:DataDictionary.COOPERATION_INTENTION});}
return this.coopertationIntensionStore;},getGoodsPotentialStore:function(){if(this.goodsPotentialStore==null){this.goodsPotentialStore=Ext.create('GoodsPotentialStore',{data:DataDictionary.CARGO_POTENTIAL});}
return this.goodsPotentialStore;},getBusinessOpportunityStore:function(){if(this.businessOpportunityStore==null){this.businessOpportunityStore=Ext.create('BusinessOpportunityStore',{data:DataDictionary.BUSINESS_STATUS});}
return this.businessOpportunityStore;},getPotentialCustStore:function(){return this.potentialCustStore;},initialPotentialCustStore:function(beforeLoadPotentialFn){if(this.potentialCustStore==null){this.potentialCustStore=Ext.create('PotentialCustStore',{listeners:{beforeload:beforeLoadPotentialFn}});}
return this.potentialCustStore;},acquireDeptCity:function(params,successFn,failFn){DpUtil.requestJsonAjaxSync('../common/acquireDeptCity.action',params,successFn,failFn);}});
Ext.define('CityModel',{extend:'Ext.data.Model',fields:['id','cityName']});Ext.define('PotentialCustData',{extend:'PotentialCustBasicData',cityStore:null,savePotentialCust:function(params,saveSuccessFn,saveFailFn){DpUtil.requestJsonAjax('addPotentialCust.action',params,saveSuccessFn,saveFailFn);},updatePotentialCust:function(params,saveSuccessFn,saveFailFn){DpUtil.requestJsonAjax('updatePotentialCust.action',params,saveSuccessFn,saveFailFn);},getCityStore:function(){return this.cityStore;}});
Ext.define('PotentialCustConditionModel',{extend:'Ext.data.Model',fields:[{name:'customerName'},{name:'contactName'},{name:'contactPhone'},{name:'contactTel'},{name:'industry'},{name:'coopIntention'},{name:'custSource'},{name:'bizStatus'},{name:'goodsPotential'},{name:'searchStartTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:(new Date().setDate(new Date().getDate()-30))},{name:'searchEndTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'position'},{name:'businessType',defaultValue:'LESS_THAN_TRUCKLOAD'}]});Ext.define('ImportCustDataModel',{extend:'PotentialCustModel',fields:['rowNum','message',{name:'importSuccess',type:'boolean'},{name:'validatePast',type:'boolean',defaultValue:true}]});Ext.define('ImportCustDataStore',{extend:'Ext.data.Store',model:'ImportCustDataModel',proxy:{type:'memory'}});Ext.define('PotentialCustSearchData',{extend:'PotentialCustBasicData',importCustStore:null,searchPotentialCustomerList:function(params,successFn,failFn){return this.getPotentialCustStore();},deletePotentialCustomer:function(params,successFn,failFn){var deletePotentialCustomerUrl='deletePotentialCustomer.action';DpUtil.requestJsonAjax(deletePotentialCustomerUrl,params,successFn,failFn);},serachPotentialById:function(params,successFn,failFn){var serachPotentialByIdUrl='searchPotentialCustomerById.action';DpUtil.requestJsonAjax(serachPotentialByIdUrl,params,successFn,failFn);},getImportCustStore:function(){if(this.importCustStore==null){this.importCustStore=Ext.create('ImportCustDataStore');}
return this.importCustStore;},batchImportPotentialCust:function(params,saveSuccessFn,saveFailFn){var batchUrl='batchImportPotentialCust.action';DpUtil.requestJsonAjax(batchUrl,params,saveSuccessFn,saveFailFn);},downloadTemplate:function(window){window.open('../common/templateDownLoad.action?propKey=PotentialCust');}});
var potentialCustControl=Ext.create('PotentialCustData');Ext.define('PotentialCustEditWindow',{extend:'PopWindow',title:i18n('i18n.PotentialCustEditView.potentialCustEditView'),fbar:null,potentialCustBasicInfo:null,potentialCustBusinessInfo:null,items:null,width:680,height:370,layout:'fit',viewStatus:null,potentialCustRecord:null,potentialCustData:potentialCustControl,potentialCustManagerView:null,initComponent:function(){var me=this;me.fbar=this.getFbar();me.potentialCustBasicInfo=Ext.create('PotentialCustBasicInfoForm',{'potentialCustData':me.potentialCustData,'parent':me});me.potentialCustBusinessInfo=Ext.create('PotentialCustBusinessInfoForm',{'potentialCustData':me.potentialCustData});me.items=[{xtype:'basicformpanel',layout:'border',items:[{xtype:'basicformpanel',region:'center',layout:'fit',items:[me.potentialCustBasicInfo]},{xtype:'basicformpanel',region:'south',layout:'fit',height:145,items:[me.potentialCustBusinessInfo]}]}];this.callParent();me.controlComponentByViewStatus();},beforeCloseEvent:function(){if(this.viewStatus=='add'){this.potentialCustManagerView.reloadPotentialCust(this.potentialCustRecord,null);}else if(this.viewStatus=='update'){this.potentialCustManagerView.reloadPotentialCust(null,this.potentialCustRecord);}},getFbar:function(){var me=this;return[{text:i18n('i18n.PotentialCustEditView.save'),type:'button',scope:me,handler:me.savePotentialCust},{text:i18n('i18n.PotentialCustEditView.cancel'),type:'button',scope:me,handler:me.cancelSavePotiental}];},cancelSavePotiental:function(){this.close();},controlComponentByViewStatus:function(){var basicForm=this.down('basicformpanel');if(this.potentialCustRecord==null){MessageUtil.showMessage(i18n('i18n.PotentialCustEditView.incomingCustInfo'));}else{basicForm.getForm().loadRecord(this.potentialCustRecord);if(this.viewStatus=='view'){this.lockAllComponent();}else if('update'==this.viewStatus){var form=basicForm.getForm();form.findField('custName').setReadOnly(true);form.findField('linkManName').setReadOnly(true);form.findField('linkManMobile').setReadOnly(true);form.findField('linkManPhone').setReadOnly(true);}}},lockAllComponent:function(){var basicForm=this.down('basicformpanel');var mainForm=basicForm.getForm();mainForm.getFields().each(function(field){field.setReadOnly(true);});},unLockAllComponent:function(){var basicForm=this.down('basicformpanel');var mainForm=basicForm.getForm();mainForm.getFields().each(function(field){field.setReadOnly(false);});},savePotentialCust:function(button){var me=this;var validateRs=me.validatePotentialCust();if(validateRs&&!validateRs.success){MessageUtil.showMessage(validateRs.message);}else{var basicForm=this.down('basicformpanel');var mainForm=basicForm.getForm();mainForm.updateRecord(me.potentialCustRecord);var saveSuccessFn=function(result){MessageUtil.showInfoMes(i18n('i18n.PotentialCustEditView.saveSuccess'));if(me.viewStatus=='add'){me.potentialCustRecord=Ext.create('PotentialCustModel',result.potentialCust);me.potentialCustManagerView.reloadPotentialCust(me.potentialCustRecord,null);}else if(me.viewStatus=='update'){me.potentialCustRecord.set('id',result.potentialCust.id);me.potentialCustManagerView.reloadPotentialCust(null,me.potentialCustRecord);}
me.close();};var saveFailFn=function(result){MessageUtil.showErrorMes(result.message);button.setDisabled(false);};var params={};params.potentialCust=me.potentialCustRecord.data;if(this.viewStatus=='add'){me.potentialCustData.savePotentialCust(params,saveSuccessFn,saveFailFn);}else if(this.viewStatus=='update'){me.potentialCustData.updatePotentialCust(params,saveSuccessFn,saveFailFn);}
button.setDisabled(true);}},validatePotentialCust:function(){var me=this;var potentialCustName=me.potentialCustBasicInfo.down('fieldset').down('textfield[fieldLabel=客户名称]');var linkmanName=me.potentialCustBasicInfo.down('fieldset').down('textfield[fieldLabel=联系人姓名]');if(!(DpUtil.isEmpty(potentialCustName.getValue())&&DpUtil.isEmpty(linkmanName.getValue()))){if(DpUtil.isEmpty(potentialCustName.getValue())){potentialCustName.setValue(linkmanName.getValue());}else if(DpUtil.isEmpty(linkmanName.getValue())){linkmanName.setValue(potentialCustName.getValue());}}
if(me.potentialCustBasicInfo.getForm().isValid()){var linkmanMobile=me.potentialCustBasicInfo.down('fieldset').down('textfield[fieldLabel=联系人手机]');var linkmanPhone=me.potentialCustBasicInfo.down('fieldset').down('textfield[fieldLabel=联系人电话]');if(linkmanMobile&&linkmanPhone&&!(DpUtil.isEmpty(linkmanMobile.getValue())&&DpUtil.isEmpty(linkmanPhone.getValue()))){var address=me.potentialCustBasicInfo.down('fieldset').down('textfield[fieldLabel=地址]');var transferCondition=me.potentialCustBusinessInfo.down('fieldset').down('textfield[fieldLabel=走货情况(最近合作物流公司)]');var custNeeds=me.potentialCustBusinessInfo.down('fieldset').down('textfield[fieldLabel=客户需求]');if(address&&!DpUtil.isEmpty(address.getValue())&&address.getValue().length>100){return{success:false,message:i18n('i18n.PotentialCustEditView.message_waiting')};}
else if(transferCondition&&!DpUtil.isEmpty(transferCondition.getValue())&&transferCondition.getValue().length>200){return{success:false,message:i18n('i18n.PotentialCustEditView.message_goodsLength')};}
else if(custNeeds&&!DpUtil.isEmpty(custNeeds.getValue())&&custNeeds.getValue().length>200){return{success:false,message:i18n('i18n.PotentialCustEditView.message_custNeedLength')};}
else{return{success:true,message:''};}}else{return{success:false,message:i18n('i18n.PotentialCustEditView.message_inputLimited')};}}else{return{success:false,message:i18n('i18n.PotentialCustEditView.nameNotEmpty')};}}});Ext.define('PotentialCustBasicInfoForm',{extend:'BasicFormPanel',defaultType:'textfield',layout:'fit',potentialCustData:null,viewStatus:null,items:null,parent:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;var items=[{xtype:'fieldset',title:i18n('i18n.PotentialCustEditView.potentialCustInfo'),defaults:{labelWidth:70,width:200,enableKeyEvents:true,listeners:{scope:me,keypress:me.enterKeyEvent,change:me.changeEvent}},layout:{type:'table',columns:3},defaultType:'textfield',items:[{fieldLabel:i18n('i18n.PotentialCustManagerView.customerName'),allowBlank:false,blankText:i18n('i18n.PotentialCustEditView.message_custName'),listeners:{scope:me,keypress:me.enterKeyEvent,blur:me.potentialCustNameBlurEvent},maxLength:20,name:'custName'},{fieldLabel:i18n('i18n.PotentialCustManagerView.industry'),xtype:'dpcombo',store:me.potentialCustData.getIndustryStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'trade',listeners:{scope:me,change:function(field,newValue){var me=this;if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{fieldLabel:i18n('i18n.PotentialCustManagerView.custSource'),xtype:'dpcombo',forceSelection:true,store:me.potentialCustData.getCustSourceStore(),queryMode:'local',displayField:'codeDesc',valueField:'code',name:'custbase',listeners:{scope:me,change:function(field,newValue){var me=this;if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactName'),allowBlank:false,blankText:i18n('i18n.PotentialCustEditView.message_conName'),listeners:{scope:me,keypress:me.enterKeyEvent,blur:me.potentialLinkmanNameBlurEvent},maxLength:20,name:'linkManName'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactPhone'),listeners:{scope:me,keypress:me.mobileEnterEvent,blur:me.validateMobile,change:me.mobileChangeEvent},regex:DpUtil.linkWayLimit('M'),name:'linkManMobile'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactTel'),name:'linkManPhone',regex:DpUtil.linkWayLimit('T'),emptyText:i18n('i18n.PotentialCustEditView.likeTelModel')},{fieldLabel:i18n('i18n.PotentialCustManagerView.position'),maxLength:20,name:'post'},{fieldLabel:i18n('i18n.PotentialCustManagerView.bizStatus'),xtype:'dpcombo',cls:'readonly',store:me.potentialCustData.getBusinessOpportunityStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',readOnly:true,name:'bussinesState'},{fieldLabel:i18n('i18n.PotentialCustEditView.city'),name:'cityName',value:CurrentCity.name,readOnly:true},{fieldLabel:i18n('i18n.PotentialCustEditView.address'),colspan:3,width:600,maxLength:100,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',100),name:'address'},{xtype:'hiddenfield',name:'city'}]}];return items;},getCity:function(){var me=this;var returnValue=Ext.create('Ext.form.ComboBox');var operateType='add';if('view'==me.parent.viewStatus){operateType='VIEW';}else if('update'==me.parent.viewStatus){operateType='UPDATE';}else if('add'==me.parent.viewStatus){operateType='ADD';}
returnValue=new AreaAddressCombox({'id':'city','fieldLabel':i18n('i18n.PotentialCustEditView.city'),'labelWidth':70,'width':200,'minWidth':200,'name':'city','operateType':operateType,'selectedValue':me.parent.potentialCustRecord.get('city'),'tabPanel':['provincePanel','cityPanel']});return returnValue;},changeEvent:function(field,newValue){var me=this;if(Ext.isEmpty(newValue)&&'dpcombo'==field.getXType()){field.setValue(null);}},mobileChangeEvent:function(text,newValue){if(newValue.length>11){text.setValue(newValue.substring(0,11));}},enterKeyEvent:function(field,event){if(event.getKey()==Ext.EventObject.ENTER){if(field.fieldLabel==i18n('i18n.PotentialCustManagerView.position')){field.next('textfield[fieldLabel=地址]').focus();}else if(field.fieldLabel==i18n('i18n.PotentialCustEditView.address')){var businessFieldset=this.up('basicpanel').next().down('basicformpanel').down('fieldset');if(businessFieldset){var companyName=businessFieldset.child('textfield[fieldLabel=最近合作物流公司]');if(companyName){companyName.focus();}}}else{field.next().focus();}}},potentialCustNameBlurEvent:function(potentialCustNameText){if(!DpUtil.isEmpty(potentialCustNameText.getValue())){var linkmanText=potentialCustNameText.next('textfield[fieldLabel=联系人姓名]');if(DpUtil.isEmpty(linkmanText.getValue())){linkmanText.setValue(potentialCustNameText.getValue());}}},potentialLinkmanNameBlurEvent:function(potentialLinkmanNameText){if(!DpUtil.isEmpty(potentialLinkmanNameText.getValue())){var potentialCustNameText=potentialLinkmanNameText.prev('textfield[fieldLabel=客户名称]');if(DpUtil.isEmpty(potentialCustNameText.getValue())){potentialCustNameText.setValue(potentialLinkmanNameText.getValue());}}},validateMobile:function(mobileText){var mobile=mobileText.getValue();if(!DpUtil.isEmpty(mobile)){if(mobile.length!=11){MessageUtil.showMessage(i18n('i18n.PotentialCustEditView.message_phoneMustLength'));mobileText.focus();}else if(!(/^1\d{10}$/.test(mobile))){MessageUtil.showMessage(i18n('i18n.PotentialCustEditView.message_phoneMustNo'));mobileText.focus();}else{mobileText.next().focus();}}else{mobileText.next().focus();}},mobileEnterEvent:function(field,event){if(event.getKey()==Ext.EventObject.ENTER){this.validateMobile(field);}}});Ext.define('PotentialCustBusinessInfoForm',{extend:'BasicFormPanel',layout:'fit',potentialCustData:null,items:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'fieldset',title:i18n('i18n.PotentialCustEditView.recentGoods'),defaults:{labelWidth:70,width:200,enableKeyEvents:true,listeners:{scope:me,keypress:me.enterKeyEvent,change:me.changeEvent}},layout:{type:'table',columns:3},items:[{fieldLabel:i18n('i18n.PotentialCustEditView.companyName'),xtype:'dpcombo',store:me.potentialCustData.getCoopertationCompanyStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'recentcoop',listeners:{scope:me,change:function(field,newValue){var me=this;if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{fieldLabel:i18n('i18n.PotentialCustManagerView.coopIntention'),xtype:'dpcombo',store:me.potentialCustData.getCoopertationIntensionStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'coopIntention',listeners:{scope:me,change:function(field,newValue){var me=this;if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{fieldLabel:i18n('i18n.PotentialCustManagerView.goodsPotential'),xtype:'dpcombo',store:me.potentialCustData.getGoodsPotentialStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'volumePotential',listeners:{scope:me,change:function(field,newValue){var me=this;if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{fieldLabel:i18n('i18n.PotentialCustEditView.goodsTrendCondition'),xtype:'textareafield',maxLength:200,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',200),name:'recentGoods'},{fieldLabel:i18n('i18n.PotentialCustEditView.custNeed'),xtype:'textareafield',colspan:2,width:400,maxLength:200,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',200),name:'custNeed'}]}];},changeEvent:function(field,newValue){var me=this;if(Ext.isEmpty(newValue)&&'dpcombo'==field.getXType()){field.setValue(null);}},enterKeyEvent:function(field,event){if(event.getKey()==Ext.EventObject.ENTER){if(field.next()){field.next().focus();}}}});
var potentialCustControl=Ext.create('PotentialCustData');Ext.define('PotentialCustDetailWindow',{extend:'PopWindow',title:i18n('i18n.PotentialCustEditView.potentialCustEditView'),tbar:null,potentialCustBasicInfo:null,potentialCustBusinessInfo:null,potentialCustPlanInfo:null,items:null,width:660,height:350,layout:'fit',viewStatus:null,potentialCustRecord:null,potentialCustData:potentialCustControl,potentialCustManagerView:null,isSavePotentialSuccess:false,initComponent:function(){var me=this;me.potentialCustBasicInfo=Ext.create('PotentialCustBasicDetailInfoForm',{'potentialCustData':me.potentialCustData,'parent':me});me.potentialCustBusinessInfo=Ext.create('PotentialCustDetailBusinessInfoForm',{'potentialCustData':me.potentialCustData});me.items=[{xtype:'basicformpanel',layout:'border',items:[{xtype:'basicpanel',region:'north',layout:'fit',height:135,items:[me.potentialCustBasicInfo]},{xtype:'basicpanel',region:'center',layout:'fit',items:[me.potentialCustBusinessInfo]}]}];this.on('beforeclose',this.beforeCloseEvent);this.callParent();me.controlComponentByViewStatus();},beforeCloseEvent:function(){},controlComponentByViewStatus:function(){var basicForm=this.down('basicformpanel');if(this.potentialCustRecord==null){MessageUtil.showMessage(i18n('i18n.PotentialCustEditView.incomingCustInfo'));}else{basicForm.getForm().loadRecord(this.potentialCustRecord);this.lockAllComponent();}},lockAllComponent:function(){var basicForm=this.down('basicformpanel');var mainForm=basicForm.getForm();mainForm.getFields().each(function(field){field.setReadOnly(true);});},unLockAllComponent:function(){var basicForm=this.down('basicformpanel');var mainForm=basicForm.getForm();mainForm.getFields().each(function(field){field.setReadOnly(false);});}});Ext.define('PotentialCustBasicDetailInfoForm',{extend:'BasicFormPanel',defaultType:'textfield',layout:'fit',potentialCustData:null,viewStatus:null,items:null,parent:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;var items=[{xtype:'fieldset',title:i18n('i18n.PotentialCustEditView.potentialCustInfo'),defaults:{labelWidth:70,width:200},layout:{type:'table',columns:3},defaultType:'textfield',items:[{fieldLabel:i18n('i18n.PotentialCustManagerView.customerName'),name:'custName'},{fieldLabel:i18n('i18n.PotentialCustManagerView.industry'),xtype:'dpcombo',store:me.potentialCustData.getIndustryStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'trade'},{fieldLabel:i18n('i18n.PotentialCustManagerView.custSource'),xtype:'dpcombo',forceSelection:true,store:me.potentialCustData.getCustSourceStore(),queryMode:'local',displayField:'codeDesc',valueField:'code',name:'custbase'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactName'),name:'linkManName'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactPhone'),name:'linkManMobile'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactTel'),name:'linkManPhone'},{fieldLabel:i18n('i18n.PotentialCustManagerView.position'),name:'post'},{fieldLabel:i18n('i18n.PotentialCustManagerView.bizStatus'),xtype:'dpcombo',store:me.potentialCustData.getBusinessOpportunityStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',readOnly:true,name:'bussinesState'},{fieldLabel:i18n('i18n.PotentialCustEditView.city'),name:'cityName',value:CurrentCity.name,readOnly:true},{fieldLabel:i18n('i18n.PotentialCustEditView.address'),colspan:3,width:600,name:'address'},{xtype:'hiddenfield',name:'city'}]}];return items;},getCity:function(){var me=this;var returnValue=new AreaAddressCombox({'id':'city','fieldLabel':i18n('i18n.PotentialCustEditView.city'),'labelWidth':70,'width':200,'minWidth':200,'name':'city','operateType':'VIEW','selectedValue':me.parent.potentialCustRecord.get('city'),'tabPanel':['provincePanel','cityPanel']});return returnValue;}});Ext.define('PotentialCustDetailBusinessInfoForm',{extend:'BasicFormPanel',layout:'fit',potentialCustData:null,items:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'fieldset',title:i18n('i18n.PotentialCustEditView.recentGoods'),defaults:{labelWidth:70,width:200},layout:{type:'table',columns:3},defaultType:'textfield',items:[{fieldLabel:i18n('i18n.PotentialCustEditView.companyName'),xtype:'dpcombo',store:me.potentialCustData.getCoopertationCompanyStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'recentcoop'},{fieldLabel:i18n('i18n.PotentialCustManagerView.coopIntention'),xtype:'dpcombo',store:me.potentialCustData.getCoopertationIntensionStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'coopIntention'},{fieldLabel:i18n('i18n.PotentialCustManagerView.goodsPotential'),xtype:'dpcombo',store:me.potentialCustData.getGoodsPotentialStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'volumePotential'},{fieldLabel:i18n('i18n.PotentialCustEditView.goodsTrendCondition'),xtype:'textareafield',name:'recentGoods'},{fieldLabel:i18n('i18n.PotentialCustEditView.custNeed'),xtype:'textareafield',colspan:2,width:400,name:'custNeed'}]}];}});Ext.define('PotentialCustPlanTab',{extend:'Ext.tab.Panel',layout:'fit',potentialCustData:null,items:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{title:i18n('i18n.PotentialCustDetailView.potentialCustomerReturnVisitRecord'),items:[new PotentialCustPlanVisitGrid()]},{title:i18n('i18n.PotentialCustDetailView.potentialCustomerScheduleRecord'),items:[new PotentialCustPlanProgrammeGrid()]}];}});Ext.define('PotentialCustPlanVisitGrid',{extend:'Ext.grid.Panel',layout:'fit',height:100,potentialCustData:null,columns:null,initComponent:function(){this.columns=this.getColumns();this.callParent();},getColumns:function(){var me=this;return[{header:i18n('i18n.PotentialCustManagerView.coopIntention'),dataIndex:''},{header:i18n('i18n.ManualRewardIntegralEditView.name'),dataIndex:''},{header:i18n('i18n.PotentialCustDetailView.planNum'),dataIndex:''},{header:i18n('i18n.PotentialCustDetailView.planName'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.goodsPotential'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.bizStatus'),dataIndex:''},{header:i18n('i18n.PotentialCustDetailView.executor'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.finalreviTime'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.reviTimes'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.programmeTime'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.createTime'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.lastUpdate'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.lastUpdateTime'),dataIndex:''}];}});Ext.define('PotentialCustPlanProgrammeGrid',{extend:'PopupGridPanel',layout:'fit',height:100,potentialCustData:null,columns:null,initComponent:function(){this.columns=this.getColumns();this.callParent();},getColumns:function(){var me=this;return[{header:i18n('i18n.PotentialCustManagerView.contactName'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.contactPhone'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.contactTel'),dataIndex:''},{header:i18n('i18n.PotentialCustDetailView.developmentOfTheme'),dataIndex:''},{header:i18n('i18n.PotentialCustDetailView.customerFeedback'),dataIndex:''},{header:i18n('i18n.PotentialCustDetailView.developmentTimeInfo'),dataIndex:''},{header:i18n('i18n.PotentialCustDetailView.developmentTime'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.creator'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.createTime'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.lastUpdate'),dataIndex:''},{header:i18n('i18n.PotentialCustManagerView.lastUpdateTime'),dataIndex:''}];}});
var PotentialCustSearchDataControl=new PotentialCustSearchData();Ext.define('PotentialCustManagerPanel',{extend:'BasicPanel',tbar:null,autoScroll:true,searchCondition:null,searchResult:null,potentialCust:null,buttonBar:null,items:null,layout:{type:'vbox',align:'stretch'},initComponent:function(){var me=this;var record=new PotentialCustConditionModel();me.searchCondition=new SearchConditionForm({'potentialCust':me.potentialCust,'record':record,'parent':me});me.searchCondition.loadRecord(record);me.searchResult=new SearchResultGrid({'potentialCust':me.potentialCust,'parent':me});me.buttonBar=me.getButtonBar();me.items=[{xtype:'basicpanel',height:110,items:[me.searchCondition]},{xtype:'basicpanel',height:36,items:[me.buttonBar]},{xtype:'basicpanel',flex:1,items:[me.searchResult]}];this.callParent();},getButtonBar:function(){var me=this;return new PotentialManageButtonPanel({'parent':me});},addNewPotential:function(){var newPotentialCust=Ext.create('PotentialCustModel');newPotentialCust.set('city',CurrentCity.id);newPotentialCust.set('cityName',CurrentCity.name);var potentialCustStore=this.potentialCust.getPotentialCustStore();var editPotentialWin=Ext.create('PotentialCustEditWindow',{'viewStatus':'add','potentialCustRecord':newPotentialCust,'potentialCustManagerView':this});editPotentialWin.show();},reloadPotentialCust:function(record,updateRecord){var me=this;var store=Ext.getCmp('searchPotentialCustResultGrid').store;if(!Ext.isEmpty(record)){record.set('createUser',top.User.empName);store.insert(store.getCount(),record);}else if(!Ext.isEmpty(updateRecord)){updateRecord.set('modifyUser',top.User.empName);updateRecord.set('modifyDate',new Date());}},cancelSavePotentialFn:function(record){var potentialCustStore=this.potentialCust.getPotentialCustStore();potentialCustStore.remove(record);},batchImportPotential:function(){Ext.create('UploadAttachmentWin',{'potentialCust':this.potentialCust}).show();},addNewVisit:function(){},exportPotientialToExcel:function(){}});Ext.define('SearchConditionForm',{extend:'SearchFormPanel',id:'searchPotentialCustConditionForm',parent:null,record:null,layout:{type:'table',columns:4},defaultType:'textfield',potentialCust:null,initComponent:function(){var me=this;potentialCust=me.potentialCust;me.defaults=me.getDefaultsContainer();me.items=[{fieldLabel:i18n('i18n.PotentialCustManagerView.customerName'),name:'customerName',maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20)},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactName'),name:'contactName',maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20)},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactPhone'),name:'contactPhone',regex:DpUtil.linkWayLimit('M')},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactTel'),name:'contactTel',regex:DpUtil.linkWayLimit('T')},{fieldLabel:i18n('i18n.PotentialCustManagerView.industry'),name:'industry',xtype:'combobox',store:me.potentialCust.getIndustryStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code'},{fieldLabel:i18n('i18n.PotentialCustManagerView.coopIntention'),name:'coopIntention',xtype:'combobox',store:me.potentialCust.getCoopertationIntensionStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code'},{fieldLabel:i18n('i18n.PotentialCustManagerView.custSource'),name:'custSource',xtype:'combobox',store:me.potentialCust.getCustSourceStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code'},{fieldLabel:i18n('i18n.PotentialCustManagerView.bizStatus'),name:'bizStatus',xtype:'combobox',store:me.potentialCust.getBusinessOpportunityStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code'},{fieldLabel:i18n('i18n.PotentialCustManagerView.goodsPotential'),name:'goodsPotential',xtype:'combobox',store:me.potentialCust.getGoodsPotentialStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code'},{fieldLabel:i18n('i18n.PotentialCustManagerView.position'),name:'position',maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20)},{xtype:'fieldcontainer',colspan:2,border:0,width:400,layout:'column',defaultType:'datefield',defaults:{enableKeyEvents:true,listeners:{scope:me,keypress:me.keypressEvent,change:me.changeEvent}},items:[{fieldLabel:i18n('i18n.PotentialCustManagerView.searchStartTime'),labelWidth:65,width:200,format:'Y-m-d',maxValue:new Date(),name:'searchStartTime'},{xtype:'displayfield',width:10,value:i18n('i18n.PotentialCustManagerView.searchEndTime')},{xtype:'datefield',width:130,format:'Y-m-d',name:'searchEndTime',maxValue:new Date()}]}];this.callParent();},getDefaultsContainer:function(){var me=this;return{labelWidth:65,width:195,enableKeyEvents:true,listeners:{scope:me,keypress:me.keypressEvent,change:me.changeEvent}};},keypressEvent:function(field,event){var me=this;if(event.getKey()==Ext.EventObject.ENTER){me.searchPotentialCustomerList();}},changeEvent:function(field,newValue){var me=this;if('combobox'==field.getXType()&&Ext.isEmpty(newValue)){field.setValue(null);}},checkDataOpposite:function(){var me=this;var form=this.getForm();var objPre=form.findField('searchStartTime');var objNext=form.findField('searchEndTime');if((DpUtil.isEmpty(objPre.getValue())&&DpUtil.isEmpty(objNext.getValue()))){return true;}
if(!DpUtil.isEmpty(objPre.getValue())&&!DpUtil.isEmpty(objNext.getValue())){if(objPre.getValue()<=objNext.getValue()){if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()==0){var monthsPre=objNext.getValue().getMonth()-objPre.getValue().getMonth();if(monthsPre<=3&&monthsPre>=0){if(monthsPre==3){if(objNext.getValue().getDate()-objPre.getValue().getDate()>0){return false;}else{return true;}}
return true;}}
if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()==1){var monthsNext=objNext.getValue().getMonth()-objPre.getValue().getMonth()+12;if(monthsNext>=0&&monthsNext<=3){if(monthsNext==3){if(objNext.getValue().getDate()-objPre.getValue().getDate()>0){return false;}else{return true;}}
return true;}}}}
return false;},getCurrentDay:function(month){var currentMonth=month+1;if(currentMonth==1||currentMonth==3||currentMonth==5||currentMonth==7||currentMonth==8||currentMonth==10||currentMonth==12){return 31;}else if(currentMonth==2){return 28;}else{return 30;}},searchPotentialCustomerList:function(me){if(Ext.isEmpty(me)){me=this;}
if(!me.validateCondition()){Ext.MessageBox.alert(i18n('i18n.PotentialCustManagerView.message'),i18n('i18n.PotentialCustManagerView.message_notNull'));return;}
var checkDataInOneYearResult=DpUtil.checkDataInOneYear(me.getForm().findField('searchStartTime'),me.getForm().findField('searchEndTime'));if(!checkDataInOneYearResult.success){Ext.MessageBox.alert(i18n('i18n.PotentialCustManagerView.message'),checkDataInOneYearResult.message);return;}
if(!me.getForm().isValid()){Ext.MessageBox.alert(i18n('i18n.PotentialCustManagerView.message'),i18n('i18n.PotentialCustManagerView.message_warn'));return;}
Ext.getCmp('searchPotentialCustResultGrid').store.loadPage(1);},validateCondition:function(){var me=this;var flag=false;me.getForm().getFields().each(function(field){if(!(DpUtil.isEmpty(field.getValue()))&&field.getValue()!=i18n('i18n.PotentialCustManagerView.searchEndTime')){flag=true;}});return flag;}});Ext.define('PotentialManageButtonPanel',{extend:'NormalButtonPanel',parent:null,items:null,parent:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'leftbuttonpanel',width:510,items:[{text:i18n('i18n.PotentialCustManagerView.add'),hidden:!isPermission('/customer/PotentialABtn.action'),xtype:'button',scope:me.parent,handler:me.parent.addNewPotential},{text:i18n('i18n.PotentialCustManagerView.update'),hidden:!isPermission('/customer/PotentialUBtn.action'),xtype:'button',scope:me.parent.searchResult,handler:me.parent.searchResult.updatePotential},{text:i18n('i18n.PotentialCustManagerView.delete'),hidden:!isPermission('/customer/PotentialDBtn.action'),xtype:'button',scope:me.parent.searchResult,handler:me.parent.searchResult.delPotential},{text:i18n('i18n.PotentialCustManagerView.batchImport'),hidden:!isPermission('/customer/PotentialMassImportBtn.action'),xtype:'button',scope:me.parent,handler:me.parent.batchImportPotential},{text:i18n('i18n.PotentialCustManagerView.viewDetails'),hidden:!isPermission('/customer/PotentialVBtn.action'),xtype:'button',scope:me.searchResult,handler:function(){var grid=Ext.getCmp('searchPotentialCustResultGrid');selection=grid.getSelectionModel().getSelection();if(selection.length!=1){MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.operation_message'));return;}
me.parent.searchResult.lookPotentialCustDetail(grid,selection[0]);}},{text:i18n('i18n.PotentialCustManagerView.downLoadTemp'),hidden:!isPermission('/customer/PotentialDowloadBtn.action'),xtype:'button',scope:me,handler:me.downloadTemplate},{text:i18n('i18n.PotentialCustManagerView.visitLog'),xtype:'button',scope:me.parent,hidden:true,handler:me.parent.addNewVisit}]},{xtype:'middlebuttonpanel'},{xtype:'rightbuttonpanel',width:150,items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.search'),hidden:!isPermission('/customer/PotentialSBtn.action'),width:70,scope:me.parent.searchCondition,handler:function(){me.parent.searchCondition.searchPotentialCustomerList();}}]}];},downloadTemplate:function(){var me=this;me.parent.potentialCust.downloadTemplate(window);}});Ext.define('SearchResultGrid',{extend:'BasicPanel',potentialCust:null,store:null,items:null,autoScroll:true,parent:null,initComponent:function(){var me=this;var potentialCustModel=new PotentialCustModel();me.store=me.potentialCust.initialPotentialCustStore(me.beforeLoadPotentialFn);me.items=[{xtype:'searchgridpanel',id:'searchPotentialCustResultGrid',store:me.store,autoScroll:true,selModel:Ext.create('Ext.selection.CheckboxModel'),columns:[Ext.create('Ext.grid.RowNumberer'),{header:'id',dataIndex:'id',hidden:true},{header:i18n('i18n.PotentialCustManagerView.coopIntention'),dataIndex:'coopIntention',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.COOPERATION_INTENTION);}},{header:i18n('i18n.PotentialCustManagerView.customerName'),dataIndex:'custName'},{header:i18n('i18n.PotentialCustManagerView.contactName'),dataIndex:'linkManName'},{header:i18n('i18n.PotentialCustManagerView.contactPhone'),dataIndex:'linkManMobile'},{header:i18n('i18n.PotentialCustManagerView.contactTel'),dataIndex:'linkManPhone'},{header:i18n('i18n.PotentialCustManagerView.position'),dataIndex:'post'},{header:i18n('i18n.PotentialCustManagerView.goodsPotential'),dataIndex:'volumePotential',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.CARGO_POTENTIAL);}},{header:i18n('i18n.PotentialCustManagerView.bizStatus'),dataIndex:'bussinesState',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.BUSINESS_STATUS);}},{header:i18n('i18n.PotentialCustManagerView.industry'),dataIndex:'trade',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.TRADE);}},{header:i18n('i18n.PotentialCustManagerView.custSource'),dataIndex:'custbase',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.CUST_SOURCE);}},{header:i18n('i18n.PotentialCustManagerView.developState'),dataIndex:'developState',hidden:true,renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.DEVELOP_STATUS);}},{header:i18n('i18n.PotentialCustManagerView.finalreviTime'),dataIndex:'finalreviTime',hidden:true,renderer:function(value){return DpUtil.renderDate(value);}},{header:i18n('i18n.PotentialCustManagerView.reviTimes'),dataIndex:'reviTimes',hidden:true},{header:i18n('i18n.PotentialCustManagerView.programmeTime'),dataIndex:'programmeTime',hidden:true,renderer:function(value){return DpUtil.renderDate(value);}},{header:i18n('i18n.PotentialCustManagerView.creator'),dataIndex:'createUser'},{header:i18n('i18n.PotentialCustManagerView.createTime'),dataIndex:'createDate',renderer:function(value){return DpUtil.renderDate(value);}},{header:i18n('i18n.PotentialCustManagerView.lastUpdate'),dataIndex:'modifyUser'},{header:i18n('i18n.PotentialCustManagerView.lastUpdateTime'),dataIndex:'modifyDate',renderer:function(value){return DpUtil.renderDate(value);}}],dockedItems:[{xtype:'pagingtoolbar',store:me.store,dock:'bottom',displayInfo:true}],listeners:{scope:me,itemdblclick:me.lookPotentialCustDetail}}];this.callParent();},beforeLoadPotentialFn:function(store,operation,eOpts){var searchPotentialForm=Ext.getCmp("searchPotentialCustConditionForm");if(searchPotentialForm!=null){searchPotentialForm.getForm().updateRecord(searchPotentialForm.record);var potentialCustomerCondition=searchPotentialForm.record.data;var searchParams={'potentialCustomerCondition.customerName':potentialCustomerCondition.customerName,'potentialCustomerCondition.contactName':potentialCustomerCondition.contactName,'potentialCustomerCondition.contactPhone':potentialCustomerCondition.contactPhone,'potentialCustomerCondition.contactTel':potentialCustomerCondition.contactTel,'potentialCustomerCondition.industry':potentialCustomerCondition.industry,'potentialCustomerCondition.coopIntention':potentialCustomerCondition.coopIntention,'potentialCustomerCondition.custSource':potentialCustomerCondition.custSource,'potentialCustomerCondition.bizStatus':potentialCustomerCondition.bizStatus,'potentialCustomerCondition.goodsPotential':potentialCustomerCondition.goodsPotential,'potentialCustomerCondition.searchStartTime':potentialCustomerCondition.searchStartTime,'potentialCustomerCondition.searchEndTime':potentialCustomerCondition.searchEndTime,'potentialCustomerCondition.position':potentialCustomerCondition.position};Ext.apply(operation,{params:searchParams});}},updatePotential:function(){var me=this;var grid=Ext.getCmp('searchPotentialCustResultGrid');;selection=grid.getSelectionModel().getSelection();if(selection.length!=1){MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.operation_message'));return;}else{var editPotentialWin=Ext.create('PotentialCustEditWindow',{'viewStatus':'update','potentialCustRecord':selection[0],'potentialCustManagerView':me.parent});editPotentialWin.show();}},delPotential:function(){var me=this;var grid=Ext.getCmp('searchPotentialCustResultGrid');selection=grid.getSelectionModel().getSelection();if(selection.length==0){MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.operation_messages'));return;}
MessageUtil.showQuestionMes(i18n('i18n.PotentialCustManagerView.confirm_message'),function(e){if(e=='yes'){var potentialCustIds=new Array();for(var j=0;j<selection.length;j++){potentialCustIds.push(selection[j].get('id'))}
var delSuccess=function(response){var grid=Ext.getCmp('searchPotentialCustResultGrid');var form=Ext.getCmp('searchPotentialCustConditionForm');MessageUtil.showInfoMes(i18n('i18n.PotentialCustManagerView.deleteSuccess'));Ext.getCmp('searchPotentialCustResultGrid').store.loadPage(1);};var delFail=function(response){MessageUtil.showErrorMes(response.message);};var params={};params.potentialCustIds=potentialCustIds;me.potentialCust.deletePotentialCustomer(params,delSuccess,delFail);}});},lookPotentialCustDetail:function(grid,record){var win=Ext.create('PotentialCustDetailWindow',{potentialCustRecord:record});win.show();}});Ext.define('MassImportButtonPanel',{extend:'PopButtonPanel',parent:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'popleftbuttonpanel',items:[{xtype:'button',scope:me.parent,text:i18n('i18n.PotentialCustManagerView.validatDate'),handler:me.parent.validateCustData},{xtype:'button',scope:me.parent,text:i18n('i18n.PotentialCustManagerView.removeInvalidData'),handler:me.parent.removeInvalidData}]},{xtype:'middlebuttonpanel'}];}});Ext.define('MassImportResultGrid',{extend:'PopupGridPanel',id:'massImportResultGridId',parent:null,initComponent:function(){var me=this;me.store=me.parent.potentialCust.getImportCustStore();me.columns=me.getColumns();this.callParent();},getColumns:function(){var me=this;return[{text:i18n('i18n.PotentialCustManagerView.importFailReason'),dataIndex:'message'},{text:i18n('i18n.PotentialCustManagerView.custName'),dataIndex:'custName'},{text:i18n('i18n.PotentialCustManagerView.industry'),dataIndex:'trade'},{text:i18n('i18n.PotentialCustManagerView.custSource'),dataIndex:'custbase'},{text:i18n('i18n.PotentialCustManagerView.contactName'),dataIndex:'linkManName'},{text:i18n('i18n.PotentialCustManagerView.contactPhone'),dataIndex:'linkManMobile'},{text:i18n('i18n.PotentialCustManagerView.contactTel'),dataIndex:'linkManPhone'},{text:i18n('i18n.PotentialCustManagerView.position'),dataIndex:'post'},{text:i18n('i18n.PotentialCustEditView.companyName'),dataIndex:'recentcoop'},{text:i18n('i18n.PotentialCustManagerView.coopIntention'),dataIndex:'coopIntention'},{text:i18n('i18n.PotentialCustManagerView.goodsPotential'),dataIndex:'volumePotential'},{text:i18n('i18n.PotentialCustEditView.custNeed'),dataIndex:'custNeed'}];}});Ext.define('ExcelImportUI',{extend:'PopWindow',title:i18n('i18n.PotentialCustManagerView.fileImport'),layout:'fit',buttonBar:null,massImportResultGrid:null,width:700,height:400,layout:{type:'vbox',align:'stretch'},potentialCust:null,initComponent:function(){var me=this;me.buttonBar=Ext.create('MassImportButtonPanel',{'parent':me});me.massImportResultGrid=Ext.create('MassImportResultGrid',{'parent':me});me.fbar=me.getFbar();me.items=me.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'basicformpanel',height:30,items:[{xtype:'filefield',fieldLabel:i18n('i18n.PotentialCustManagerView.filePosition'),buttonText:i18n('i18n.PotentialCustManagerView.fileSelect'),name:'fileName',id:'fileId',labelWidth:65,listeners:{scope:me,change:me.changeFile}}]},{xtype:'basicpanel',height:36,items:[me.buttonBar]},{xtype:'basicpanel',flex:1,items:[me.massImportResultGrid]}];},getFbar:function(){var me=this;return[{xtype:'button',scope:me,text:i18n('i18n.PotentialCustEditView.save'),handler:me.saveImportData}];},changeFile:function(file,value){if(!DpUtil.isEmpty(value)){var me=this;me.potentialCust.getImportCustStore().removeAll();var pattern=/^.+?\.(xls|xlsx)$/;var grid=Ext.getCmp('massImportResultGridId');var isIE=true;var oXL;var oWB;try{oXL=new ActiveXObject("Excel.application");oWB=oXL.Workbooks.open(value);}catch(error){isIE=false;MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.mustBeIe'));}
if(isIE){if(pattern.test(value)){var oSheet=oWB.ActiveSheet;var rows=oSheet.usedrange.rows.count;var columns=oSheet.usedrange.columns.count;if(rows>100){MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.importFailMoreDate'));}else{var isSameHeader=me.validateExcelHead(grid,oSheet,columns);if(isSameHeader){var count=0;for(var i=2;i<=rows;i++){var importCustDataModel=this.createImportCustDataModelFromExcel(grid,oSheet,i,columns);importCustDataModel.set('rowNum',++count);me.potentialCust.getImportCustStore().insert(0,importCustDataModel);}}else{MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.importFailModelWrong'));}}}else{MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.selectExcel'));}
oXL.Quit();}}},createImportCustDataModelFromExcel:function(grid,excel,row,columnLength){var importCustDataModel=new ImportCustDataModel();for(var j=1;j<=columnLength;j++){this.setValueToModel(grid,excel,importCustDataModel,row,j);}
return importCustDataModel;},setValueToModel:function(grid,excel,importCustDataModel,rowIndex,columnIndex){var me=this;var gridColumns=grid.columns;var gridText=gridColumns[columnIndex].text;var cellValue=excel.Cells(rowIndex,columnIndex).value;if(!DpUtil.isEmpty(cellValue)){if(gridText==i18n('i18n.PotentialCustManagerView.custName')){importCustDataModel.set('custName',cellValue);}else if(gridText==i18n('i18n.PotentialCustManagerView.industry')){importCustDataModel.set('trade',cellValue);}else if(gridText==i18n('i18n.PotentialCustManagerView.custSource')){importCustDataModel.set('custbase',cellValue);}else if(gridText==i18n('i18n.PotentialCustManagerView.contactName')){importCustDataModel.set('linkManName',cellValue);}else if(gridText==i18n('i18n.PotentialCustManagerView.contactPhone')){importCustDataModel.set('linkManMobile',cellValue.toString());}else if(gridText==i18n('i18n.PotentialCustManagerView.contactTel')){importCustDataModel.set('linkManPhone',cellValue.toString());}else if(gridText==i18n('i18n.PotentialCustManagerView.position')){importCustDataModel.set('post',cellValue);}else if(gridText==i18n('i18n.PotentialCustManagerView.companyName')){importCustDataModel.set('recentcoop',cellValue);}else if(gridText==i18n('i18n.PotentialCustManagerView.coopIntention')){importCustDataModel.set('coopIntention',cellValue);}else if(gridText==i18n('i18n.PotentialCustManagerView.goodsPotential')){importCustDataModel.set('volumePotential',cellValue);}else if(gridText==i18n('i18n.PotentialCustEditView.custNeed')){importCustDataModel.set('custNeed',cellValue);}}},validateExcelHead:function(grid,excel,columnSize){var gridColumns=grid.columns;if(gridColumns.length-1>columnSize){return false;}else{for(var i=1;i<gridColumns.length;i++){var columnName=gridColumns[i].text;var excelName=excel.Cells(1,i).value;if(columnName!=excelName){return false;}}
return true;}},validateCustData:function(){var me=this;var importStore=me.potentialCust.getImportCustStore();var isValidatePast=true;for(var i=0;i<importStore.data.length;i++){for(var j=i+1;j<importStore.data.length;j++){var mobile1=importStore.getAt(i).get('linkManMobile');var phone1=importStore.getAt(i).get('linkManPhone');var linkmanName1=importStore.getAt(i).get('linkManName');var custName1=importStore.getAt(i).get('custName');var custbase1=importStore.getAt(i).get('custbase');var trade1=importStore.getAt(i).get('trade');var post1=importStore.getAt(i).get('post');var recentcoop1=importStore.getAt(i).get('recentcoop');var coopIntention1=importStore.getAt(i).get('coopIntention');var volumePotential1=importStore.getAt(i).get('volumePotential');var custNeed1=importStore.getAt(i).get('custNeed');var mobile2=importStore.getAt(j).get('linkManMobile');var phone2=importStore.getAt(j).get('linkManPhone');var linkmanName2=importStore.getAt(j).get('linkManName');var custName2=importStore.getAt(j).get('custName');var custbase2=importStore.getAt(j).get('custbase');var trade2=importStore.getAt(j).get('trade');var post2=importStore.getAt(j).get('post');var recentcoop2=importStore.getAt(j).get('recentcoop');var coopIntention2=importStore.getAt(j).get('coopIntention');var volumePotential2=importStore.getAt(j).get('volumePotential');var custNeed2=importStore.getAt(j).get('custNeed');if(mobile1==mobile2&&phone1==phone2&&linkmanName1==linkmanName2&&custName1==custName2&&custbase1==custbase2&&trade1==trade2&&post1==post2&&recentcoop1==recentcoop2&&coopIntention1==coopIntention2&&volumePotential1==volumePotential2&&custNeed1==custNeed2){importStore.getAt(i).set('message',i18n('i18n.PotentialCustEditView.twoMessageSame',[j]));importStore.getAt(j).set('message',i18n('i18n.PotentialCustEditView.twoMessageSame',[i]));isValidatePast=false;}}}
if(isValidatePast==false){return isValidatePast;}
importStore.each(function(record){var mobile=record.get('linkManMobile');var phone=record.get('linkManPhone');var linkmanName=record.get('linkManName');var custName=record.get('custName');if(DpUtil.isEmpty(linkmanName)||DpUtil.isEmpty(custName)){record.set('validatePast',false);record.set('message',i18n('i18n.PotentialCustManagerView.message_nameBothTrue'));isValidatePast=false;}else if(DpUtil.isEmpty(mobile)&&DpUtil.isEmpty(phone)){record.set('validatePast',false);record.set('message',i18n('i18n.PotentialCustEditView.message_phoneBothTrue'));isValidatePast=false;}else if(!DpUtil.isEmpty(phone)&&/^((\d{7,8})|(\d{4}|\d{3})-(\d{7,8})|(\d{4}|\d{3})-(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1}))$/.test(phone)){record.set('message',i18n('i18n.PotentialCustManagerView.phoneNotRegul'));isValidatePast=false;}else if(!DpUtil.isEmpty(mobile)&&(mobile.length!=11||!(/^1[3|5|8][0-9]\d{4,8}$/.test(mobile)))){record.set('validatePast',false);record.set('message',i18n('i18n.PotentialCustEditView.message_phoneMustLength'));isValidatePast=false;}});return isValidatePast;},removeInvalidData:function(){var me=this;var importStore=me.potentialCust.getImportCustStore();importStore.each(function(record){if(!record.get('validatePast')){importStore.remove(record);}});},saveImportData:function(btn){var me=this;var grid=Ext.getCmp('massImportResultGridId');if(grid.store.data.length<=0){MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.message_selectFile'));return;}
if(me.validateCustData()){var params=me.assembleBatchData();var successImportFn=function(result){var importDataList=result.batchImportCustData;var importStore=me.potentialCust.getImportCustStore();for(var i=0;i<importDataList.length;i++){var record=importStore.findRecord('rowNum',importDataList[i].rowNum);if(!importDataList[i].importSuccess){record.set('message',importDataList[i].message);record.set('importSuccess',importDataList[i].importSuccess);}else{importStore.remove(record);}}
var showMsg=i18n('i18n.PotentialCustManagerView.importPotentialCustSuccess');if(importStore.getCount()>0){showMsg=i18n('i18n.PotentialCustManagerView.importFailDateShow');}
MessageUtil.showMessage(showMsg);Ext.getCmp('fileId').reset();};var failImportFn=function(result){MessageUtil.showMessage(result.message);Ext.getCmp('fileId').reset();};me.potentialCust.batchImportPotentialCust(params,successImportFn,failImportFn);}else{MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.importFailValidateFalil'));}},assembleBatchData:function(){var me=this;var params={};var tempArray=new Array();me.potentialCust.getImportCustStore().each(function(record){var tempObject={};tempObject.rowNum=record.get('rowNum');var tempRecord=record.copy();me.changeRecordDictionary(tempRecord);tempObject.potentialCustomer=tempRecord.data;tempArray.push(tempObject);});params.batchImportCustData=tempArray;return params;},changeRecordDictionary:function(record){var me=this;if(!DpUtil.isEmpty(record.get('trade'))){var dictionaryValue=DpUtil.changeDictionaryDescipToCode(me.potentialCust.getIndustryStore(),record.get('trade'));record.set('trade',dictionaryValue);}
if(!DpUtil.isEmpty(record.get('custbase'))){var dictionaryValue=DpUtil.changeDictionaryDescipToCode(me.potentialCust.getCustSourceStore(),record.get('custbase'));record.set('custbase',dictionaryValue);}
if(!DpUtil.isEmpty(record.get('recentcoop'))){var dictionaryValue=DpUtil.changeDictionaryDescipToCode(me.potentialCust.getCoopertationCompanyStore(),record.get('recentcoop'));record.set('recentcoop',dictionaryValue);}
if(!DpUtil.isEmpty(record.get('coopIntention'))){var dictionaryValue=DpUtil.changeDictionaryDescipToCode(me.potentialCust.getCoopertationIntensionStore(),record.get('coopIntention'));record.set('coopIntention',dictionaryValue);}
if(!DpUtil.isEmpty(record.get('volumePotential'))){var dictionaryValue=DpUtil.changeDictionaryDescipToCode(me.potentialCust.getGoodsPotentialStore(),record.get('volumePotential'));record.set('volumePotential',dictionaryValue);}}});Ext.define('UploadAttachmentWin',{extend:'PopWindow',title:i18n('i18n.PotentialCustManagerView.messageTip'),layout:{type:'vbox',align:'stretch'},width:400,height:150,potentialCust:null,initComponent:function(){var me=this;me.items=[{xtype:'titlepanel',items:[{xtype:'displayfield',value:i18n('i18n.PotentialCustManagerView.pleaseInputDiverAttachment'),width:100}]},{xtype:'basicformpanel',flex:1,layout:{type:'hbox'},defaults:{margins:'0 5 0 0'},items:[{xtype:'filefield',name:'file',fieldLabel:'导入文件',labelWidth:60,buttonText:i18n('i18n.ChangeContactAffiliatedRelationView.view'),flex:3},{text:i18n('i18n.ContractEditView.contractId'),name:'sourceId',xtype:'hiddenfield'},{text:i18n('i18n.ChangeContactAffiliatedRelationView.sourceType'),name:'type',xtype:'hiddenfield',value:'EXCEL'}]}];me.fbar=me.getFbar();this.callParent();},getFbar:function(){var me=this;return[{text:i18n('i18n.ChangeContactAffiliatedRelationView.button_upload'),xtype:'button',scope:me,handler:me.uploadFile},{text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),xtype:'button',handler:function(){me.close();}}];},uploadFile:function(){var me=this;var form=me.down('form');form.submit({url:'importPentent.action',waitMsg:i18n('i18n.PotentialCustManagerView.diverImportingPleaseWait'),success:function(form,response){var result=response.result;if(result.success){var message=result.message;var warnWin=null;me.close();warnWin=Ext.create('Ext.window.Window',{title:i18n('i18n.PotentialCustManagerView.theEndOfImport'),width:305,height:150,cls:'warningwin',layout:'fit',items:[{xtype:'textareafield',value:message,readOnly:true}],dockedItems:[{xtype:'toolbar',dock:'bottom',ui:'footer',layout:{pack:'center'},items:[{xtype:'component',flex:1},{xtype:'button',text:'确定',handler:function(){warnWin.close();}}]}]});warnWin.show();}else{MessageUtil.showMessage(result.message);me.close();}},failure:function(form,response){var result=response.result;if(!result.success){MessageUtil.showMessage(result.message);}}});}});Ext.onReady(function(){var successFn=function(response){CurrentCity=response.currentCity;};var failFn=function(response){MessageUtil.showMessage(response.message);};PotentialCustSearchDataControl.acquireDeptCity({},successFn,failFn);Ext.create('Ext.Viewport',{layout:{type:'fit'},items:[Ext.create('PotentialCustManagerPanel',{'potentialCust':PotentialCustSearchDataControl})]});});