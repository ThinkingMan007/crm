Ext.JSON.encodeDate=function(d){return d.getTime();};String.prototype.replaceAll=function(AFindText,ARepText){raRegExp=new RegExp(AFindText,"g");return this.replace(raRegExp,ARepText);};DpUtil=function(){};DpUtil.isEmpty=function(str){return Ext.isEmpty(str);};DpUtil.requestJsonAjax=function(url,params,successFn,failFn,timeout)
{Ext.Ajax.request({url:url,jsonData:params,timeout:(Ext.isEmpty(timeout))?600000:timeout,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.requestJsonAjaxSync=function(url,params,successFn,failFn,timeout)
{Ext.Ajax.request({url:url,async:false,jsonData:params,timeout:(Ext.isEmpty(timeout))?600000:timeout,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.requestFileUploadAjax=function(url,form,successFn,failFn)
{Ext.Ajax.request({url:url,form:form,isUpload:true,success:function(form,action){var result=action.result;if(result.success){successFn(result);}else{failFn(result);}},failure:function(form,action){var result=action.result;failFn(result);}});};DpUtil.requestAjax=function(url,params,successFn,failFn)
{Ext.Ajax.request({url:url,params:params,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});};DpUtil.changeLongToDate=function(value){if(value!=null){var date=new Date(value);return date;}else{return null;}};DpUtil.renderDate=function(value){if(value!=null){return Ext.Date.format(new Date(value),'Y-m-d');}else{return null;}};DpUtil.changeDictionaryDescipToCode=function(store,descrip){var record=store.findRecord('codeDesc',descrip);if(!DpUtil.isEmpty(record)){return record.get('code');}else{return"";}};DpUtil.changeDictionaryCodeToDescrip=function(value,dataDictionary){if(value!=null&&dataDictionary!=null){for(var i=0;i<dataDictionary.length;i++){if(value==dataDictionary[i].code){return dataDictionary[i].codeDesc;}}}else{return null;}};DpUtil.changeBooleanToDescrip=function(value){if(value==false){return i18n('i18n.ChangeContactAffiliatedRelationView.no');}else if(value==true){return i18n('i18n.ChangeContactAffiliatedRelationView.yes');}
return null;};DpUtil.changeIntToDescrip=function(value){if(value==0){return i18n('i18n.ChangeContactAffiliatedRelationView.no');}else if(value==1){return i18n('i18n.ChangeContactAffiliatedRelationView.yes');}
return null;};DpUtil.changeNullToEmptyString=function(value){if(value==null){return'';}else{return value}};DpUtil.compareRecordFieldIsChange=function(oldValue,newValue){if(oldValue==newValue){return false;}else if(DpUtil.changeNullToEmptyString(oldValue)==DpUtil.changeNullToEmptyString(newValue)){return false;}else{return true;}};DpUtil.keyPress=function(e,getData,param,limit,successFn){var paramValue=e.target.value;if(Ext.isEmpty(paramValue)){return;}
if(paramValue.length<limit){return;}
if(e.getKey()==Ext.EventObject.ENTER&&paramValue!=""&&paramValue.length>=limit)
{var failureFn=function(json){DpUtil.showMessage(json.message);};getData(param,successFn,failureFn);}};DpUtil.showMessage=function(meaage){top.Ext.MessageBox.alert(i18n('i18n.PotentialCustManagerView.message'),meaage);};DpUtil.showConfimMessageBox=function(msg,message,yesFn,noFn){Ext.MessageBox.confirm(msg,message,function(e){if(e=='yes'){yesFn;}else{noFn;}});};DpUtil.createStore=function(storeId,model,fields,data){var store=Ext.data.StoreManager.lookup(storeId);if(Ext.isEmpty(data)){data=[];}
if(!Ext.isEmpty(model)){if(store===undefined){store=Ext.create('Ext.data.Store',{storeId:storeId,model:model,data:data});}}
if(!Ext.isEmpty(fields)){if(store===undefined){store=Ext.create('Ext.data.Store',{storeId:storeId,fields:fields,data:data});}}
return store;};DpUtil.changeLongToDate=function(value){if(value!=null){var date=new Date(value);return date;}else{return null;}};DpUtil.trimString=function(value){if(!Ext.isEmpty(value)){return value.trim();}
return value;};DpUtil.createDateCombo=function(fieldLabel,name,store,allowBlank,readOnly,labelWidth,width,blankText,changEvent){var fn=function(){};var chang=function(field,newValue){if(Ext.isEmpty(newValue)){field.setValue(null);}};var combo=Ext.create('Ext.form.ComboBox',{fieldLabel:fieldLabel,xtype:'combobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',allowBlank:allowBlank,readOnly:readOnly,name:name,labelWidth:labelWidth,width:width,store:store,blankText:blankText,listeners:{change:(changEvent==null)?fn:((changEvent==true)?chang:changEvent)}});return combo;};Ext.define('DpComboBox',{extend:'Ext.form.ComboBox',alias:['widget.dpcombobox','widget.dpcombo'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpNumberField',{extend:'Ext.form.Number',alias:['widget.dpnumberfield','widget.dpnumber'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpDateField',{extend:'Ext.form.Date',alias:['widget.dpdatefield','widget.dpdate'],setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});Ext.define('DpTimeField',{extend:'Ext.form.Time',alias:'widget.dpdtimefield',setReadOnly:function(readOnly){this.callParent(arguments);if(readOnly){this.addCls('readonly');}else{this.removeCls('readonly');}}});DpUtil.getCurrentMonthDays=function(month){var currentMonth=month+1;switch(currentMonth){case 1:case 3:case 5:case 7:case 8:case 10:case 12:return 31;break;case 2:return 28;break;default:return 30;break;　　}}
DpUtil.keyPress=function(e,getData,param,limit,successFn){var paramValue=e.target.value;if(Ext.isEmpty(paramValue)){return;}
if(paramValue.length<limit){return;}
if(e.getKey()==Ext.EventObject.ENTER&&paramValue!=""&&paramValue.length>=limit)
{var failureFn=function(json){DpUtil.showMessage(json.message);};getData(param,successFn,failureFn);}};DpUtil.checkDataInOneYear=function(objPre,objNext){var success=true;var message='';if((DpUtil.isEmpty(objPre.getValue())||DpUtil.isEmpty(objNext.getValue()))){var success=false;var message=i18n('i18n.DpUtil.d_notAllDateNull');}else if(!DpUtil.isEmpty(objPre.getValue())&&!DpUtil.isEmpty(objNext.getValue())){if(objPre.getValue()>objNext.getValue()){var success=false;var message=i18n('i18n.DpUtil.d_startNotBigger');}else{if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()<=1){if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()==1){var monthsNext=objNext.getValue().getMonth()-objPre.getValue().getMonth()+12;if(monthsNext<=12){if(monthsNext==12){if(objNext.getValue().getDate()>objPre.getValue().getDate()){var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}else{var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}else{var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}
return{success:success,message:message};}
DpUtil.checkDataInOneYear1=function(year,month,day){var data=new Date();data.setYear(new Date().getYear()+year);data.setYear(new Date().getMonth()+month);data.setYear(new Date().getDay()+day);if((DpUtil.isEmpty(objPre.getValue())||DpUtil.isEmpty(objNext.getValue()))){var success=false;var message=i18n('i18n.DpUtil.d_notAllDateNull');}else if(!DpUtil.isEmpty(objPre.getValue())&&!DpUtil.isEmpty(objNext.getValue())){if(objPre.getValue()>objNext.getValue()){var success=false;var message=i18n('i18n.DpUtil.d_startNotBigger');}else{if(objNext.getValue().getFullYear()-objPre.getValue().getFullYear()<=1){var monthsNext=objNext.getValue().getMonth()-objPre.getValue().getMonth()+12;if(monthsNext>=0&&monthsNext<=12){if(monthsNext==12){if(objNext.getValue().getDate()>objPre.getValue().getDate()){var success=false;var message=i18n('i18n.DpUtil.d_intervalBigger');}}}}}}}
DpUtil.linkWayLimit=function(regText){var mobil=/^1\d{10}$/;var tel=/^\d{3}[\d\*-/]{4,17}$/;var idCard=/^([\d]{15}|[\d]{18}|[\d]{17}X)$/;var defaultValue=/^\d{11}$/;switch(regText){case'M':return mobil;break;case'T':return tel;break;case'I':return tel;break;default:return defaultValue;break;　　}}
DpUtil.defaultDept=function(form,fieldName){var dept=form.getForm().findField(fieldName);dept.store.add(Ext.create('CurrentUserDeptListModel',{'deptId':top.User.deptId,'deptName':top.User.deptName}));dept.setValue(top.User.deptId);}
Ext.define('DataDictionaryModel',{extend:'Ext.data.Model',fields:['code','codeDesc']});var DataDictionary={};DataDictionary.LINKMANTYPE=[{'code':'0','codeDesc':'财务联系人'},{'code':'1','codeDesc':'业务联系人'},{'code':'2','codeDesc':'发货联系人'},{'code':'3','codeDesc':'收货联系人'},{'code':'4','codeDesc':'协议联系人'}];Ext.define('CurrentUserDeptListModel',{extend:'Ext.data.Model',fields:['deptId','deptName']});var currentUserDeptList=[];Ext.define('CurrentUserDeptListStore',{extend:'Ext.data.Store',model:'CurrentUserDeptListModel',data:null});Ext.define('ChangeMemberDeptModel',{extend:'Ext.data.Model',fields:[{name:'memberId',type:'string'},{name:'memberNumber',type:'string'},{name:'fromDeptId',type:'string'},{name:'fromDeptName',type:'string'},{name:'toDeptId',type:'string'},{name:'toDeptName',type:'string'},{name:'reason',type:'string'},{name:'workFlowId',type:'number',defaultValue:-1}]});Ext.define('UpgradeConditionModel',{extend:'Ext.data.Model',fields:[{name:'dept'},{name:'statisticsTime'},{name:'custName'},{name:'contactName'},{name:'phone'},{name:'tel'},{name:'nowLevel'},{name:'targetLevel'}]});Ext.define('UpGradeListModel',{extend:'Ext.data.Model',fields:[{name:'id'},{name:'status'},{name:'belongDeptId'},{name:'belongdeptName'},{name:'custName'},{name:'contactName'},{name:'contactPhone'},{name:'contactTel'},{name:'currentlevel'},{name:'targetLevel'},{name:'remark'}]});Ext.define('PreferenceAddressModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'shuttleAddress',type:'string'},{name:'addressType',type:'string'},{name:'address',type:'string'},{name:'startTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'endTime',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'billRequest',type:'string'},{name:'hasStopCost',type:'boolean'},{name:'payType',type:'string'},{name:'isSendToFloor',type:'boolean'},{name:'otherNeed',type:'string'},{name:'createUser',type:'string'},{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyUser',type:'string'},{name:'isMainAddress',type:'boolean'},{name:'',type:'string'}],validations:[{type:'presence',field:'addressType'},{type:'presence',field:'address'}]});Ext.define('AccountModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'bankId',type:'string'},{name:'bank',type:'string'},{name:'subBanknameId',type:'string'},{name:'subBankname',type:'string'},{name:'isdefaultaccount',type:'boolean'},{name:'bankAccount',type:'string'},{name:'countName',type:'string'},{name:'relation',type:'string'},{name:'bankProvinceId',type:'string'},{name:'bankProvinceName',type:'string'},{name:'bankCityId',type:'string'},{name:'bankCityName',type:'string'},{name:'accountNature',type:'string'},{name:'accountUse',type:'string'},{name:'linkManMobile',type:'string'},{name:'linkManPhone',type:'string'},{name:'financeLinkmanId',type:'string'},{name:'financeLinkman',type:'string'},{name:'createUser',type:'string'},{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyUser',type:'string'}]});Ext.define('ShuttleAddressModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'addressType',type:'string'},{name:'address',type:'string'},{name:'province',type:'string'},{name:'provinceName',type:'string'},{name:'city',type:'string'},{name:'cityName',type:'string'},{name:'area',type:'string'},{name:'areaName',type:'string'},{name:'createUser',type:'string'},{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyUser',type:'string'}],validations:[{type:'presence',field:'addressType'},{type:'presence',field:'address'},{type:'presence',field:'province'},{type:'presence',field:'city'},{type:'presence',field:'area'}]});Ext.define('ContactModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'number',type:'string'},{name:'name',type:'string'},{name:'idCard',type:'string'},{name:'linkmanType',type:'string'},{name:'isMainLinkMan',type:'boolean'},{name:'sex',type:'string'},{name:'telPhone',type:'string'},{name:'mobilePhone',type:'string'},{name:'duty',type:'string'},{name:'dutyDept',type:'string'},{name:'bornDate',type:'date',convert:DpUtil.changeLongToDate},{name:'gainave',type:'string'},{name:'decisionRight',type:'string'},{name:'nativePlace',type:'string'},{name:'personLove',type:'string'},{name:'folk',type:'string'},{name:'email',type:'string'},{name:'qqNumber',type:'string'},{name:'msn',type:'string'},{name:'ww',type:'string'},{name:'alid',type:'string'},{name:'onlineBusinessId',type:'string'},{name:'taobId',type:'string'},{name:'youshangId',type:'string'},{name:'linkManId',type:'string'},{name:'createUser',type:'string'},{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyUser',type:'string'},{name:'createSource',type:'int',defaultValue:0}],validations:[{type:'presence',field:'number'},{type:'presence',field:'name'},{type:'presence',field:'linkmanType'},{type:'presence',field:'sex'}]});Ext.define('MemberCustomerModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'custId',type:'string'},{name:'contactId',type:'string'},{name:'custNumber',type:'string'},{name:'deptId',type:'string'},{name:'deptName',type:'string'},{name:'degree',type:'string'},{name:'custName',type:'string'},{name:'tradeId',type:'string'},{name:'custType',type:'string'},{name:'taxregNumber',type:'string'},{name:'companyProperty',type:'string'},{name:'custNature',type:'string'},{name:'provinceId',type:'string'},{name:'province',type:'string'},{name:'cityId',type:'string'},{name:'city',type:'string'},{name:'registAddress',type:'string'},{name:'isSpecial',type:'boolean'},{name:'isRedeempoints',type:'boolean'},{name:'isImportCustor',type:'boolean'},{name:'custPotentialType',type:'string'},{name:'isAcceptMarket',type:'boolean'},{name:'brandWorth',type:'string'},{name:'channelSource',type:'string'},{name:'channel',type:'string'},{name:'preferenceService',type:'string'},{name:'companyScop',type:'string'},{name:'lastYearProfit',type:'number'},{name:'lastYearIncome',type:'number'},{name:'isFocusPay',type:'boolean'},{name:'focusDeptId',type:'string'},{name:'focusDeptName',type:'string'},{name:'billTitle',type:'string'},{name:'isParentCompany',type:'boolean'},{name:'parentCompanyId',type:'string'},{name:'parentNumber',type:'string'},{name:'registerFund',type:'number'},{name:'procRedit',type:'number'},{name:'recommendCust',type:'string'},{name:'remark',type:'string'},{name:'createUser',type:'string'},{name:'createDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyDate',type:'date',convert:DpUtil.changeLongToDate,defaultValue:new Date()},{name:'modifyUser',type:'string'},{name:'surplusMonthlyStatementMoney',type:'number'}]});Ext.define('WayBillInfoModel',{extend:'Ext.data.Model',fields:[{name:'id'},{name:'wayBillNumber'},{name:'money',type:'number'},{name:'ratio',type:'number'}]});Ext.define('ApproveDataModel',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'className',type:'string'},{name:'classId',type:'string'},{name:'fieldName',type:'string'},{name:'newValue',type:'string'},{name:'oldValue',type:'string'},{name:'workFlowId',type:'string'},{name:'handleType',type:'int'}]});Ext.define('QualificationViewModel',{extend:'Ext.data.Model',fields:[{name:'id'},{name:'wayBillList'},{name:'totalMoney',type:'number'},{name:'qualified',type:'boolean'},{name:'custLevel'}]});Ext.define('ImplementMemberViewModel',{extend:'Ext.data.Model',fields:[{name:'id'},{name:'qualificationView'},{name:'member'}]});Ext.define('BankModel',{extend:'Ext.data.Model',fields:['id','name','ID','NAME']});Ext.define('BankProvinceStore',{extend:'Ext.data.Store',model:'BankModel',autoLoad:true,proxy:{type:'ajax',url:'searchBankProvince.action',actionMethods:'POST',reader:{type:'json',root:'list'}}});Ext.define('BankCityStore',{extend:'Ext.data.Store',model:'BankModel',proxy:{type:'ajax',url:'searchBankCityByProvinceId.action',actionMethods:'POST',reader:{type:'json',root:'list'}}});Ext.define('BankNameStore',{extend:'Ext.data.Store',model:'BankModel',proxy:{type:'ajax',url:'searchBankName.action',actionMethods:'POST',reader:{type:'json',root:'list'}}});Ext.define('ImplementMemberViewStore',{extend:'Ext.data.Store',model:'ImplementMemberViewModel',proxy:{type:'ajax',api:{read:''},actionMethods:'POST',reader:{type:'json',root:'implementMemberView'}}});Ext.define('MemberCustomerStore',{extend:'Ext.data.Store',model:'MemberCustomerModel',pageSize:20,proxy:{type:'ajax',api:{read:''},actionMethods:'POST',reader:{type:'json',root:'',totalProperty:'totalCount'}}});Ext.define('WayBillInfoStore',{extend:'Ext.data.Store',model:'WayBillInfoModel',data:[]});Ext.define('FocusDeptStoreModel',{extend:'Ext.data.Model',fields:['id','deptName']});Ext.define('FocusDeptStore',{extend:'Ext.data.Store',model:'FocusDeptStoreModel',data:[]});Ext.define('SpecialDeptStore',{extend:'Ext.data.Store',model:'FocusDeptStoreModel',data:[]});Ext.define('MemberCustBasicData',{memberGradeStore:null,tradeStore:null,customerNatureStore:null,compNatureStore:null,customerTypeStore:null,cargoPotentialStore:null,custPotentialStore:null,firmSizeStore:null,creditGradeStore:null,addressTypeStore:null,logistDeciStore:null,payWayStore:null,preferenceChannelStore:null,preferenceServiceStore:null,billRequireStore:null,accountNatureStore:null,accountUseStore:null,genderStore:null,linkmanTypeData:DataDictionary.LINKMANTYPE,linkWayStore:null,currentUserDeptListStore:null,specialDeptStore:null,focusDeptStore:null,wayBillInfoStore:null,targetGradDownStore:null,targetGradUpStore:null,nowGradUpStore:null,marketInfoStore:null,getMemberGradeStore:function(){if(this.memberGradeStore==null){this.memberGradeStore=getDataDictionaryByName(DataDictionary,'MEMBER_GRADE');}
return this.memberGradeStore;},getTradeStore:function(){if(this.tradeStore==null){this.tradeStore=getDataDictionaryByName(DataDictionary,'TRADE');}
return this.tradeStore;},getCustomerNatureStore:function(){if(this.customerNatureStore==null){this.customerNatureStore=getDataDictionaryByName(DataDictionary,'CUSTOMER_NATURE');}
return this.customerNatureStore;},getCompNatureStore:function(){if(this.compNatureStore==null){this.compNatureStore=getDataDictionaryByName(DataDictionary,'COMP_NATURE');}
return this.compNatureStore;},getCustomerTypeStore:function(){if(this.customerTypeStore==null){this.customerTypeStore=getDataDictionaryByName(DataDictionary,'CUSTOMER_TYPE');}
return this.customerTypeStore;},getCargoPotentialStore:function(){if(this.cargoPotentialStore==null){this.cargoPotentialStore=getDataDictionaryByName(DataDictionary,'CARGO_POTENTIAL');}
return this.cargoPotentialStore;},getCustPotentialStore:function(){if(this.custPotentialStore==null){this.custPotentialStore=getDataDictionaryByName(DataDictionary,'CUST_POTENTIAL');}
return this.custPotentialStore;},getFirmSizeStore:function(){if(this.firmSizeStore==null){this.firmSizeStore=getDataDictionaryByName(DataDictionary,'FIRM_SIZE');}
return this.firmSizeStore;},getCreditGradeStore:function(){if(this.creditGradeStore==null){this.creditGradeStore=getDataDictionaryByName(DataDictionary,'CREDIT_GRADE');}
return this.creditGradeStore;},getAddressTypeStore:function(){if(this.addressTypeStore==null){this.addressTypeStore=getDataDictionaryByName(DataDictionary,'ADDRESS_TYPE');}
return this.addressTypeStore;},getLogistDeciStore:function(){if(this.logistDeciStore==null){this.logistDeciStore=getDataDictionaryByName(DataDictionary,'LOGIST_DECI');}
return this.logistDeciStore;},getPayWayStore:function(){if(this.payWayStore==null){this.payWayStore=getDataDictionaryByName(DataDictionary,'PAY_WAY');}
return this.payWayStore;},getPreferenceChannelStore:function(){if(this.preferenceChannelStore==null){this.preferenceChannelStore=getDataDictionaryByName(DataDictionary,'PREFERENCE_CHANNEL');}
return this.preferenceChannelStore;},getPreferenceServiceStore:function(){if(this.preferenceServiceStore==null){this.preferenceServiceStore=getDataDictionaryByName(DataDictionary,'PREFERENCE_SERVICE');}
return this.preferenceServiceStore;},getBillRequireStore:function(){if(this.billRequireStore==null){this.billRequireStore=getDataDictionaryByName(DataDictionary,'BILL_REQUIRE');}
return this.billRequireStore;},getAccountNatureStore:function(){if(this.accountNatureStore==null){this.accountNatureStore=getDataDictionaryByName(DataDictionary,'ACCOUNT_NATURE');}
return this.accountNatureStore;},getAccountUseStore:function(){if(this.accountUseStore==null){this.accountUseStore=getDataDictionaryByName(DataDictionary,'ACCOUNT_USE');}
return this.accountUseStore;},getGenderStore:function(){if(this.genderStore==null){this.genderStore=getDataDictionaryByName(DataDictionary,'GENDER');}
return this.genderStore;},initSelfDefineLinkmanType:function(dictionary){if(dictionary!=null){dictionary.LINKMANTYPE=this.linkmanTypeData;}},getLinkWayStore:function(){if(this.linkWayStore==null){this.linkWayStore=Ext.create('Ext.data.Store',{fields:['linkValue','linkDesc'],data:[{linkValue:'mobile',linkDesc:'手机号码'},{linkValue:'tel',linkDesc:'固定电话'}]});}
return this.linkWayStore;},getCurrentUserDeptListStore:function(){if(this.currentUserDeptListStore==null){this.currentUserDeptListStore=Ext.create('CurrentUserDeptListStore',{data:currentUserDeptList});}
return this.currentUserDeptListStore;},getWayBillInfoStore:function(){if(this.wayBillInfoStore==null){this.wayBillInfoStore=Ext.create('WayBillInfoStore');}
return this.wayBillInfoStore;},getDictionary:function(params,successFn,failFn){var dictionaryUrl='../common/queryAllDataDictionaryByKeys.action';DpUtil.requestJsonAjax(dictionaryUrl,params,successFn,failFn);},getDeptList:function(params,successFn,failFn){var deptListUrl='../common/acquireCurrentUserDeptList.action';DpUtil.requestJsonAjax(deptListUrl,params,successFn,failFn);},getNowGradUpStore:function(){if(this.nowGradUpStore==null){this.nowGradUpStore=getDataDictionaryByName(DataDictionary,'NOW_GRAD_UP');}
return this.nowGradUpStore;},getTargetGradUpStore:function(){if(this.targetGradUpStore==null){this.targetGradUpStore=getDataDictionaryByName(DataDictionary,'TARGET_GRAD_UP');}
return this.targetGradUpStore;},getTargetGradDownStore:function(){if(this.targetGradDownStore==null){this.targetGradDownStore=getDataDictionaryByName(DataDictionary,'TARGET_GRAD_DOWN');}
return this.targetGradDownStore;},getMarketInfoStore:function(){if(this.marketInfoStore==null){this.marketInfoStore=getDataDictionaryByName(DataDictionary,'MARKETINFO');}
return this.marketInfoStore;},getFocusDeptStore:function(){if(this.focusDeptStore==null){this.focusDeptStore=Ext.create('FocusDeptStore');}
return this.focusDeptStore;},getSpecialDeptStore:function(){if(this.specialDeptStore==null){this.specialDeptStore=Ext.create('SpecialDeptStore');}
return this.specialDeptStore;},getDeptByName:function(params,successFn,failFn){DpUtil.requestJsonAjax('../organization/acquireDeptByName.action',params,successFn,failFn);},bankProvinceStore:null,getBankProvinceStore:function(){if(this.bankProvinceStore==null){this.bankProvinceStore=Ext.create('BankProvinceStore');}
return this.bankProvinceStore;},bankCityStore:null,getBankCityStore:function(){if(this.bankCityStore==null){this.bankCityStore=Ext.create('BankCityStore');}
return this.bankCityStore;},bankNameStore:null,getBankNameStore:function(params,successFn,failFn){if(this.bankNameStore==null){this.bankNameStore=Ext.create('BankNameStore');}
return this.bankNameStore;}});
Ext.define('SearchMemberConditionModel',{extend:'Ext.data.Model',fields:[{name:'deptId'},{name:'custNumber'},{name:'custName'},{name:'custGrad'},{name:'linkManNumber'},{name:'linkManName'},{name:'mobile'},{name:'telePhone'},{name:'idCard'}]});Ext.define('SearchMemberResultModel',{extend:'Ext.data.Model',fields:[{name:'custId'},{name:'custNum'},{name:'custName'},{name:'custGrade'},{name:'custGroup'},{name:'contactNum'},{name:'contactName'},{name:'mobileNum'},{name:'telNum'},{name:'deptId'},{name:'deptName'},{name:'status'},{name:'address'},{name:'remark'},{name:'trade'},{name:'custType'},{name:'taxregNum'},{name:'idCard'},{name:'cityId'},{name:'cityName'}]});Ext.define('MemberSearchResultStore',{extend:'Ext.data.Store',model:'SearchMemberResultModel',pageSize:10,proxy:{type:'ajax',api:{read:'searchMemberList.action'},actionMethods:'POST',reader:{type:'json',root:'memberResultList',totalProperty:'totalCount'}},groupers:[{property:'custGroup'},{property:'custId',direction:'ASC'}]});Ext.define('MemberManagerData',{extend:'MemberCustBasicData',memberSearchResultStore:null,getMemberSearchStore:function(){return this.memberSearchResultStore;},initMemberSearchStore:function(beforeLoadTransactionFn){if(this.memberSearchResultStore==null){if(beforeLoadTransactionFn!=null){this.memberSearchResultStore=Ext.create('MemberSearchResultStore',{listeners:{beforeload:beforeLoadTransactionFn}});}else{this.memberSearchResultStore=Ext.create('MemberSearchResultStore');}}
return this.memberSearchResultStore;},acquireMemberById:function(params,successFn,failFn){var acquireMemberByIdUrl='acquireMemberById.action';DpUtil.requestJsonAjax(acquireMemberByIdUrl,params,successFn,failFn);},changeMemberDept:function(params,successFn,failFn){DpUtil.requestJsonAjax('changeMemberDept.action',params,successFn,failFn);}});
Ext.define('BooleanModel',{extend:'Ext.data.Model',fields:['name',{name:'value',type:'boolean'}]});Ext.define('BooleanStore',{extend:'Ext.data.Store',model:'BooleanModel',data:[{'name':'是','value':true},{'name':'否','value':false}]});Ext.define('BankSearchConditionModel',{extend:'Ext.data.Model',fields:['province','city','accountBank','accountBranch','provinceId','cityId','accountBankId','accountBranchId']});Ext.define('BankInfoStore',{extend:'Ext.data.Store',model:'BankSearchConditionModel',proxy:{type:'memory'}});Ext.define('ContactStore',{extend:'Ext.data.Store',model:'ContactModel',proxy:{type:'memory'}});Ext.define('ShuttleAddressStore',{extend:'Ext.data.Store',model:'ShuttleAddressModel',proxy:{type:'memory'}});Ext.define('PreferenceAddressStore',{extend:'Ext.data.Store',model:'PreferenceAddressModel',proxy:{type:'memory'}});Ext.define('AccountStore',{extend:'Ext.data.Store',model:'AccountModel',proxy:{type:'memory'}});Ext.define('MemberCustData',{extend:'MemberCustBasicData',booleanStore:null,preferenceAddressStore:null,accountStore:null,shuttleAddressStore:null,contactStore:null,bankInfoStore:null,bankComboxStore:null,getBooleanStore:function(){if(this.booleanStore==null){this.booleanStore=Ext.create('BooleanStore');}
return this.booleanStore;},getPreferenceAddressStore:function(){if(this.preferenceAddressStore==null){this.preferenceAddressStore=Ext.create('PreferenceAddressStore');}
return this.preferenceAddressStore;},getAccountStore:function(){if(this.accountStore==null){this.accountStore=Ext.create('AccountStore');}
return this.accountStore;},getShuttleAddressStore:function(){if(this.shuttleAddressStore==null){this.shuttleAddressStore=Ext.create('ShuttleAddressStore');}
return this.shuttleAddressStore;},getContactStore:function(){if(this.contactStore==null){this.contactStore=Ext.create('ContactStore');}
return this.contactStore;},saveMemberData:function(params,successFn,failFn){DpUtil.requestJsonAjax('saveMember.action',params,successFn,failFn);},saveSpecialMemberData:function(params,successFn,failFn){DpUtil.requestJsonAjax('saveSpecialMember.action',params,successFn,failFn);},alterMemberData:function(params,successFn,failFn){DpUtil.requestJsonAjax('alterMember.action',params,successFn,failFn);},searchBankInfo:function(params,successFn,failFn){DpUtil.requestJsonAjax('../common/searchBankInfoByBankView.action',params,successFn,failFn);},getBankInfoStore:function(){if(this.bankInfoStore==null){this.bankInfoStore=Ext.create('BankInfoStore');}
return this.bankInfoStore;},getBankComboxStore:function(){if(this.bankComboxStore==null){this.bankComboxStore=Ext.create('BankInfoStore');}
return this.bankComboxStore;},validateTaxNumberIsExist:function(params,successFn,failFn){DpUtil.requestJsonAjax('validateTaxIsExsist.action',params,successFn,failFn);},validateMobileIsExist:function(params,successFn,failFn){DpUtil.requestJsonAjax('validateMobileIsExsist.action',params,successFn,failFn);},validateIdNumberIsExist:function(params,successFn,failFn){DpUtil.requestJsonAjax('validateIdNumberIsExsist.action',params,successFn,failFn);},checkIsExistMember:function(params,successFn,failFn){var checkIsExistMemberUrl='checkIsExistMember.action';DpUtil.requestJsonAjax(checkIsExistMemberUrl,params,successFn,failFn);},acquireImplementMemberView:function(params,successFn,failFn){var acquireImplementMemberViewUrl='acquireImplementMemberView.action';DpUtil.requestJsonAjax(acquireImplementMemberViewUrl,params,successFn,failFn);}});
Ext.define('SearchMemberDataDictionaryModel',{extend:'Ext.data.Model',fields:['code','codeDesc']});var SearchMemberDataDictionary={};Ext.define('SearchMemberMemberGradeStore',{extend:'Ext.data.Store',model:'SearchMemberDataDictionaryModel',data:null});Ext.define('SearchMemberConditionModel',{extend:'Ext.data.Model',fields:[{name:'deptId'},{name:'custNumber'},{name:'custName'},{name:'custGrad'},{name:'linkManNumber'},{name:'linkManName'},{name:'mobile'},{name:'telePhone'},{name:'idCard'}]});Ext.define('SearchMemberResultModel',{extend:'Ext.data.Model',fields:[{name:'custId',type:'string'},{name:'contactId',type:'string'},{name:'custNum',type:'string'},{name:'custName',type:'string'},{name:'custGrade',type:'string'},{name:'custGroup',type:'string'},{name:'isMainLinkMan',type:'boolean'},{name:'contactNum',type:'string'},{name:'contactName',type:'string'},{name:'mobileNum',type:'string'},{name:'telNum',type:'string'},{name:'deptId',type:'string'},{name:'deptName',type:'string'},{name:'address',type:'string'},{name:'remark',type:'string'},{name:'status'},{name:'trade',type:'string'},{name:'custType',type:'string'},{name:'taxregNum',type:'string'},{name:'idCard',type:'string'},{name:'cityId',type:'string'},{name:'cityName',type:'string'}]});Ext.define('MemberSearchStore',{extend:'Ext.data.Store',model:'SearchMemberResultModel',proxy:{type:'ajax',api:{read:'searchMemberInfoList.action'},actionMethods:'POST',reader:{type:'json',root:'memberResultList'}},groupers:[{property:'custGroup',direction:'ASC'},{property:'custId',direction:'ASC'}]});Ext.define('SearchMemberData',{searchMemberGradeStore:null,searchMemberResultStore:null,loginUserDeptListStore:null,getMemberGradeStore:function(){if(this.searchMemberGradeStore==null){this.searchMemberGradeStore=getDataDictionaryByName(DataDictionary,'MEMBER_GRADE');}
return this.searchMemberGradeStore;},getDictionary:function(params,successFn,failFn){Ext.Ajax.request({url:'../common/queryAllDataDictionaryByKeys.action',async:false,jsonData:params,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});},getSearchMemberResultStore:function(){return this.searchMemberResultStore;},initSearchMemberResultStore:function(beforeLoadTransactionFn){if(this.searchMemberResultStore==null){if(beforeLoadTransactionFn!=null){this.searchMemberResultStore=Ext.create('MemberSearchStore',{listeners:{beforeload:beforeLoadTransactionFn}});}else{this.searchMemberResultStore=Ext.create('MemberSearchStore');}}
return this.searchMemberResultStore;}});
BelongDeptView=function(){};Ext.define('CurrentUserDeptListModel',{extend:'Ext.data.Model',fields:['deptId','deptName']});var DurrentUserBelongDept=[];Ext.define('Ext.ux.data.PagingMemoryProxy',{extend:'Ext.data.proxy.Memory',alias:'proxy.pagingmemory',alternateClassName:'Ext.data.PagingMemoryProxy',read:function(operation,callback,scope){var reader=this.getReader(),result=reader.read(this.data),sorters,filters,sorterFn,records;scope=scope||this;filters=operation.filters;if(filters.length>0){records=[];Ext.each(result.records,function(record){var isMatch=true,length=filters.length,i;for(i=0;i<length;i++){var filter=filters[i],fn=filter.filterFn,scope=filter.scope;isMatch=isMatch&&fn.call(scope,record);}
if(isMatch){records.push(record);}},this);result.records=records;result.totalRecords=result.total=records.length;}
sorters=operation.sorters;if(sorters.length>0){sorterFn=function(r1,r2){var result=sorters[0].sort(r1,r2),length=sorters.length,i;for(i=1;i<length;i++){result=result||sorters[i].sort.call(this,r1,r2);}
return result;};result.records.sort(sorterFn);}
if(operation.start!==undefined&&operation.limit!==undefined){result.records=result.records.slice(operation.start,operation.start+operation.limit);result.count=result.records.length;}
Ext.apply(operation,{resultSet:result});operation.setCompleted();operation.setSuccessful();Ext.Function.defer(function(){Ext.callback(callback,scope,[operation]);},10);}});Ext.define('BelongDeptCombox',{extend:'QueryCombox',alias:'widget.belongdeptcombox',fieldLabel:i18n('i18n.ScatterUpgradeView.belongdeptName'),displayField:'deptName',valueField:'deptId',name:'dept',queryMode:'local',pageSize:10,labelWidth:65,typeAhead:true,minChars:1,currentUserDeptStore:null,listConfig:{minWidth:330},enableKeyEvents:true,initComponent:function(){var me=this;DurrentUserBelongDept=new BelongDeptView().getDeptListDate();me.store=me.getCurrentUserDeptListStore();this.callParent();},getCurrentUserDeptListStore:function(){var me=this;var currentUserDeptListDate=[];var deptList=[];try{deptList=currentUserDeptList;}catch(e){}
if(deptList.length>0){currentUserDeptListDate=deptList;}else if(DurrentUserBelongDept.length>0){currentUserDeptListDate=DurrentUserBelongDept;}
this.currentUserDeptStore=Ext.create('Ext.data.Store',{pageSize:me.pageSize,model:'CurrentUserDeptListModel',autoLoad:true,proxy:{type:'pagingmemory',data:currentUserDeptListDate}});return this.currentUserDeptStore;}});BelongDeptView.prototype.getDeptListDate=function(){var me=this;var currentUserDeptListDate=[];var successDeptListFn=function(response){currentUserDeptListDate=response.currentUserDeptList;};var failDeptListFn=function(response){MessageUtil.showMessage(response.message);}
me.getDeptList({},successDeptListFn,failDeptListFn);return currentUserDeptListDate;}
BelongDeptView.prototype.getDeptList=function(params,successFn,failFn){Ext.Ajax.request({url:'../authorization/acquireCurrentUserDeptList.action',async:false,jsonData:params,success:function(response){var result=Ext.decode(response.responseText);if(result.success){successFn(result);}else{failFn(result);}},failure:function(response){var result=Ext.decode(response.responseText);failFn(result);}});}
var searchMemberDataControl=new SearchMemberData();SearchMemberView=function(){};Ext.define('MemberSearchCombox',{extend:'QueryCombox',alias:'widget.membersearchcombox',fieldLabel:i18n('i18n.Integral.menberName'),name:null,searchWindow:null,store:null,displayField:'custName',valueField:'custId',queryMode:'local',queryDelay:2000,forceSelection:true,enableKeyEvents:true,initComponent:function(){var me=this;me.addListener('change',me.changeFn);me.addListener('expand',me.expandFn);me.addListener('keypress',me.keypressFn);this.callParent();},changeFn:function(memberSearchCombox){if(DpUtil.isEmpty(memberSearchCombox.getValue())){memberSearchCombox.setValue(null);}},expandFn:function(memberSearchCombox){this.showSearchMemberWinFn(memberSearchCombox);},keypressFn:function(memberSearchCombox,e){if(e.getKey()==Ext.EventObject.ENTER){this.showSearchMemberWinFn(memberSearchCombox);}},setValueComeBack:function(memberResult,resultRecords){},showSearchMemberWinFn:function(memberSearchCombox){if(memberSearchCombox.searchWindow==null){SearchMemberView.showSearchMemberWin(memberSearchCombox);}else{var custName=memberSearchCombox.getRawValue();if(DpUtil.isEmpty(custName)){custName=memberSearchCombox.getValue();}
memberSearchCombox.searchWindow.loadCustName(custName);memberSearchCombox.searchWindow.show();}
memberSearchCombox.store.removeAll();}});SearchMemberView.showSearchMemberWin=function(parentCombox){var params=['MEMBER_GRADE'];initDataDictionary(params);if(parentCombox.searchWindow==null&&DataDictionary.MEMBER_GRADE.length!=0){var searchMemberWin=Ext.create('SearchMemberWin',{'searchMemberData':searchMemberDataControl,'parent':parentCombox});parentCombox.searchWindow=searchMemberWin;searchMemberWin.show();}};Ext.define('SearchMemberWin',{extend:'PopWindow',width:790,height:350,title:i18n('i18n.SearchMemberView.custInfo'),parent:null,searchConditionForm:null,searchResultGrid:null,searchButtonPanel:null,selectButtonPanel:null,searchMemberData:null,layout:{type:'vbox',align:'stretch'},listeners:{beforeclose:function(memberSearchWin){memberSearchWin.hide();return false;}},items:null,initComponent:function(){var me=this;var record=new SearchMemberConditionModel();me.searchConditionForm=Ext.create('SearchConditionForm',{'parent':me.parent,'record':record,'parentWin':me});me.searchResultGrid=Ext.create('SearchResultGrid',{'searchMemberData':me.searchMemberData,'searchConditionForm':me.searchConditionForm});me.searchButtonPanel=Ext.create('SearchButtonPanel',{'searchConditionForm':me.searchConditionForm,'searchMemberData':me.searchMemberData});me.items=me.getItems();me.fbar=me.getFbar();me.parent.store=me.searchMemberData.getSearchMemberResultStore();this.callParent();record.set('custName',me.parent.getValue());me.searchConditionForm.loadRecord(record);},getFbar:function(){var me=this;return[{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_ensure'),scope:me,handler:me.setMemberValueBack},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),handler:function(){me.hide();}}];},getItems:function(){var me=this;return[{xtype:'basicpanel',height:80,items:[me.searchConditionForm]},me.searchButtonPanel,{xtype:'basicpanel',flex:1,items:[me.searchResultGrid]}];},setMemberValueBack:function(){var me=this;var selection=me.searchResultGrid.getSelectionModel().getSelection();if(selection.length!=1){MessageUtil.showMessage(i18n('i18n.SearchMemberView.pleaseSelectCustInfoOp'))}else{me.parent.setValueComeBack(selection[0],me.searchMemberData.getSearchMemberResultStore().getRange());me.parent.setValue(selection[0].get('custId'));me.hide();}},loadCustName:function(custName){var me=this;me.searchConditionForm.getForm().reset();me.searchConditionForm.getForm().updateRecord(me.searchConditionForm.record);if(!DpUtil.isEmpty(custName)){var searchRecord=me.searchConditionForm.record;searchRecord.set('custName',custName);me.searchConditionForm.loadRecord(searchRecord);}}});Ext.define('SearchButtonPanel',{extend:'NormalButtonPanel',id:'SearchMemberView_SearchButtonPanel_id',items:null,searchConditionForm:null,searchMemberData:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'middlebuttonpanel'},{xtype:'rightbuttonpanel',items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.search'),scope:me,handler:me.searchEvent},{xtype:'button',text:i18n('i18n.MemberCustEditView.reset'),scope:me,handler:me.resetEvent}]}];},searchEvent:function(){var me=this;me.searchMemberData.getSearchMemberResultStore().loadPage(1);},beforeSearch:function(me){if(Ext.isEmpty(me)){me=this;}
if(!me.validateCondition()){MessageUtil.showMessage(i18n('i18n.MemberUpgradeView.message_notAllNull'));return false;}
if(!me.searchConditionForm.getForm().isValid()){MessageUtil.showMessage(i18n('i18n.MyWorkFlowDealManagerView.m_changeAllRight'));return false;}
return true;},resetEvent:function(){var me=this;me.searchConditionForm.getForm().reset();},validateCondition:function(){var me=this;var flag=false;me.searchConditionForm.getForm().getFields().each(function(field){if(!(DpUtil.isEmpty(field.getValue()))){flag=true;}});return flag;}});Ext.define('SearchConditionForm',{extend:'SearchFormPanel',id:'searchConditionFormId',parentWin:null,layout:{type:'table',columns:4},defaultType:'textfield',initComponent:function(){var me=this;me.defaults=me.getDefaultsContainer();me.items=me.getItems();this.callParent();},getItems:function(){var me=this;return[{fieldLabel:i18n('i18n.MemberCustEditView.custNo'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'custNumber'},{fieldLabel:i18n('i18n.PotentialCustManagerView.customerName'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'custName'},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactName'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'linkManName'},{fieldLabel:i18n('i18n.MemberCustEditView.contactNo'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'linkManNumber'},{fieldLabel:i18n('i18n.MemberCustEditView.mobileNo'),regex:DpUtil.linkWayLimit('M'),regexText:i18n('i18n.MemberCustEditView.pleaseInputCorrectMobilePhone'),name:'mobile'},{fieldLabel:i18n('i18n.SearchMemberView.phoneNumber'),regex:DpUtil.linkWayLimit('T'),regexText:i18n('i18n.MemberManagerView.pleaseEnterTheCorrectPhoneNumber'),name:'telePhone'},{fieldLabel:i18n('i18n.ScatterCustManagerView.idNumber'),maxLength:18,minLength:15,regex:DpUtil.linkWayLimit('I'),regexText:i18n('i18n.MemberCustEditView.cardNum15118LastxX'),name:'idCard'}];},getDefaultsContainer:function(){var me=this;return{labelAlign:'right',labelWidth:65,width:185,enableKeyEvents:true,listeners:{keypress:function(field,event){if(event.getKey()==Ext.EventObject.ENTER){if(!Ext.isEmpty(field.next())){field.next().focus();}else{me.parentWin.searchButtonPanel.searchEvent();}}}}};}});Ext.define('SearchResultGrid',{extend:'PopupGridPanel',searchConditionForm:null,searchMemberData:null,initComponent:function(){var me=this;me.store=me.searchMemberData.initSearchMemberResultStore(me.beforeLoadScatterFn);me.columns=me.getColumns();this.callParent();},getColumns:function(){var me=this;return[{header:i18n('i18n.MemberManagerView.customerGrouping'),dataIndex:'custGroup'},{header:i18n('i18n.ChangeContactAffiliatedRelationView.custId'),hidden:true,dataIndex:'custId'},{header:i18n('i18n.MemberCustEditView.custNo'),dataIndex:'custNum',hidden:true},{header:i18n('i18n.PotentialCustManagerView.customerName'),dataIndex:'custName',hidden:true},{header:i18n('i18n.ManualRewardIntegralEditView.id'),dataIndex:'contactId',hidden:true},{header:i18n('i18n.MemberCustEditView.isMainContact'),dataIndex:'isMainLinkMan',xtype:'booleancolumn',trueText:i18n('i18n.ChangeContactAffiliatedRelationView.yes'),falseText:i18n('i18n.ChangeContactAffiliatedRelationView.no')},{header:i18n('i18n.MemberCustEditView.contactNo'),dataIndex:'contactNum'},{header:i18n('i18n.ManualRewardIntegralEditView.name'),dataIndex:'contactName'},{header:i18n('i18n.SearchMemberView.mobileTelephone'),dataIndex:'mobileNum'},{header:i18n('i18n.MemberCustEditView.telephoneNo'),dataIndex:'telNum'},{header:i18n('i18n.PotentialCustEditView.address'),dataIndex:'address'},{header:i18n('i18n.ScatterCustManagerView.remark'),dataIndex:'remark'}];},features:[{ftype:'groupingsummary',groupHeaderTpl:'{name} ({rows.length})',hideGroupedHeader:true,enableGroupingMenu:false}],beforeLoadScatterFn:function(store,operation,eOpts){var searchConditionForm=Ext.getCmp('searchConditionFormId');var serchButton=Ext.getCmp('SearchMemberView_SearchButtonPanel_id');if(searchConditionForm!=null&&serchButton.beforeSearch(serchButton)){searchConditionForm.getForm().updateRecord(searchConditionForm.record);var searchCustCondition=searchConditionForm.record.data;var searchParams={'searchCustCondition.custNumber':DpUtil.trimString(searchCustCondition.custNumber),'searchCustCondition.custName':DpUtil.trimString(searchCustCondition.custName),'searchCustCondition.linkManNumber':DpUtil.trimString(searchCustCondition.linkManNumber),'searchCustCondition.linkManName':DpUtil.trimString(searchCustCondition.linkManName),'searchCustCondition.mobile':DpUtil.trimString(searchCustCondition.mobile),'searchCustCondition.telePhone':DpUtil.trimString(searchCustCondition.telePhone),'searchCustCondition.idCard':DpUtil.trimString(searchCustCondition.idCard)};Ext.apply(operation,{params:searchParams});}}});
Ext.define('ChangeMemberDeptWin',{extend:'PopWindow',title:i18n('i18n.ChangeMemberDeptView.t_deptChange'),items:null,fbar:null,width:570,height:210,layout:'fit',memberData:null,changeMemberDeptRecord:null,viewStatus:null,operateGrid:null,changeMemberDeptForm:null,initComponent:function(){var me=this;me.changeMemberDeptForm=Ext.create('ChangeMemberDeptForm',{'viewStatus':'NEW','changeMemberDeptRecord':me.changeMemberDeptRecord});me.items=[me.changeMemberDeptForm];me.fbar=me.getFbar();this.callParent();},getFbar:function(){var me=this;return[{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_ensure'),hidden:('VIEW'==me.viewStatus)?true:false,scope:me,handler:me.commitChangeMemberDept},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),handler:function(){me.close();}}];},commitChangeMemberDept:function(button){var me=this;var form=me.down('form').getForm();if(!form.isValid()){MessageUtil.showMessage(i18n('i18n.ChangeMemberDeptView.m_error'))
return;}
button.setDisabled(true);form.updateRecord(me.changeMemberDeptRecord);var params={};params.changeMemberDept=me.changeMemberDeptRecord.data;var successFn=function(resulte){var workFlowNum=resulte.workFlowNum;MessageUtil.showInfoMes(i18n('i18n.ChangeMemberDeptView.m_deptChangeSucess')+workFlowNum);me.operateGrid.store.loadPage(1);me.close();button.setDisabled(false);};var failFn=function(resulte){MessageUtil.showErrorMes(resulte.message);button.setDisabled(false);};me.memberData.changeMemberDept(params,successFn,failFn);}});Ext.define('ChangeMemberDeptForm',{extend:'BasicFormPanel',layout:{type:'table',columns:2},changeMemberDeptRecord:null,viewStatus:null,defaultType:'textfield',initComponent:function(){var me=this;me.defaults=me.getDefaults();me.items=me.getItems();this.callParent();me.loadMemberChangeDeptDate();},getItems:function(){var me=this;return[{colspan:2,fieldLabel:i18n('i18n.ScatterCustManagerView.memberNo'),name:'memberNumber'},{fieldLabel:i18n('i18n.ChangeMemberDeptView.d_currentlyDept'),name:'fromDeptName'},{fieldLabel:'目标归属部门',name:'toDeptName'},{colspan:2,xtype:'textareafield',fieldLabel:i18n('i18n.ChangeMemberDeptView.d_changeReason'),name:'reason',maxLength:100,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',100),width:520,height:60,readOnly:('VIEW'==me.viewStatus)?true:false},{xtype:'hiddenfield',name:'memberId'},{xtype:'hiddenfield',name:'fromDeptId'},{xtype:'hiddenfield',name:'toDeptId'}];},getDefaults:function(){var me=this;return{labelWidth:100,width:260,readOnly:true};},loadMemberChangeDeptDate:function(){var me=this;if(me.changeMemberDeptRecord==null){me.changeMemberDeptRecord=Ext.create('ChangeMemberDeptModel');}
if('NEW'==me.viewStatus){me.changeMemberDeptRecord.set('toDeptId',top.User.deptId);me.changeMemberDeptRecord.set('toDeptName',top.User.deptName);}
me.loadRecord(me.changeMemberDeptRecord);}});
var memberCustControl=Ext.create('MemberCustData');MemberCustEditView=function(){};MemberCustEditView.changeLinkmanTypeForSubmit=function(contactArray,contactRecords){if(contactRecords!=null){for(var i=0;i<contactRecords.length;i++){var linkmanTypeItem=contactRecords[i].get('linkmanType');if(!DpUtil.isEmpty(linkmanTypeItem)){linkmanTypeItem=linkmanTypeItem.replaceAll('true','1').replaceAll('false','0');contactRecords[i].data.linkmanType=linkmanTypeItem;contactArray.push(contactRecords[i].data);}}}};var RealTimeVerifyResult={success:[true,true,true,true,true,true],message:['',[],[],'','','']};var Sequence=1;MemberCustEditView.showMemberWin=function(params){var params=['MEMBER_GRADE','TRADE','CUSTOMER_NATURE','COMP_NATURE','CUSTOMER_TYPE','CUST_POTENTIAL','CARGO_POTENTIAL','FIRM_SIZE','CREDIT_GRADE','ADDRESS_TYPE','LOGIST_DECI','PAY_WAY','PREFERENCE_CHANNEL','PREFERENCE_SERVICE','BILL_REQUIRE','ACCOUNT_NATURE','ACCOUNT_USE','GENDER','MARKETINFO'];initDataDictionary(params);memberCustControl.initSelfDefineLinkmanType(DataDictionary);Ext.create('MemberCustEditWindow',params).show();};Ext.define('MemberCustEditWindow',{extend:'PopWindow',title:i18n('i18n.MemberCustEditView.memberInfoEditUI'),layout:'fit',width:825,height:435,member:null,updateMemberParent:null,scatterUpgradeRecord:null,viewStatus:null,items:null,initComponent:function(){var me=this;me.items=[Ext.create('MemberCustEditPanel',{'member':me.member,'scatterUpgradeRecord':me.scatterUpgradeRecord,'viewStatus':me.viewStatus,'updateMemberParent':me.updateMemberParent,'parentWindow':me})];me.on('beforeclose',me.beforeCloseEvent);this.callParent();},beforeCloseEvent:function(){var me=this;RealTimeVerifyResult={success:[true,true,true,true,true,true],message:['',[],[],'','','']};memberCustControl.getPreferenceAddressStore().removeAll();}});Ext.define('MemberCustEditPanel',{extend:'BasicPanel',memberCustBasicInfo:null,memberLinkmanInfo:null,memberAccountInfo:null,memberAddressInfo:null,updateMemberParent:null,memberData:memberCustControl,width:825,height:435,layout:{type:'vbox',align:'stretch'},items:null,fbar:null,member:null,channelType:'normal',viewStatus:null,scatterUpgradeRecord:null,parentWindow:null,initComponent:function(){var me=this;me.memberCustBasicInfo=Ext.create('MemberCustBasicInfoPanel',{'memberData':me.memberData,'memberBasicRecord':me.getMemberBasicRecord(),'channelType':me.channelType,'viewStatus':me.viewStatus});me.memberLinkmanInfo=Ext.create('MemberLinkmanTabPanel',{'memberData':me.memberData,'parent':me,'viewStatus':me.viewStatus,'memberLinkmanData':me.getMemberLinkmanData()});me.memberAccountInfo=Ext.create('MemberAccountTabPanel',{'memberData':me.memberData,'viewStatus':me.viewStatus,'memberAccountData':me.getMemberAccountData()});me.memberAddressInfo=Ext.create('MemberAddressTabPanel',{'memberData':me.memberData,'viewStatus':me.viewStatus,'memberAddressData':me.getMemberAddressData()});if(me.channelType!='special'){me.items=[{xtype:'normaltabpanel',flex:1,items:[{xtype:'tabcontentpanel',title:'基本信息<span style="color:red;">*</span>',items:[me.memberCustBasicInfo]},me.memberLinkmanInfo,me.memberAccountInfo,me.memberAddressInfo]}];}else{me.items=[{xtype:'titleformpanel',height:350,items:[{xtype:'fieldset',title:i18n('i18n.MemberCustEditView.basicInfo'),items:[me.memberCustBasicInfo]}]},{xtype:'normaltabpanel',flex:1,items:[me.memberLinkmanInfo,me.memberAccountInfo,me.memberAddressInfo]}];}
me.fbar=me.getFbar();this.callParent();if(me.channelType=='special'||me.channelType=='immediate'||me.channelType=='workflow'){Ext.getCmp('cancel_id').setVisible(false);if(me.channelType=='workflow'){Ext.getCmp('save_id').setVisible(false);}}
if(me.viewStatus=='view'){me.lockAllComponents();Ext.getCmp('save_id').setDisabled(true);}
if(me.channelType=='immediate'){me.lockAllComponents();Ext.getCmp('save_id').setDisabled(true);}},getFbar:function(){var me=this;return[{xtype:'button',text:i18n('i18n.PotentialCustEditView.save'),id:'save_id',scope:me,handler:me.saveMemberCust},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),id:'cancel_id',handler:function(){if(me.parentWindow!=null){me.parentWindow.close();}}}];},lockAllComponents:function(){var me=this;var memberBasicBasicForm=me.memberCustBasicInfo.getForm();memberBasicBasicForm.getFields().each(function(field){field.setReadOnly(true);});var linkButton=me.memberLinkmanInfo.down('button');while(linkButton!=null){linkButton.setDisabled(true);linkButton=linkButton.next('button');}
var accountButton=me.memberAccountInfo.down('button');while(accountButton!=null){accountButton.setDisabled(true);accountButton=accountButton.next('button');}
var addressButton=me.memberAddressInfo.down('button');while(addressButton!=null){addressButton.setDisabled(true);addressButton=addressButton.next('button');}},unLockAllComponents:function(){var me=this;var memberBasicBasicForm=me.memberCustBasicInfo.getForm();memberBasicBasicForm.getFields().each(function(field){field.setReadOnly(false);});if(me.channelType=='immediate'){me.memberCustBasicInfo.getForm().findField('degree').setReadOnly(true);me.memberCustBasicInfo.getForm().findField('isSpecial').setValue(false);me.memberCustBasicInfo.getForm().findField('isSpecial').setReadOnly(true);}
if(me.channelType!='special'){me.memberCustBasicInfo.getForm().findField('deptId').setReadOnly(true);}
me.memberCustBasicInfo.getForm().findField('custNumber').setReadOnly(true);var linkButton=me.memberLinkmanInfo.down('button');while(linkButton!=null){linkButton.setDisabled(false);linkButton=linkButton.next('button');}
var accountButton=me.memberAccountInfo.down('button');while(accountButton!=null){accountButton.setDisabled(false);accountButton=accountButton.next('button');}
var addressButton=me.memberAddressInfo.down('button');while(addressButton!=null){addressButton.setDisabled(false);addressButton=addressButton.next('button');}},loadMemberDataAfterRender:function(member){var me=this;me.member=member;var memberBasicRecord=me.getMemberBasicRecord();var memberLinkmanData=me.getMemberLinkmanData();var memberAccountData=me.getMemberAccountData();var memberAddressData=me.getMemberAddressData();me.memberCustBasicInfo.loadMemberBasicData(memberBasicRecord);me.memberAddressInfo.loadMemberAddressData(memberAddressData);me.memberLinkmanInfo.loadLinkmanData(memberLinkmanData);me.memberAccountInfo.loadMemberAccountData(memberAccountData);me.unLockAllComponents();},getMemberBasicRecord:function(){var me=this;var memberBaiscRecord=null;if(me.member!=null){memberBaiscRecord=Ext.create('MemberCustomerModel',me.member);}else{memberBaiscRecord=Ext.create('MemberCustomerModel');}
return memberBaiscRecord;},getMemberLinkmanData:function(){if(this.member!=null){return this.member.contactList;}
return null;},getMemberAccountData:function(){if(this.member!=null){return this.member.accountList;}
return null;},getMemberAddressData:function(){if(this.member!=null){return this.member.shuttleAddressList;}
return null;},saveMemberCust:function(button){var me=this;var validateResult=me.validateMainContactIdNumber();if(!validateResult.success){MessageUtil.showMessage(validateResult.message);return;}
me.checkAddressIsModify();me.checkContactIsModify();var validateRealTimeVerifyResult=me.validateRealTimeVerifyResult(RealTimeVerifyResult.success,RealTimeVerifyResult.message);if(!validateRealTimeVerifyResult.success){MessageUtil.showMessage(validateRealTimeVerifyResult.message);return;}
var validateRs=me.validateAllMemberInfo();if(validateRs.success){button.setDisabled(true);if(me.viewStatus=='new'){var memberInfo=me.assembleNewMemberData();var saveMemberSuccessFn=function(result){button.setDisabled(false);var custNumber=result.member.custNumber;MessageUtil.showInfoMes(i18n('i18n.MemberCustEditView.saveSuccess')+custNumber+i18n('i18n.MemberCustEditView.saveRemember'));if(me.channelType=='normal'){me.parentWindow.close();var store=null;try{store=me.updateMemberParent.memberManagerResultGrid.store;}catch(e){store=me.updateMemberParent.scatterUpgradeResultInfo.store;}
if(store!=null){store.load();}}else{me.lockAllComponents();button.setDisabled(true);Ext.getCmp('member_cityId').setDisabled(true);}};var saveMemberFailFn=function(result){button.setDisabled(false);if(DpUtil.isEmpty(result.message)){result.message=i18n('i18n.PotentialCustEditView.saveFailed');}
MessageUtil.showErrorMes(result.message);};if(me.channelType=='special'){var saveSuccessFn=function(result){button.setDisabled(false);var workFlowNum=result.workFlowNum;if(!Ext.isEmpty(workFlowNum)){MessageUtil.showInfoMes(i18n('i18n.MemberCustEditView.saveSuccessWorkFlowNum')+workFlowNum+i18n('i18n.MemberCustEditView.beforeApprovalNotMembersModifyOperatingWar'));me.lockAllComponents();button.setDisabled(true);}};me.memberData.saveSpecialMemberData(memberInfo,saveSuccessFn,saveMemberFailFn);}else{me.memberData.saveMemberData(memberInfo,saveMemberSuccessFn,saveMemberFailFn);}}else if(me.viewStatus=='update'){var alterMemberInfo=me.assembleAlterMemberData();var alterMemberSuccessFn=function(result){button.setDisabled(false);var workFlowNum=result.workFlowNum;if(Ext.isEmpty(workFlowNum)){MessageUtil.showInfoMes(i18n('i18n.MemberCustEditView.updateMemberSuccessWar'));}else{MessageUtil.showInfoMes(i18n('i18n.MemberCustEditView.updateMemberSuccessWorkFlowNum')+workFlowNum+i18n('i18n.MemberCustEditView.beforeApprovalNotMembersModifyOperatingWar'));}
if(me.channelType=='normal'){me.parentWindow.close();me.updateMemberParent.memberManagerResultGrid.store.load();}
me.parentWindow.close();me.updateMemberParent.memberManagerResultGrid.store.load();};var alterMemberFailFn=function(result){button.setDisabled(false);if(DpUtil.isEmpty(result.message!=null)){result.message=i18n('i18n.MemberCustEditView.updateMemberFailureWar');}
MessageUtil.showErrorMes(result.message);};me.memberData.alterMemberData(alterMemberInfo,alterMemberSuccessFn,alterMemberFailFn);}
me.memberData.getBankComboxStore().removeAll();}else if(!DpUtil.isEmpty(validateRs.message)){MessageUtil.showMessage(validateRs.message);}},validateRealTimeVerifyResult:function(RealTimeVerifySuccess,RealTimeVerifyMessage){var me=this;var flag=true;var message='';for(var i=0;i<RealTimeVerifySuccess.length;i++){if(i==1||i==2){var checkMobileOrIdCard=RealTimeVerifyMessage[i];for(var j=0;j<checkMobileOrIdCard.length;j++){if(!checkMobileOrIdCard[j].success){message=checkMobileOrIdCard[j].message;flag=false;}}}else{if(!RealTimeVerifySuccess[i]){message=RealTimeVerifyMessage[i];flag=false;}}}
return{success:flag,message:message};},validateMainContactIdNumber:function(){var me=this;var flag=true;var message='';var custType=me.memberCustBasicInfo.getForm().findField('custType').getValue();me.memberData.getContactStore().each(function(record){if(record.get('isMainLinkMan')){var result=null;if(-1!=record.get('id').indexOf('X')){result=me.validateIdNumber(record.get('idCard'),custType,record.get('isMainLinkMan'));}
else{if(record.isModified('isMainLinkMan')){result=me.validateIdNumber(record.get('idCard'),custType,record.get('isMainLinkMan'));}}
if(result!=null&&!result.success){message=result.message;flag=false;}}});return{success:flag,message:message};},validateIdNumber:function(idNumber,custType,isMainContact){var me=this;var flag=true;var message='';var validateSuccessFn=function(result){if(!result.exist){message=i18n('i18n.MemberCustEditView.m_contactIsExist');flag=false;}};var validateFailFn=function(result){if(DpUtil.isEmpty(result.message)){result.message=i18n('i18n.MemberCustEditView.anExceptionBackgroundAppearsWar');}
message=result.message;flag=false;};var params={};params.idNumber=idNumber;params.custType=custType;params.isMainContact=isMainContact;if('PERSONAL'==custType&&isMainContact){RealTimeVerifyResult.success[0]=true;RealTimeVerifyResult.message[0]='';me.memberData.validateIdNumberIsExist(params,validateSuccessFn,validateFailFn);}else{RealTimeVerifyResult.success[5]=true;RealTimeVerifyResult.message[5]='';}
return{success:flag,message:message};},checkContactIsModify:function(){var me=this;var contactStore=me.memberData.getContactStore();var accountStore=me.memberData.getAccountStore();var i=0;accountStore.each(function(accountRecord){contactStore.each(function(contactRecord){if(contactRecord.get('name')==accountRecord.get('financeLinkman')&&contactRecord.get('mobilePhone')==accountRecord.get('linkManMobile')&&contactRecord.get('telPhone')==accountRecord.get('linkManPhone')){i++;}})});if(i!=accountStore.getCount()){RealTimeVerifyResult.success[3]=false;RealTimeVerifyResult.message[3]=i18n('i18n.MemberCustEditView.m_contactIsUpdate');}else{RealTimeVerifyResult.success[3]=true;RealTimeVerifyResult.message[3]='';}},checkAddressIsModify:function(){var me=this;var shuttleStore=me.memberData.getShuttleAddressStore();var contactStore=me.memberData.getContactStore();var i=0;var j=0;contactStore.each(function(contactRecord){var preferAddress=contactRecord.get('preferenceAddressList');if(!Ext.isEmpty(preferAddress)){i=i+preferAddress.length;for(var k=0;k<preferAddress.length;k++){shuttleStore.each(function(shuttleRecord){if(shuttleRecord.get('address')==preferAddress[k].address&&shuttleRecord.get('addressType')==preferAddress[k].addressType){j++;}})};}})
if(i!=j){RealTimeVerifyResult.success[4]=false;RealTimeVerifyResult.message[4]=i18n('i18n.MemberCustEditView.m_addressIsUpdate');}else{RealTimeVerifyResult.success[4]=true;RealTimeVerifyResult.message[4]='';}},validateAllMemberInfo:function(){var me=this;var success=true;var message='';var validateMemberBasicRs=me.memberCustBasicInfo.validateMemberBasicInfo();if(!validateMemberBasicRs.success){success=false;message=validateMemberBasicRs.message;}else{var validateLinkmanRs=me.memberLinkmanInfo.validateLinkman();if(!validateLinkmanRs.success){success=false;message=validateLinkmanRs.message;}else{var validateAccountRs=me.memberAccountInfo.validateAccount();if(!validateAccountRs.success){success=false;message=validateAccountRs.message;}else{var validateAddressRs=me.memberAddressInfo.validateAddress();if(!validateAddressRs.success){success=false;message=validateAddressRs.message;}}}}
return{'success':success,'message':message};},assembleNewMemberData:function(){var me=this;var params={};params.member=me.memberCustBasicInfo.collectMemberBasicData();params.member.contactList=me.memberLinkmanInfo.collectLinkmanForMemberSubmit();params.member.accountList=me.memberAccountInfo.collectMemberAccountsForSubmit();params.member.shuttleAddressList=me.memberAddressInfo.collectShuttleAddressForSubmit();if(me.scatterUpgradeRecord!=null){params.upGradeCust=me.scatterUpgradeRecord.data;}
return params;},assembleAlterMemberData:function(){var me=this;var params={};var alterMemberList=new Array();var alterDeleteList=new Array();var alterAddLinkmanList=new Array();var alterAddAddressHobbyList=new Array();var alterAddAddressList=new Array();var alterAddAccountList=new Array();me.memberCustBasicInfo.collectAlterMemberData(alterMemberList);me.memberLinkmanInfo.collectAllLinkmanAlterData(alterMemberList,alterDeleteList,alterAddLinkmanList,alterAddAddressHobbyList);me.memberAccountInfo.collectAllAcountAlterData(alterMemberList,alterDeleteList,alterAddAccountList);me.memberAddressInfo.collectAllAddressAlterData(alterMemberList,alterDeleteList,alterAddAddressList);params.alterMemberApproveData=alterMemberList;params.alterDeleteMemberData=alterDeleteList;params.memberId=me.member.id;params.alterAddLinkmanData=alterAddLinkmanList;params.alterAddAddressHobbyData=alterAddAddressHobbyList;params.alterAddAddressData=alterAddAddressList;params.alterAddAccountData=alterAddAccountList;return params;}});Ext.define('MemberCustBasicInfoPanel',{id:'MemberCustBasicInfoPanel01',extend:'NoBorderFormPanel',items:null,memberData:null,memberBasicRecord:null,channelType:null,viewStatus:null,layout:{type:'table',columns:8},defaultType:'textfield',defaults:{labelWidth:70,width:180,enableKeyEvents:true,listeners:null},initComponent:function(){var me=this;me.items=me.getItems();this.callParent();me.defaults.listeners={scope:me,keypress:me.enterKeyEvent};me.loadMemberBasicData();me.initBusinessComponent();},loadMemberBasicData:function(memberBasicRecord){var me=this;if(memberBasicRecord!=null){me.memberBasicRecord=memberBasicRecord;}
if(me.memberBasicRecord!=null){if(!Ext.isEmpty(me.memberBasicRecord.get('focusDeptId'))&&!Ext.isEmpty(me.memberBasicRecord.get('focusDeptName'))){me.memberData.getFocusDeptStore().insert(0,Ext.create('FocusDeptStoreModel',{'id':me.memberBasicRecord.get('focusDeptId'),'deptName':me.memberBasicRecord.get('focusDeptName')}));}
if(!Ext.isEmpty(me.memberBasicRecord.get('deptId'))&&!Ext.isEmpty(me.memberBasicRecord.get('deptName'))){me.memberData.getSpecialDeptStore().insert(0,Ext.create('FocusDeptStoreModel',{'id':me.memberBasicRecord.get('deptId'),'deptName':me.memberBasicRecord.get('deptName')}));}
if(!Ext.isEmpty(me.memberBasicRecord.get('parentCompanyId'))&&!Ext.isEmpty(me.memberBasicRecord.get('parentNumber'))){me.getForm().findField('parentCompanyId').store.insert(0,Ext.create('SearchMemberResultModel',{'custId':me.memberBasicRecord.get('parentCompanyId'),'custName':me.memberBasicRecord.get('parentNumber')}));}
me.getForm().loadRecord(me.memberBasicRecord);}},initBusinessComponent:function(){var me=this;if(me.viewStatus=='new'){me.getForm().findField('isRedeempoints').setValue(false);me.getForm().findField('isImportCustor').setValue(false);me.getForm().findField('isFocusPay').setValue(false);me.getForm().findField('isParentCompany').setValue(true);me.getForm().findField('procRedit').setValue(1000);me.getForm().findField('parentCompanyId').setReadOnly(true);if(me.channelType!='special'){me.getForm().findField('deptId').setReadOnly(true);}}else{if(me.getForm().findField('isParentCompany').getValue()){me.getForm().findField('parentCompanyId').setValue();me.getForm().findField('parentCompanyId').setReadOnly(true);}
me.getForm().findField('deptId').setReadOnly(true);}
if(me.channelType=='special'){me.getForm().findField('degree').setReadOnly(false);me.getForm().findField('isSpecial').setValue(true);}
else if(me.channelType=='immediate'){me.getForm().findField('isSpecial').setValue(false);me.getForm().findField('isSpecial').setReadOnly(true);me.getForm().findField('surplusMonthlyStatementMoney').setReadOnly(true);}else{me.getForm().findField('isSpecial').setValue(false);}
if(!me.getForm().findField('isFocusPay').getValue()){me.getForm().findField('focusDeptId').setReadOnly(true);me.getForm().findField('focusDeptId').setValue();}
if('PERSONAL'==me.getForm().findField('custType').getValue()){me.getForm().findField('taxregNumber').setReadOnly(true);me.getForm().findField('companyProperty').setReadOnly(true);}},getItems:function(){var me=this;var operateType=null;if(me.viewStatus=='view'){operateType='VIEW';}else if(me.viewStatus=='update'){operateType='UPDATE';}
return[{fieldLabel:i18n('i18n.MemberCustEditView.custNo'),readOnly:true,name:'custNumber'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.ScatterUpgradeView.belongdeptName'),xtype:'dpcombobox',name:'deptId',displayField:'deptName',valueField:'id',queryMode:'local',allowBlank:(me.channelType=='special')?false:true,blankText:i18n('i18n.ScatterUpgradeView.belongdeptName'),emptyText:i18n('i18n.MemberCustEditView.inputFoureWordsEnter'),forceSelection:true,store:me.memberData.getSpecialDeptStore(),listConfig:{minWidth:296},listeners:{specialkey:function(th,e){var successFn=function(json){me.memberData.getSpecialDeptStore().removeAll();me.memberData.getSpecialDeptStore().add(json.focusDeptList);th.expand();};var param={'deptName':'%'+e.target.value+'%'};if(me.viewStatus=='new'&&me.channelType=='special'){DpUtil.keyPress(e,me.memberData.getDeptByName,param,2,successFn);}},select:function(combo,records){if(records.length>0){combo.up('form').getForm().findField('deptName').setValue(records[0].get('deptName'));}}}},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.custLevel'),name:'degree',xtype:'dpcombobox',readOnly:true,allowBlank:false,blankText:i18n('i18n.MemberCustEditView.m_noGrade'),store:me.memberData.getMemberGradeStore(),displayField:'codeDesc',valueField:'code',queryMode:'local'},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.PotentialCustManagerView.customerName'),allowBlank:false,name:'custName',maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),blankText:i18n('i18n.PotentialCustEditView.message_custName')},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.custIndustry'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',allowBlank:false,name:'tradeId',blankText:i18n('i18n.ChangeContactAffiliatedRelationView.regex_tradeId'),store:me.memberData.getTradeStore()},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.custType'),xtype:'dpcombobox',listeners:{scope:me,keypress:me.enterKeyEvent,select:me.selectCustTypeEvent},name:'custType',allowBlank:false,blankText:i18n('i18n.MemberCustEditView.custTypeAlert'),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.memberData.getCustomerTypeStore()},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.ScatterCustManagerView.taxId'),name:'taxregNumber',regex:/^\d{0,20}$/,regexText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),listeners:{scope:me,blur:me.validateTaxIsExsist}},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.ScatterCustManagerView.companyProperties'),xtype:'dpcombobox',blankText:i18n('i18n.MemberCustEditView.companyPropertyAlert'),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'companyProperty',store:me.memberData.getCompNatureStore()},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.ScatterCustManagerView.custAttribute'),xtype:'dpcombobox',allowBlank:false,blankText:i18n('i18n.MemberCustEditView.m_propertyNotNull'),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'custNature',store:me.memberData.getCustomerNatureStore()},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{xtype:'fieldcontainer',layout:{type:'hbox'},defaults:{hideLabel:true,enableKeyEvents:true,listeners:{scope:me,keypress:me.enterKeyEvent},allowBlank:false},items:[{xtype:'displayfield',value:i18n('i18n.MemberCustEditView.province'),width:75},{xtype:'areaaddresscombox',id:'member_cityId',name:'cityId',flex:1,width:110,operateType:operateType,disabled:('view'==me.viewStatus)?true:false,selectedValue:me.memberBasicRecord.get('cityId'),tabPanel:['provincePanel','cityPanel'],blankText:i18n('i18n.MemberCustEditView.cityAlert'),emptyText:i18n('i18n.MemberCustEditView.cityAlert')}]},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.registAddress'),colspan:3,width:370,allowBlank:false,maxLength:300,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',300),name:'registAddress'},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.isSpecial'),xtype:'dpcombobox',name:'isSpecial',queryMode:'local',forceSelection:true,displayField:'name',valueField:'value',store:me.memberData.getBooleanStore(),readOnly:true,allowBlank:false,emptyText:i18n('i18n.MemberCustEditView.isOrNot'),blankText:i18n('i18n.MemberCustEditView.isSpecialAlert')},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.isImportCustor'),name:'isImportCustor',xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'name',valueField:'value',store:me.memberData.getBooleanStore(),allowBlank:false,emptyText:i18n('i18n.MemberCustEditView.isOrNot'),blankText:i18n('i18n.MemberCustEditView.isImportCustorAlert')},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.custPotentialType'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'custPotentialType',emptyText:i18n('i18n.MemberCustEditView.highOrLow'),store:me.memberData.getCustPotentialStore(),listeners:{change:function(field,newValue){if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.isAcceptMarket'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'isAcceptMarket',emptyText:i18n('i18n.MemberCustEditView.acceptOrNot'),store:me.memberData.getMarketInfoStore()},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.brandWorth'),maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20),name:'brandWorth'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.channelSource'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'channelSource',store:me.memberData.getPreferenceChannelStore(),listeners:{change:function(field,newValue){if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.channel'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'channel',store:me.memberData.getPreferenceChannelStore(),listeners:{change:function(field,newValue){if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.preferenceService'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'preferenceService',store:me.memberData.getPreferenceServiceStore(),listeners:{change:function(field,newValue){if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.ScatterCustManagerView.companySize'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',name:'companyScop',store:me.memberData.getFirmSizeStore(),listeners:{change:function(field,newValue){if(Ext.isEmpty(newValue)){field.setValue(null);}}}},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.lastYearProfit'),xtype:'dpnumberfield',hideTrigger:true,maxLength:10,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',10),name:'lastYearProfit'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.lastYearIncome'),xtype:'dpnumberfield',hideTrigger:true,maxLength:10,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',10),name:'lastYearIncome'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.billTitle'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'billTitle'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.registerFund'),xtype:'dpnumberfield',hideTrigger:true,maxLength:10,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',10),name:'registerFund'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.procRedit'),xtype:'dpnumberfield',hideTrigger:true,allowBlank:false,maxLength:10,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',10),blankText:i18n('i18n.MemberCustEditView.procReditAlert'),name:'procRedit'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.ScatterCustManagerView.remark'),name:'remark',colspan:4,width:556,maxLength:200,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',200),width:370},{hidden:true,name:'parentNumber'},{hidden:true,name:'focusDeptName'},{hidden:true,name:'deptName'},{hidden:true,name:'provinceId'},{hidden:true,name:'isRedeempoints'},{hidden:true,name:'isFocusPay'},{hidden:true,name:'focusDeptId'},{hidden:true,name:'isParentCompany'},{hidden:true,name:'parentCompanyId'},{hidden:true,name:'recommendCust'},{hidden:true,name:'surplusMonthlyStatementMoney'}];},getDateComboSelect:function(fieldLabel,name,store,readOnly,blankText){var me=this;return DpUtil.createCombo(fieldLabel,name,store,false,readOnly,70,180,false,null);},getDateComboSelect:function(fieldLabel,name,store,readOnly,blankText){var me=this;return DpUtil.createCombo(fieldLabel,name,store,true,readOnly,70,180,true,true);},validateTaxIsExsist:function(taxfield){var me=this;var taxNum=taxfield.getValue();if(!DpUtil.isEmpty(taxNum)){me.getForm().updateRecord(me.memberBasicRecord);if(!me.memberBasicRecord.isModified('taxregNumber')||!taxfield.isValid()){return;}
var validateSuccessFn=function(result){if(result.exist){RealTimeVerifyResult.success[0]=true;RealTimeVerifyResult.message[0]='';}else{RealTimeVerifyResult.success[0]=false;RealTimeVerifyResult.message[0]=i18n('i18n.MemberCustEditView.m_taxIsExsit');MessageUtil.showMessage(i18n('i18n.MemberCustEditView.m_taxIsExsit'));return;}};var validateFailFn=function(result){if(DpUtil.isEmpty(result.message)){result.message=i18n('i18n.MemberCustEditView.anExceptionBackgroundAppearsWar');RealTimeVerifyResult.success[0]=false;RealTimeVerifyResult.message[0]=result.message;}
RealTimeVerifyResult.success[0]=false;RealTimeVerifyResult.message[0]=result.message;MessageUtil.showMessage(result.message);return;};var params={};params.taxNum=taxNum;me.memberData.validateTaxNumberIsExist(params,validateSuccessFn,validateFailFn);}},enterKeyEvent:function(field,event){var me=this;if(event.getKey()==Ext.EventObject.ENTER){if(field.next()!=null){if(field.fieldLabel=='province'||field.fieldLabel==i18n('i18n.MemberCustEditView.registAddress')){field.next().focus();}else if(field.fieldLabel==i18n('i18n.ScatterCustManagerView.custAttribute')){me.getForm().findField('province').focus();}else if(field.next().next()!=null){field.next().next().focus();}}else if(field.fieldLabel=='city'){me.getForm().findField('registAddress').focus();}}},selectCustTypeEvent:function(combox,records){var me=this;if(records.length>0&&records[0].get('codeDesc')==i18n('i18n.MemberCustEditView.personal')){RealTimeVerifyResult.success[0]=true;RealTimeVerifyResult.message[0]='';me.getForm().findField('taxregNumber').setReadOnly(true);me.getForm().findField('companyProperty').setReadOnly(true);me.getForm().findField('taxregNumber').setValue();me.getForm().findField('companyProperty').setValue();me.memberData.getContactStore().each(function(record){if(record.get('isMainLinkMan')){me.validateIdNumber(record.get('idCard'),combox.getValue(),record.get('isMainLinkMan'));}});}else{RealTimeVerifyResult.success[5]=true;RealTimeVerifyResult.message[5]='';me.getForm().findField('taxregNumber').setReadOnly(false);me.getForm().findField('companyProperty').setReadOnly(false);}},validateIdNumber:function(idNumber,custType,isMainContact){var me=this;if(Ext.isEmpty(idNumber)){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.m_idCardNotNull'));RealTimeVerifyResult.success[5]=false;RealTimeVerifyResult.message[5]=i18n('i18n.MemberCustEditView.m_idCardNotNull');return;}
var validateSuccessFn=function(result){if(!result.exist){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.m_idCardIsExsit'));return;}};var validateFailFn=function(result){if(DpUtil.isEmpty(result.message)){result.message=i18n('i18n.MemberCustEditView.anExceptionBackgroundAppearsWar');}
MessageUtil.showMessage(result.message);return;};var params={};params.idNumber=idNumber;params.custType=custType;params.isMainContact=isMainContact;if('PERSONAL'==custType&&isMainContact){me.memberData.validateIdNumberIsExist(params,validateSuccessFn,validateFailFn);}},checkContactIsModify:function(){var me=this;var contactStore=me.memberData.getContactStore();var accountStore=me.memberData.getAccountStore();var i=0;accountStore.each(function(accountRecord){contactStore.each(function(contactRecord){if(contactRecord.get('name')==accountRecord.get('financeLinkman')&&contactRecord.get('mobilePhone')==accountRecord.get('linkManMobile')&&Contactrecord.get('telPhone')==accountRecord.get('linkManPhone')){i++;}})});if(i!=accountStore.getCount()){RealTimeVerifyResult.success[3]=false;RealTimeVerifyResult.message[3]=i18n('i18n.MemberCustEditView.m_contactIsUpdate');}else{RealTimeVerifyResult.success[3]=true;RealTimeVerifyResult.message[3]='';}},selectIsParentCompanyEvent:function(combox,records){var me=this;if(combox.getValue()==true){me.getForm().findField('parentCompanyId').setReadOnly(true);me.getForm().findField('parentCompanyId').setValue();}else{me.getForm().findField('parentCompanyId').setReadOnly(false);}},selectIsFocusPay:function(combox,records){var me=this;if(combox.getValue()==false){me.getForm().findField('focusDeptId').setReadOnly(true);me.getForm().findField('focusDeptId').setValue();}else{me.getForm().findField('focusDeptId').setReadOnly(false);}},changeParentCompanyId:function(combox,record){var me=this;var parentCompanyNumber=combox.getRawValue();me.getForm().findField('parentNumber').setValue(parentCompanyNumber);},validateMemberBasicInfo:function(){var me=this;var success=true;var message='';if(me.getForm().isValid()){var custType=me.getForm().findField('custType');var taxNumber=me.getForm().findField('taxregNumber');var companyProperty=me.getForm().findField('companyProperty');if(custType.getValue()=='ENTERPRISE'&&(DpUtil.isEmpty(taxNumber.getValue())||DpUtil.isEmpty(companyProperty.getValue()))){message=i18n('i18n.MemberCustEditView.m_must_taxAndCustNature');success=false;}else{var isFocusPay=me.getForm().findField('isFocusPay');var focusDept=me.getForm().findField('focusDeptId');if(isFocusPay.getValue()==true&&DpUtil.isEmpty(focusDept.getValue())){message=i18n('i18n.MemberCustEditView.m_must_focusDept');success=false;}else{var isParentCompany=me.getForm().findField('isParentCompany');var parentCompany=me.getForm().findField('parentCompanyId');if(isParentCompany.getValue()==0&&DpUtil.isEmpty(parentCompany)){message=i18n('i18n.MemberCustEditView.m_msut_mainCompany');success=false;}}}}else{message=i18n('i18n.MemberCustEditView.m_must_fillForm');success=false;}
return{'success':success,'message':message};},collectMemberBasicData:function(){var me=this;me.getForm().updateRecord(me.memberBasicRecord);me.manageModel4City(me.memberBasicRecord);return me.memberBasicRecord.data;},collectAlterMemberData:function(alterMemberList){var me=this;me.getForm().updateRecord(me.memberBasicRecord);me.manageModel4City(me.memberBasicRecord);var fieldsArray=me.memberBasicRecord.fields.items;for(var i=0;i<fieldsArray.length;i++){var fieldName=fieldsArray[i].name;if(me.memberBasicRecord.isModified(fieldName)){var basicApproveData=me.getEmptyMemberApproveData();basicApproveData.set('fieldName',fieldName);basicApproveData.set('newValue',me.memberBasicRecord.get(fieldName));alterMemberList.push(basicApproveData.data);}}},getEmptyMemberApproveData:function(){var me=this;var basicApproveData=Ext.create('ApproveDataModel');basicApproveData.set('className','Member');basicApproveData.set('classId',me.memberBasicRecord.get('id'));return basicApproveData;},manageModel4City:function(memberModel){var me=this;if(!Ext.isEmpty(memberModel)){var city=memberModel.get('cityId');if(!Ext.isEmpty(city)){var pca=city.split(i18n('i18n.PotentialCustManagerView.searchEndTime'));if(pca.length>1){memberModel.set('cityId',pca[1]);memberModel.set('provinceId',pca[0]);}}
return memberModel;}
return memberModel;}});Ext.define('MemberLinkmanTabPanel',{extend:'TabContentPanel',title:'联系人信息<span style="color:red;">*</span>',layout:{type:'vbox',align:'stretch'},items:null,parent:null,memberData:null,memberLinkmanData:null,initComponent:function(){var me=this;me.items=me.getItems();this.callParent();me.loadLinkmanData();},loadLinkmanData:function(memberLinkmanData){var me=this;if(memberLinkmanData!=null){me.memberLinkmanData=memberLinkmanData;}
me.memberData.getContactStore().removeAll();if(me.memberLinkmanData!=null){me.memberData.getContactStore().loadData(me.memberLinkmanData);}},getItems:function(){var me=this;return[{xtype:'normalbuttonpanel',items:[{xtype:'popleftbuttonpanel',items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.add'),scope:me,handler:me.showCreateMemberLinkman},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.update'),scope:me,handler:me.showUpdateMemberLinkman},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.delete'),scope:me,handler:me.delteMemberLinkman}]},{xtype:'middlebuttonpanel'}]},{xtype:'popupgridpanel',flex:1,store:me.memberData.getContactStore(),columns:[{text:i18n('i18n.MemberCustEditView.contactNo'),dataIndex:'number'},{text:i18n('i18n.PotentialCustManagerView.contactName'),dataIndex:'name'},{text:i18n('i18n.MemberCustEditView.contactType'),dataIndex:'linkmanType',renderer:me.renderLinkmanType},{text:i18n('i18n.MemberCustEditView.gender'),width:60,dataIndex:'sex',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.GENDER);}},{text:i18n('i18n.MemberCustEditView.post'),dataIndex:'duty'},{text:i18n('i18n.MemberCustEditView.mobileNo'),dataIndex:'mobilePhone'},{text:i18n('i18n.MemberCustEditView.telephoneNo'),dataIndex:'telPhone'},{text:i18n('i18n.MemberCustEditView.isMainContact'),dataIndex:'isMainLinkMan',renderer:DpUtil.changeBooleanToDescrip}],listeners:{scope:me,itemdblclick:function(grid,record){me.getContactWin(me.memberData,record,'view',me.parent);}}}];},showCreateMemberLinkman:function(){var me=this;if(Ext.isEmpty(me.parent.memberCustBasicInfo.getForm().findField('custType').getValue())){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.m_custTypeMust'));return;}
var contactModel=Ext.create('ContactModel');me.getContactWin(me.memberData,contactModel,'new',me);},showUpdateMemberLinkman:function(){var me=this;if(Ext.isEmpty(me.parent.memberCustBasicInfo.getForm().findField('custType').getValue())){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.m_custTypeMust'));return;}
var grid=me.down('grid');var selectModel=grid.getSelectionModel();var selections=selectModel.getSelection();if(selections.length!=1){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.pleaseOneRecordToUpdate'));}else{var selected=selections[0];me.getContactWin(me.memberData,selected,'update',me);}},getContactWin:function(memberData,record,viewStatus,parent){Ext.create('MemberLinkmanEditWindow',{'memberData':memberData,'contactRecord':record,'parent':parent,'viewStatus':viewStatus}).show();},delteMemberLinkman:function(){var me=this;var grid=me.down('grid');var selectModel=grid.getSelectionModel();var selections=selectModel.getSelection();if(selections.length!=1){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.pleaseOneRecordToDelete'));}else{var selected=selections[0];var createSource=selected.get('createSource');if(createSource==1||createSource==2){var tipMsg=(createSource==1)?i18n('i18n.MemberCustEditView.FITUpgradeList'):i18n('i18n.MemberCustEditView.real-timeCreateMembershipInformation');MessageUtil.showMessage(i18n('i18n.MemberCustEditView.m_linkManSource')+tipMsg+i18n('i18n.MemberCustEditView.canNotDeleteWar'));}else{MessageUtil.showQuestionMes(i18n('i18n.PotentialCustManagerView.confirm_message'),function(btn){if(btn=='yes'){me.memberData.getContactStore().remove(selected);me.delContactRealTimeVerifyResult(selected);}});}}},delContactRealTimeVerifyResult:function(selected){var me=this;var contactIdCardArray=[];var contactMobileArray=[];var idCardArray=RealTimeVerifyResult.message[1];var mobileArray=RealTimeVerifyResult.message[2];for(var i=0;i<idCardArray.length;i++){if(selected.get('id')!=idCardArray[i].contactId){contactIdCardArray.push(idCardArray[i]);}}
for(var j=0;j<mobileArray.length;j++){if(selected.get('id')!=mobileArray[j].contactId){contactMobileArray.push(idCardArray[j]);}}
RealTimeVerifyResult.message[1]=contactIdCardArray;RealTimeVerifyResult.message[2]=contactMobileArray;if(selected.get('isMainLinkMan')&&'PERSONAL'==me.parent.memberCustBasicInfo.getForm().findField('custType').getValue()){RealTimeVerifyResult.success[5]=true;RealTimeVerifyResult.message[5]='';}},renderLinkmanType:function(linkmanTypeString){var linkmanTypeValue='';var linkmanTypeArray=linkmanTypeString.split(',');if(linkmanTypeArray!=null){for(var i=0;i<linkmanTypeArray.length;i++){if(linkmanTypeArray[i]=='true'||linkmanTypeArray[i]=='1'){if(i!=0&&!DpUtil.isEmpty(linkmanTypeValue)){linkmanTypeValue+=',';}
linkmanTypeValue+=DpUtil.changeDictionaryCodeToDescrip(i,DataDictionary.LINKMANTYPE);}}}
return linkmanTypeValue;},collectLinkmanForMemberSubmit:function(){var me=this;var contacts=new Array();MemberCustEditView.changeLinkmanTypeForSubmit(contacts,me.memberData.getContactStore().getRange());return contacts;},validateLinkman:function(){var me=this;var success=true;var message='';var contactStore=me.memberData.getContactStore();if(contactStore.getCount()==0){success=false;message=i18n('i18n.MemberCustEditView.m_mustContactNotNull');}else{var records=contactStore.getRange();for(var i=0;i<records.length&&success;i++){if(!records[i].isValid()){success=false;message=i18n('i18n.MemberCustEditView.contactInformationToFillInIncomplete');return{'success':success,'message':message};}}}
return{'success':success,'message':message};},collectAllLinkmanAlterData:function(alterMemberList,alterDeleteList,alterAddLinkmanList,alterAddAddressHobbyList){var me=this;var linkmanStore=me.memberData.getContactStore();for(var i=0;i<linkmanStore.getCount();i++){var eachLinkAlterData=linkmanStore.getAt(i).get('alterLinkmanData');if(eachLinkAlterData!=null&&eachLinkAlterData.length>0){for(var j=0;j<eachLinkAlterData.length;j++){var linkAlterData=eachLinkAlterData[j];if('linkmanType'==linkAlterData.fieldName&&'Contact'==linkAlterData.className&&!Ext.isEmpty(linkAlterData.newValue)){linkAlterData.newValue=linkAlterData.newValue.replaceAll('true','1').replaceAll('false','0')
alterMemberList.push(linkAlterData);}else{alterMemberList.push(linkAlterData);}}}
var eachDelteAlterData=linkmanStore.getAt(i).get('delAddressHobbyData');if(eachDelteAlterData!=null&&eachDelteAlterData.length>0){for(var j=0;j<eachDelteAlterData.length;j++){alterDeleteList.push(eachDelteAlterData[j].data);}}
var eachAddAlterData=linkmanStore.getAt(i).get('addAddressHobbyData');var linkManId=linkmanStore.getAt(i).get('id');if(eachAddAlterData!=null&&eachAddAlterData.length>0){for(var j=0;j<eachAddAlterData.length;j++){eachAddAlterData[j].linkManId=linkManId;alterAddAddressHobbyList.push(eachAddAlterData[j]);}}}
var deleteLinkmanRecords=me.memberData.getContactStore().getRemovedRecords();for(var i=0;i<deleteLinkmanRecords.length;i++){alterDeleteList.push(me.getEmptyMemberLinkBasicApproveData(deleteLinkmanRecords[i]).data);}
var addLinkmanRecords=me.memberData.getContactStore().getNewRecords();MemberCustEditView.changeLinkmanTypeForSubmit(alterAddLinkmanList,addLinkmanRecords);},getEmptyMemberLinkBasicApproveData:function(deleteContactRecord){var me=this;var basicApproveData=Ext.create('ApproveDataModel');basicApproveData.set('className','Contact');basicApproveData.set('classId',deleteContactRecord.get('id'));return basicApproveData;}});Ext.define('MemberAccountTabPanel',{extend:'TabContentPanel',title:i18n('i18n.MemberCustEditView.accountInfo'),layout:{type:'vbox',align:'stretch'},items:null,memberData:null,memberAccountData:null,viewStatus:null,initComponent:function(){var me=this;me.items=me.getItems();this.callParent();me.loadMemberAccountData();},loadMemberAccountData:function(memberAccountData){var me=this;if(memberAccountData!=null){me.memberAccountData=memberAccountData;}
me.memberData.getAccountStore().removeAll();if(me.memberAccountData!=null){me.memberData.getAccountStore().loadData(me.memberAccountData);}},getItems:function(){var me=this;return[{xtype:'normalbuttonpanel',items:[{xtype:'popleftbuttonpanel',items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.add'),hidden:!isPermission('/customer/accountRecognizedABtn.action')&&('update'==me.viewStatus),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.showCreateAccountWin},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.update'),hidden:!isPermission('/customer/accountRecognizedUBtn.action')&&('update'==me.viewStatus),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.showUpdateAccountWin},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.delete'),hidden:!isPermission('/customer/accountRecognizedDBtn.action')&&('update'==me.viewStatus),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.deleteAccount}]},{xtype:'middlebuttonpanel'}]},{xtype:'popupgridpanel',flex:1,store:me.memberData.getAccountStore(),columns:[{text:i18n('i18n.MemberCustEditView.openBank'),dataIndex:'bank'},{text:i18n('i18n.MemberCustEditView.openName'),dataIndex:'countName'},{text:i18n('i18n.MemberCustEditView.accountNo'),dataIndex:'bankAccount'},{text:i18n('i18n.MemberCustEditView.accountPurpose'),dataIndex:'accountUse',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.ACCOUNT_USE);}},{text:i18n('i18n.MemberCustEditView.accountContactName'),dataIndex:'financeLinkman'},{text:i18n('i18n.MemberCustEditView.contactPhone'),dataIndex:'linkManMobile'},{text:i18n('i18n.MemberCustEditView.contactTel'),dataIndex:'linkManPhone'},{text:i18n('i18n.MemberCustEditView.isAcquiesceAccount'),dataIndex:'isdefaultaccount',renderer:DpUtil.changeBooleanToDescrip},{text:i18n('i18n.MemberCustEditView.CRAccount'),dataIndex:'relation'},{text:i18n('i18n.MemberCustEditView.accountProvince'),dataIndex:'bankProvinceName',hidden:true},{text:i18n('i18n.MemberCustEditView.accountCity'),dataIndex:'bankCityName',hidden:true},{text:i18n('i18n.MemberCustEditView.accountProvinceid'),dataIndex:'bankProvinceId',hidden:true},{text:i18n('i18n.MemberCustEditView.accountCityid'),dataIndex:'bankCityId',hidden:true}],listeners:{scope:me,itemdblclick:function(grid,record){me.getAccountWin(me.memberData,record,'view');}}}];},showCreateAccountWin:function(){var me=this;var newAccountRecord=Ext.create('AccountModel');me.getAccountWin(me.memberData,newAccountRecord,'new');},showUpdateAccountWin:function(){var me=this;var grid=me.down('grid');var selectModel=grid.getSelectionModel();var selections=selectModel.getSelection();if(selections.length!=1){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.pleaseOneRecordToUpdate'));}else{var selected=selections[0];me.getAccountWin(me.memberData,selected,'update');}},getAccountWin:function(memberData,record,viewStatus){Ext.create('MemberAccountEditWin',{'memberData':memberData,'accountRecord':record,'viewStatus':viewStatus}).show();},deleteAccount:function(){var me=this;var grid=me.down('grid');var selectModel=grid.getSelectionModel();var selections=selectModel.getSelection();if(selections.length!=1){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.pleaseOneRecordToDelete'));}else{var selected=selections[0];MessageUtil.showQuestionMes(i18n('i18n.PotentialCustManagerView.confirm_message'),function(btn){if(btn=='yes'){me.memberData.getAccountStore().remove(selected);}});}},collectMemberAccountsForSubmit:function(){var me=this;var accountArray=new Array();me.memberData.getAccountStore().each(function(record){accountArray.push(record.data);});return accountArray;},validateAccount:function(){var me=this;var success=true;var message='';var accountStore=me.memberData.getAccountStore();if(accountStore.getCount()!=0){var records=accountStore.getRange();for(var i=0;i<records.length&&success;i++){if(!records[i].isValid()){success=false;message=i18n('i18n.MemberCustEditView.accountInformationFillIncompleteWar');return{'success':success,'message':message};}}}
return{'success':success,'message':message};},collectAllAcountAlterData:function(alterContactList,alterDeleteList,alterAddAccountList){var me=this;var updatedAccountRecords=me.memberData.getAccountStore().getUpdatedRecords();if(updatedAccountRecords.length>0){var fieldsArray=updatedAccountRecords[0].fields.items;for(var j=0;j<updatedAccountRecords.length;j++){for(var i=0;i<fieldsArray.length;i++){var fieldName=fieldsArray[i].name;if(updatedAccountRecords[j].isModified(fieldName)){var basicApproveData=me.getEmptyAccountApproveData(updatedAccountRecords[j]);basicApproveData.set('fieldName',fieldName);basicApproveData.set('newValue',updatedAccountRecords[j].get(fieldName));alterContactList.push(basicApproveData.data);}}}}
var deleteAccountRecords=me.memberData.getAccountStore().getRemovedRecords();for(var i=0;i<deleteAccountRecords.length;i++){alterDeleteList.push(me.getEmptyAccountApproveData(deleteAccountRecords[i]).data);}
var addAccountRecords=me.memberData.getAccountStore().getNewRecords();for(var i=0;i<addAccountRecords.length;i++){alterAddAccountList.push(addAccountRecords[i].data);}},getEmptyAccountApproveData:function(accountRecord){var me=this;var basicApproveData=Ext.create('ApproveDataModel');basicApproveData.set('className','Account');basicApproveData.set('classId',accountRecord.get('id'));return basicApproveData;}});Ext.define('MemberAddressTabPanel',{extend:'TabContentPanel',title:i18n('i18n.MemberCustEditView.shuttleAddress'),layout:{type:'vbox',align:'stretch'},items:null,memberData:null,memberAddressData:null,viewStatus:null,initComponent:function(){var me=this;me.items=me.getItems();this.callParent();me.loadMemberAddressData();},loadMemberAddressData:function(memberAddressData){var me=this;if(memberAddressData!=null){me.memberAddressData=memberAddressData;}
me.memberData.getShuttleAddressStore().removeAll();if(me.memberAddressData!=null){me.memberData.getShuttleAddressStore().loadData(me.memberAddressData);}},getItems:function(){var me=this;return[{xtype:'normalbuttonpanel',items:[{xtype:'popleftbuttonpanel',items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.add'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.showCreateMemberAddr},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.update'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.showUpdateMemberAddr},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.delete'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.deleteMemberAddress}]},{xtype:'middlebuttonpanel'}]},{xtype:'popupgridpanel',flex:1,store:me.memberData.getShuttleAddressStore(),columns:[{text:i18n('i18n.MemberCustEditView.addressType'),flex:1,dataIndex:'addressType',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.ADDRESS_TYPE);}},{text:i18n('i18n.PotentialCustEditView.address'),flex:1,dataIndex:'address'}],listeners:{scope:me,itemdblclick:function(grid,record){var win=me.getAddressWin(me.memberData,record,'view');win.show();win.down('form').getForm().findField('address').setValue(record.get('address'));}}}];},validateAddress:function(){var me=this;var success=true;var message='';var addressStore=me.memberData.getShuttleAddressStore();if(addressStore.getCount()!=0){var records=addressStore.getRange();for(var i=0;i<records.length&&success;i++){if(!records[i].isValid()){success=false;message=i18n('i18n.MemberCustEditView.accessShippingAddressIncomplete');return{'success':success,'message':message};}}}
return{'success':success,'message':message};},showCreateMemberAddr:function(){var me=this;var addressModel=Ext.create('ShuttleAddressModel');me.getAddressWin(me.memberData,addressModel,'new').show();},showUpdateMemberAddr:function(){var me=this;var grid=me.down('grid');var selectModel=grid.getSelectionModel();var selections=selectModel.getSelection();if(selections.length!=1){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.pleaseOneRecordToUpdate'));}else{var selected=selections[0];var win=me.getAddressWin(me.memberData,selected,'update');win.show()
win.down('form').getForm().findField('address').setValue(selected.get('address'));}},getAddressWin:function(memberData,record,viewStatus){var win=Ext.create('MemberAddressEditwin',{'memberData':memberData,'shuttleAddressRecord':record,'viewStatus':viewStatus});return win;},deleteMemberAddress:function(){var me=this;var grid=me.down('grid');var selectModel=grid.getSelectionModel();var selections=selectModel.getSelection();if(selections.length!=1){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.pleaseOneRecordToDelete'));}else{var selected=selections[0];MessageUtil.showQuestionMes(i18n('i18n.PotentialCustManagerView.confirm_message'),function(btn){if(btn=='yes'){me.memberData.getShuttleAddressStore().remove(selected);var contactStore=me.memberData.getContactStore();var address=selected.get('address');var addressType=selected.get('addressType');for(var i=0;i<contactStore.getCount();i++){var addressHobbyArray=contactStore.getAt(i).get('preferenceAddressList');if(!DpUtil.isEmpty(addressHobbyArray)){for(var j=0;j<addressHobbyArray.length;j++){if(addressHobbyArray[i].address==address&&addressHobbyArray[i].addressType==addressType){addressHobbyArray.pop(addressHobbyArray[i]);}}
contactStore.getAt(i).set('preferenceAddressList',addressHobbyArray);}}}});}},collectShuttleAddressForSubmit:function(){var me=this;var shuttleAddress=new Array();me.memberData.getShuttleAddressStore().each(function(record){shuttleAddress.push(record.data);});return shuttleAddress;},collectAllAddressAlterData:function(alterContactList,alterDeleteList,alterAddAddressList){var me=this;var updatedAddressRecords=me.memberData.getShuttleAddressStore().getUpdatedRecords();if(updatedAddressRecords.length>0){var fieldsArray=updatedAddressRecords[0].fields.items;for(var j=0;j<updatedAddressRecords.length;j++){for(var i=0;i<fieldsArray.length;i++){var fieldName=fieldsArray[i].name;if(updatedAddressRecords[j].isModified(fieldName)){var basicApproveData=me.getEmptyAddressApproveData(updatedAddressRecords[j]);basicApproveData.set('fieldName',fieldName);basicApproveData.set('newValue',updatedAddressRecords[j].get(fieldName));alterContactList.push(basicApproveData.data);}}}}
var deleteAddressRecords=me.memberData.getShuttleAddressStore().getRemovedRecords();for(var i=0;i<deleteAddressRecords.length;i++){alterDeleteList.push(me.getEmptyAddressApproveData(deleteAddressRecords[i]).data);}
var addAddressRecords=me.memberData.getShuttleAddressStore().getNewRecords();for(var i=0;i<addAddressRecords.length;i++){alterAddAddressList.push(addAddressRecords[i].data);}},getEmptyAddressApproveData:function(addressRecord){var me=this;var basicApproveData=Ext.create('ApproveDataModel');basicApproveData.set('className','ShuttleAddress');basicApproveData.set('classId',addressRecord.get('id'));return basicApproveData;}});Ext.define('MemberLinkmanEditWindow',{extend:'PopWindow',title:i18n('i18n.MemberCustEditView.contactEditUI'),linkmanBasicInfo:null,linkmanAddressHobbyInfo:null,parent:null,layout:{type:'vbox',align:'stretch'},items:null,width:825,height:500,fbar:null,memberData:null,contactRecord:null,viewStatus:null,initComponent:function(){var me=this;me.linkmanBasicInfo=Ext.create('MemberLinkmanForm',{'memberData':me.memberData,'contactRecord':me.contactRecord,'parent':me});me.linkmanAddressHobbyInfo=Ext.create('MemberLinkmanHobby',{'viewStatus':me.viewStatus,'memberData':me.memberData,'contactRecord':me.contactRecord});me.items=[{xtype:'basicpanel',height:230,items:[me.linkmanBasicInfo]},{xtype:'basicpanel',flex:1,items:[me.linkmanAddressHobbyInfo]}];me.fbar=me.getFbar();this.callParent();if(me.viewStatus=='new'){me.linkmanBasicInfo.getForm().reset();}
me.initBusinessComponent();if(me.viewStatus=='view'){me.lockAllComponents();}},initBusinessComponent:function(){var me=this;var linkmanBasicForm=me.linkmanBasicInfo.getForm();var mobile=linkmanBasicForm.findField('mobilePhone');var phone=linkmanBasicForm.findField('telPhone');var linkmanName=linkmanBasicForm.findField('name');if(me.viewStatus=='update'&&me.contactRecord.get('createSource')==1){linkmanName.setReadOnly(true);if(!DpUtil.isEmpty(mobile.getValue())){mobile.setReadOnly(true);}else if(!DpUtil.isEmpty(phone.getValue())){phone.setReadOnly(true);}}
else if(me.viewStatus=='update'&&me.contactRecord.get('createSource')==2){if(!DpUtil.isEmpty(mobile.getValue())){mobile.setReadOnly(true);}else if(!DpUtil.isEmpty(phone.getValue())&&!DpUtil.isEmpty(linkmanName.getValue())){phone.setReadOnly(true);linkmanName.setReadOnly(true);}}},getFbar:function(){var me=this;return[{xtype:'button',text:i18n('i18n.MemberCustEditView.submit'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.commitMemberLinkman},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),handler:function(){me.close();}}];},commitMemberLinkman:function(){var me=this;if(!RealTimeVerifyResult.success[5]){MessageUtil.showMessage(RealTimeVerifyResult.message[5]);return;}
var validateLinkmanRs=me.validateLinkman();if(validateLinkmanRs.success){var titleDescrip=(me.viewStatus=='new')?i18n('i18n.PotentialCustManagerView.add'):i18n('i18n.PotentialCustManagerView.update');MessageUtil.showQuestionMes(i18n('i18n.MemberCustEditView.sureYouWantTo')+titleDescrip+'这条联系人信息?',function(btn){if(btn=='yes'){me.linkmanBasicInfo.getForm().updateRecord(me.contactRecord);me.contactRecord.set('preferenceAddressList',me.linkmanAddressHobbyInfo.collectLinkmanAddressHobbyForSubmit());if(me.viewStatus=='new'){me.memberData.getContactStore().insert(0,me.contactRecord);}else if(me.viewStatus=='update'){if(!me.contactRecord.phantom){var alterContactList=new Array();var alterDeleteList=new Array();var alterAddList=new Array();me.linkmanBasicInfo.collectLinkmanBasicAlterData(alterContactList);me.linkmanAddressHobbyInfo.collectLinkmanAddrHobbyAlterData(alterContactList,alterDeleteList,alterAddList);me.contactRecord.set('alterLinkmanData',alterContactList);me.contactRecord.set('delAddressHobbyData',alterDeleteList);me.contactRecord.set('addAddressHobbyData',alterAddList);}}
me.close();}});}else if(!DpUtil.isEmpty(validateLinkmanRs.message)){MessageUtil.showMessage(validateLinkmanRs.message);}},validateLinkman:function(){var me=this;var success=true;var message='';var validateLinkmanBasicRs=me.linkmanBasicInfo.validateLinkmanInfo();if(!validateLinkmanBasicRs.success){success=false;message=validateLinkmanBasicRs.message;}else{var validateAddressRs=me.linkmanAddressHobbyInfo.validateLinkmanAddressHobby();if(!validateAddressRs.success){success=false;message=validateAddressRs.message;}}
return{'success':success,'message':message};},lockAllComponents:function(){var me=this;var linkmanBasicForm=me.linkmanBasicInfo.getForm();linkmanBasicForm.getFields().each(function(field){field.setReadOnly(true);});}});Ext.define('MemberLinkmanForm',{extend:'NoBorderFormPanel',id:'memberLinkmanForm_id',items:null,fireTimes:0,parent:null,memberData:null,contactRecord:null,initComponent:function(){var me=this;me.items=me.getItems();me.defaults.listeners={scope:me,keypress:me.enterKeyEvent};this.callParent();me.getForm().loadRecord(me.contactRecord);},layout:{type:'table',columns:8},defaultType:'textfield',defaults:{labelWidth:65,width:185,enableKeyEvents:true,listeners:null},getItems:function(){var me=this;return[{fieldLabel:i18n('i18n.MemberCustEditView.contactNo'),emptyText:'姓名首字母+联系方式',allowBlank:false,name:'number',regex:/^[a-z]{1,20}[0-9]{7,12}$/,blankText:'请输入联系人编码，规则为姓名首字母+联系方式(优先选手机号码)',regexText:'联系人编码由联系人姓名首字母(小写)+手机号码/固定电话组成',minLength:10,minLengthText:i18n('i18n.MemberCustEditView.contactNumMustSmall10'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),listeners:{scope:me,blur:me.blur2Lower}},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.PotentialCustManagerView.contactName'),allowBlank:false,maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),blankText:i18n('i18n.MemberCustEditView.pleaseInputContactName'),name:'name'},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.ScatterCustManagerView.idNumber'),name:'idCard',id:'contactIdCard',vtype:'alphanum',maxLength:18,minLength:15,regex:/^([\d]{15}|[\d]{18}|[\d]{17}X)$/,regexText:i18n('i18n.MemberCustEditView.cardNum15118LastxX'),blankText:i18n('i18n.MemberCustEditView.idCardAlert'),listeners:{scope:me,blur:me.validateIdNumberIsExsist}},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.isMainContact'),name:'isMainLinkMan',allowBlank:false,xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'name',valueField:'value',store:me.memberData.getBooleanStore(),blankText:i18n('i18n.MemberCustEditView.isMainContactAlert'),listeners:{scope:me,select:me.selectIsMainLinkMan}},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{xtype:'checkboxgroup',fieldLabel:i18n('i18n.MemberCustEditView.contactType'),columns:6,colspan:7,width:622,vertical:true,defaults:{listeners:{scope:me,specialkey:me.enterKeyEvent,render:function(checkBox){if(me.contactRecord!=null){var linkmanTypeString=me.contactRecord.get('linkmanType');if(!DpUtil.isEmpty(linkmanTypeString)){var linkmanTypeArray=linkmanTypeString.split(',');if(linkmanTypeArray[checkBox.inputValue]!=null){checkBox.setValue(linkmanTypeArray[checkBox.inputValue]);if('0'==checkBox.inputValue&&'0'==linkmanTypeArray[0]){checkBox.setValue(false);}}}}}}},allowBlank:false,blankText:i18n('i18n.MemberCustEditView.contactTypeAlert'),items:[{boxLabel:i18n('i18n.MemberCustEditView.financeContact'),name:'linkmanType',inputValue:'0'},{boxLabel:i18n('i18n.MemberCustEditView.businessContact'),name:'linkmanType',inputValue:'1'},{boxLabel:i18n('i18n.MemberCustEditView.deliverContact'),name:'linkmanType',inputValue:'2'},{boxLabel:i18n('i18n.MemberCustEditView.receiveContact'),name:'linkmanType',inputValue:'3'},{boxLabel:i18n('i18n.MemberCustEditView.agreementContact'),name:'linkmanType',inputValue:'4'},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12}]},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.gender'),allowBlank:false,xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.memberData.getGenderStore(),name:'sex',blankText:i18n('i18n.MemberCustEditView.genderAlert')},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.telephoneNo'),regex:DpUtil.linkWayLimit('T'),regexText:i18n('i18n.MemberCustEditView.pleaseInputPhone'),name:'telPhone'},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.mobileNo'),name:'mobilePhone',regex:DpUtil.linkWayLimit('M'),regexText:i18n('i18n.MemberCustEditView.pleaseInputCorrectMobilePhone'),listeners:{scope:me,blur:me.validateMobileIsExsist}},{xtype:'displayfield',value:'<span style="color:red;">*</span>',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.post'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'duty'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.officeholdingDept'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'dutyDept'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.birthDate'),id:'contactBrithday',name:'bornDate',xtype:'dpdatefield',format:'Y-m-d',maxValue:new Date()},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.companyWay'),name:'gainave'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.logisticsDecision'),name:'decisionRight',xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.memberData.getLogistDeciStore()},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.nativeAddress'),name:'nativePlace',maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20)},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.hobby'),maxLength:100,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',100),name:'personLove'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.nation'),maxLength:20,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',20),name:'folk'},{xtype:'displayfield',width:12},{fieldLabel:'Email',maxLength:50,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',50),name:'email',vtype:'email'},{xtype:'displayfield',width:12},{fieldLabel:'QQ',name:'qqNumber',regex:/^[1-9][0-9]{4,19}$/,regexText:i18n('i18n.MemberCustEditView.QQNumMust510AndFristNot1')},{xtype:'displayfield',width:12},{fieldLabel:'MSN',maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'msn'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.wangWang'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'ww'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.aLiId'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'alid'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.netsCampId'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'onlineBusinessId'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.taoBaoId'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'taobId'},{xtype:'displayfield',width:12},{fieldLabel:i18n('i18n.MemberCustEditView.kingDeeId'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'youshangId'},{xtype:'displayfield',width:12}];},blur2Lower:function(textfield){if(!Ext.isEmpty(textfield.getValue())){textfield.setValue(textfield.getValue().toLowerCase());}},selectIsMainLinkMan:function(combox,records){var me=this;if(records.length>0){var idNumber=me.getForm().findField('idCard').getValue();var custType=me.parent.parent.parent.memberCustBasicInfo.getForm().findField('custType').getValue();if(combox.getValue()){me.validateIdNumber(idNumber,custType,combox.getValue(),me);}}},validateIdNumberIsExsist:function(idNumberField){var me=this;if(!idNumberField.isValid()){return;}
var idNumber=idNumberField.getValue();var custType=me.parent.parent.parent.memberCustBasicInfo.getForm().findField('custType').getValue();var isMainContact=me.getForm().findField('isMainLinkMan').getValue();if(Ext.isEmpty(isMainContact)){me.getForm().findField('isMainLinkMan').setValue(false);isMainContact=false;}
me.validateIdNumber(idNumber,custType,isMainContact,me);},validateIdNumber:function(idNumber,custType,isMainContact,me){if(Ext.isEmpty(me)){me=this;}
if(Ext.isEmpty(me.contactRecord.get('id'))){me.contactRecord.set('id',me.getSequence());}
me.getForm().updateRecord(me.contactRecord);if(!me.contactRecord.isModified('idCard')){return;}
var validateSuccessFn=function(result){me.addIdCardContact(me.contactRecord.get('id'),true,'',me);if(!result.exist){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.m_contactIsExist'));RealTimeVerifyResult.success[5]=false;RealTimeVerifyResult.message[5]=i18n('i18n.MemberCustEditView.m_contactIsExist');return;}
RealTimeVerifyResult.success[5]=true;RealTimeVerifyResult.message[5]='';};var validateFailFn=function(result){if(DpUtil.isEmpty(result.message)){result.message=i18n('i18n.MemberCustEditView.anExceptionBackgroundAppearsWar');me.addIdCardContact(me.contactRecord.get('id'),false,result.message,me);}
me.addIdCardContact(me.contactRecord.get('id'),false,result.message,me);RealTimeVerifyResult.success[5]=true;RealTimeVerifyResult.message[5]='';};var params={};params.idNumber=idNumber;params.custType=custType;params.isMainContact=isMainContact;if('PERSONAL'==custType&&isMainContact){if(Ext.isEmpty(idNumber)){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.m_idCardNotNull'));RealTimeVerifyResult.success[5]=false;RealTimeVerifyResult.message[5]=i18n('i18n.MemberCustEditView.m_idCardNotNull');return;}
me.memberData.validateIdNumberIsExist(params,validateSuccessFn,validateFailFn);}},addIdCardContact:function(contactId,success,message,me){var idCardList=RealTimeVerifyResult.message[1];if(idCardList.length>0){var flag=true;for(var i=0;i<idCardList.length;i++){if(!Ext.isEmpty(contactId)&&contactId==idCardList[i].contactId){idCardList[i].success=success;idCardList[i].message=message;flag=false;}}
if(flag){idCardList.push({contactId:contactId,success:success,message:message});}}else{idCardList.push({contactId:contactId,success:success,message:message});}},validateMobileIsExsist:function(mobileField){var me=this;var mobile=mobileField.getValue();if(!mobileField.isValid()){return;}
if(!DpUtil.isEmpty(mobile)){if(Ext.isEmpty(me.contactRecord.get('id'))){me.contactRecord.set('id',me.getSequence());}
me.getForm().updateRecord(me.contactRecord);if(!me.contactRecord.isModified('mobilePhone')){return;}
var validateSuccessFn=function(result){me.addMobilContact(me.contactRecord.get('id'),true,'');};var validateFailFn=function(result){if(DpUtil.isEmpty(result.message)){result.message=i18n('i18n.MemberCustEditView.anExceptionBackgroundAppearsWar');}
me.addMobilContact(me.contactRecord.get('id'),false,result.message);MessageUtil.showMessage(result.message);};var params={};params.mobile=mobile;me.memberData.validateMobileIsExist(params,validateSuccessFn,validateFailFn);}},addMobilContact:function(contactId,success,message){var me=this;var mobilContactList=RealTimeVerifyResult.message[2];if(mobilContactList.length>0){var flag=true;for(var i=0;i<mobilContactList.length;i++){if(!Ext.isEmpty(contactId)&&contactId==mobilContactList[i].contactId){mobilContactList[i].success=success;mobilContactList[i].message=message;flag=false;}}
if(flag){mobilContactList.push({contactId:contactId,success:success,message:message});}}else{mobilContactList.push({contactId:contactId,success:success,message:message});}},getSequence:function(){return'X'+Sequence++;},enterKeyEvent:function(field,event){var me=this;if(event.getKey()==Ext.EventObject.ENTER){if(field.next()!=null&&field.fieldLabel!=i18n('i18n.MemberCustEditView.isMainContact')){if(field.fieldLabel==i18n('i18n.ScatterCustManagerView.idNumber')){me.getForm().findField('linkmanType').focus();}else if(field.name=='linkmanType'){field.next().focus();}else if(field.next().next()!=null){field.next().next().focus();}}else if(field.boxLabel==i18n('i18n.MemberCustEditView.agreementContact')){me.getForm().findField('isMainLinkMan').focus();}else if(field.fieldLabel==i18n('i18n.MemberCustEditView.isMainContact')){++me.fireTimes;if(me.fireTimes>1){field.next().next().focus();}}}},validateLinkmanInfo:function(){var me=this;var success=true;var message='';if(me.getForm().isValid()){var idCard=Ext.getCmp('contactIdCard').getValue();var birthday=Ext.getCmp('contactBrithday').getRawValue();if(idCard.length==18){if(!(idCard.substring(6,8)=='20')&&!(idCard.substring(6,8)=='19')){message=i18n('i18n.MemberCustEditView.m_idCardIvnconformity');success=false;return{'success':success,'message':message};}
if(parseInt(idCard.substring(10,12))>12||parseInt(idCard.substring(10,12))<0){message=i18n('i18n.MemberCustEditView.m_idCardIvnconformity');success=false;return{'success':success,'message':message};}
if(parseInt(idCard.substring(12,14))>31||parseInt(idCard.substring(12,14))<0){message=i18n('i18n.MemberCustEditView.m_idCardIvnconformity');success=false;return{'success':success,'message':message};}
if(!Ext.isEmpty(birthday)){var yeara=birthday.split(i18n('i18n.PotentialCustManagerView.searchEndTime'))[0];var montha=birthday.split(i18n('i18n.PotentialCustManagerView.searchEndTime'))[1];var daya=birthday.split(i18n('i18n.PotentialCustManagerView.searchEndTime'))[2];if(idCard.substring(6,10)!=yeara||idCard.substring(10,12)!=montha||idCard.substring(12,14)!=daya){message=i18n('i18n.MemberCustEditView.m_idCardBirthDate');success=false;return{'success':success,'message':message};}}}else if(idCard.length==15){if(parseInt(idCard.substring(8,10))>12||parseInt(idCard.substring(8,10))<0){message=i18n('i18n.MemberCustEditView.m_idCardIvnconformity');success=false;return{'success':success,'message':message};}
if(parseInt(idCard.substring(10,12))>31||parseInt(idCard.substring(10,12))<0){message=i18n('i18n.MemberCustEditView.m_idCardIvnconformity');success=false;return{'success':success,'message':message};}
if(!Ext.isEmpty(birthday)){var yeara=birthday.split(i18n('i18n.PotentialCustManagerView.searchEndTime'))[0];var montha=birthday.split(i18n('i18n.PotentialCustManagerView.searchEndTime'))[1];var daya=birthday.split(i18n('i18n.PotentialCustManagerView.searchEndTime'))[2];if(idCard.substring(4,8)!=yeara||idCard.substring(8,10)!=montha||idCard.substring(10,12)!=daya){message=i18n('i18n.MemberCustEditView.m_idCardBirthDate');success=false;return{'success':success,'message':message};}}}
var phone=me.getForm().findField('telPhone');var mobile=me.getForm().findField('mobilePhone');var linkmanName=me.getForm().findField('name');if(DpUtil.isEmpty(phone.getValue())&&DpUtil.isEmpty(mobile.getValue())){message=i18n('i18n.MemberCustEditView.m_mustLinkWay');success=false;}else{var linkmanNumber=me.getForm().findField('number');if(!DpUtil.isEmpty(mobile.getValue())&&linkmanNumber.getValue().indexOf(mobile.getValue())!=me.getForm().findField('name').getValue().length){message='存在手机号码，联系人编码规则为：联系人姓名首字母(小写)+手机号码!';success=false;}
else{var linkmans=me.memberData.getContactStore().getRange();for(var i=0;i<linkmans.length;i++){if(!DpUtil.isEmpty(mobile.getValue())&&linkmans[i]!=me.contactRecord&&linkmans[i].get('mobilePhone')==mobile.getValue()){message=i18n('i18n.MemberCustEditView.haveSameContactPhonePleaseUpdateContactPhone');success=false;return{'success':success,'message':message};}else if(DpUtil.isEmpty(mobile.getValue())&&!DpUtil.isEmpty(phone.getValue())&&linkmans[i]!=me.contactRecord&&linkmans[i].get('telPhone')==phone.getValue()&&linkmans[i].get('name')==linkmanName.getValue()){message=i18n('i18n.MemberCustEditView.haveSamePhoneAndNamePleaseUpdatePhoneAndName');success=false;return{'success':success,'message':message};}else if(linkmans[i]!=me.contactRecord&&linkmans[i].get('number')==linkmanNumber.getValue()){message=i18n('i18n.MemberCustEditView.haveSameContactNumNotAddContactPleaseUpdateContactNum');success=false;return{'success':success,'message':message};}}
if(me.getForm().findField('isMainLinkMan').getValue()==true){var recordIndex=me.memberData.getContactStore().find('isMainLinkMan',true);if(recordIndex!=-1&&me.contactRecord!=me.memberData.getContactStore().getAt(recordIndex)){message=i18n('i18n.MemberCustEditView.aCustomerOnlyHaveMainContact');success=false;}}}}}else{success=false;message=i18n('i18n.RecordEditView.m_checkAllRight');}
return{'success':success,'message':message};},collectLinkmanBasicAlterData:function(alterContactList){var me=this;me.getForm().updateRecord(me.contactRecord);var fieldsArray=me.contactRecord.fields.items;for(var i=0;i<fieldsArray.length;i++){var fieldName=fieldsArray[i].name;if(me.contactRecord.isModified(fieldName)){var basicApproveData=me.getEmptyMemberLinkBasicApproveData();basicApproveData.set('fieldName',fieldName);basicApproveData.set('newValue',me.contactRecord.get(fieldName));alterContactList.push(basicApproveData.data);}}},getEmptyMemberLinkBasicApproveData:function(){var me=this;var basicApproveData=Ext.create('ApproveDataModel');basicApproveData.set('className','Contact');basicApproveData.set('classId',me.contactRecord.get('id'));return basicApproveData;}});Ext.define('MemberLinkmanHobby',{extend:'BasicPanel',layout:'fit',items:null,memberData:null,contactRecord:null,viewStatus:null,initComponent:function(){var me=this;me.items=me.getItems();this.callParent();me.loadContactPerfectAddress(me.contactRecord);},getItems:function(){var me=this;return[{xtype:'fieldset',title:i18n('i18n.MemberCustEditView.shuttleAddressHobby'),autoScroll:true,layout:{type:'vbox',align:'stretch'},items:[{xtype:'normalbuttonpanel',items:[{xtype:'popleftbuttonpanel',items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.add'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.showCreateAddressHobby},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.update'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.showUpdateAddressHobby},{xtype:'button',text:i18n('i18n.PotentialCustManagerView.delete'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.deleteAddressHobby}]},{xtype:'middlebuttonpanel'}]},{xtype:'popupgridpanel',autoScroll:true,height:125,store:me.memberData.getPreferenceAddressStore(),columns:[{text:i18n('i18n.MemberCustEditView.addressType'),dataIndex:'addressType',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.ADDRESS_TYPE);}},{text:i18n('i18n.PotentialCustEditView.address'),dataIndex:'address'},{text:i18n('i18n.MemberCustEditView.timeHobby'),columns:[{text:i18n('i18n.RewardRuleManagerView.pointbegintime'),dataIndex:'startTime',renderer:me.renderTimeField},{text:i18n('i18n.RewardRuleManagerView.pointendtime'),dataIndex:'endTime',renderer:me.renderTimeField}]},{text:i18n('i18n.MemberCustEditView.invoiceRequirements'),dataIndex:'billRequest',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.BILL_REQUIRE);}},{text:i18n('i18n.MemberCustEditView.parkFee'),dataIndex:'hasStopCost',renderer:DpUtil.changeBooleanToDescrip},{text:i18n('i18n.MemberCustEditView.ortherRequirements'),dataIndex:'otherNeed'},{text:i18n('i18n.MemberCustEditView.deliveryUpstairs'),dataIndex:'isSendToFloor',renderer:DpUtil.changeBooleanToDescrip},{text:i18n('i18n.MemberCustEditView.payWay'),dataIndex:'payType',renderer:function(value){return DpUtil.changeDictionaryCodeToDescrip(value,DataDictionary.PAY_WAY);}}],listeners:{scope:me,itemdblclick:function(grid,record){me.getAddressHobbyWin(me.memberData,record,'view');}}}]}];},renderTimeField:function(value){if(value!=null){return Ext.Date.format(new Date(value),'H 点');}else{return null;}},showCreateAddressHobby:function(){var me=this;var addressHobbyModel=Ext.create('PreferenceAddressModel');me.getAddressHobbyWin(me.memberData,addressHobbyModel,'new');},showUpdateAddressHobby:function(){var me=this;var grid=me.down('grid');var selectModel=grid.getSelectionModel();var selections=selectModel.getSelection();if(selections.length!=1){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.pleaseOneRecordToUpdate'));}else{var selected=selections[0];me.getAddressHobbyWin(me.memberData,selected,'update');}},getAddressHobbyWin:function(memberData,record,viewStatus){Ext.create('MemberAddressHobbyEditWin',{'memberData':memberData,'preferenceAddressRecord':record,'viewStatus':viewStatus}).show();},deleteAddressHobby:function(){var me=this;var grid=me.down('grid');var selectModel=grid.getSelectionModel();var selections=selectModel.getSelection();if(selections.length!=1){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.pleaseOneRecordToDelete'));}else{var selected=selections[0];MessageUtil.showQuestionMes('是否确认要删除这条联系人偏好地址?',function(btn){if(btn=='yes'){me.memberData.getPreferenceAddressStore().remove(selected);}});}},loadContactPerfectAddress:function(contactRecord){var me=this;me.memberData.getPreferenceAddressStore().removeAll();if(me.contactRecord!=null&&　me.contactRecord.get('preferenceAddressList')　!=null){me.memberData.getPreferenceAddressStore().loadData(me.contactRecord.get('preferenceAddressList'));}},collectLinkmanAddressHobbyForSubmit:function(){var me=this;var linkmanAddressArray=new Array();me.memberData.getPreferenceAddressStore().each(function(record){linkmanAddressArray.push(record.data);});return linkmanAddressArray;},collectLinkmanAddrHobbyAlterData:function(alterContactList,alterDeleteList,alterAddList){var me=this;var updateAddressHobbyRecords=me.memberData.getPreferenceAddressStore().getUpdatedRecords();if(updateAddressHobbyRecords.length>0){var fieldsArray=updateAddressHobbyRecords[0].fields.items;for(var j=0;j<updateAddressHobbyRecords.length;j++){for(var i=0;i<fieldsArray.length;i++){var fieldName=fieldsArray[i].name;if(updateAddressHobbyRecords[j].isModified(fieldName)){var basicApproveData=me.getEmptyAddressHobbyApproveData(updateAddressHobbyRecords[j]);basicApproveData.set('fieldName',fieldName);basicApproveData.set('newValue',updateAddressHobbyRecords[j].get(fieldName));alterContactList.push(basicApproveData.data);}}}}
var deleteAddressHobbyRecords=me.memberData.getPreferenceAddressStore().getRemovedRecords();for(var i=0;i<deleteAddressHobbyRecords.length;i++){alterDeleteList.push(me.getEmptyAddressHobbyApproveData(deleteAddressHobbyRecords[i]));}
var addAddressHobbyRecords=me.memberData.getPreferenceAddressStore().getNewRecords();for(var i=0;i<addAddressHobbyRecords.length;i++){alterAddList.push(addAddressHobbyRecords[i].data);}},getEmptyAddressHobbyApproveData:function(addressHobbyRecord){var me=this;var basicApproveData=Ext.create('ApproveDataModel');basicApproveData.set('className','PreferenceAddress');basicApproveData.set('classId',addressHobbyRecord.get('id'));return basicApproveData;},validateLinkmanAddressHobby:function(){var me=this;var success=true;var message='';var preferenceAddressStore=me.memberData.getPreferenceAddressStore();if(preferenceAddressStore.getCount()!=0){var records=preferenceAddressStore.getRange();for(var i=0;i<records.length&&success;i++){if(!records[i].isValid()){success=false;message=i18n('i18n.MemberCustEditView.contactPreferenceAddressAncomplete');}}}
return{'success':success,'message':message};}});Ext.define('MemberAddressHobbyEditWin',{extend:'PopWindow',layout:'fit',items:null,fbar:null,title:i18n('i18n.MemberCustEditView.shuttleAddressHobbyEdit'),width:620,height:200,memberData:null,preferenceAddressRecord:null,viewStatus:null,initComponent:function(){var me=this;me.items=me.getItems();me.fbar=me.getFbar();this.callParent();me.down('form').getForm().loadRecord(me.preferenceAddressRecord);if(!DpUtil.isEmpty(me.preferenceAddressRecord.get('address'))&&!DpUtil.isEmpty(me.preferenceAddressRecord.get('address'))){me.down('form').getForm().findField('address').setValue(me.preferenceAddressRecord.get('address'));if(Ext.isEmpty(me.preferenceAddressRecord.get('id'))){me.down('form').getForm().findField('address').setRawValue(me.preferenceAddressRecord.get('address'));}}
if(me.viewStatus=='new'){var form=me.down('form').getForm();form.reset();form.findField('hasStopCost').setValue(false);form.findField('isSendToFloor').setValue(false);}else if(me.viewStatus=='view'){me.lockAllComponents();}},getItems:function(){var me=this;return[{xtype:'noborderformpanel',layout:{type:'table',columns:3},defaultType:'textfield',defaults:{labelWidth:70,width:194,enableKeyEvents:true,listeners:{scope:me,keypress:me.enterKeyEvent}},items:[{fieldLabel:i18n('i18n.MemberCustEditView.shuttleAddress'),xtype:'dpcombobox',blankText:i18n('i18n.MemberCustEditView.shuttleAddressHobbyAlert'),queryMode:'local',forceSelection:true,displayField:'address',valueField:'address',store:me.memberData.getShuttleAddressStore(),allowBlank:false,name:'address',listeners:{scope:me,keypress:me.enterKeyEvent,select:me.selectAddressEvent,expand:me.expandAddressEvent}},{fieldLabel:i18n('i18n.MemberCustEditView.addressType'),name:'addressType',readOnly:true,xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.memberData.getAddressTypeStore()},{fieldLabel:i18n('i18n.MemberCustEditView.ifThePrimaryAddress'),name:'isMainAddress',xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'name',valueField:'value',store:me.memberData.getBooleanStore(),allowBlank:false,blankText:i18n('i18n.MemberCustEditView.pleaseChooseWhetherNotThePrimaryAddress')},{xtype:'fieldcontainer',layout:{type:'hbox'},defaults:{enableKeyEvents:true},colspan:2,width:388,items:[{xtype:'displayfield',value:i18n('i18n.MemberCustEditView.timeHobbyStart'),width:75},{xtype:'dpdtimefield',name:'startTime',flex:1,increment:60,format:'H 点',listeners:{scope:me,keypress:me.enterKeyEvent,select:me.selectStartTimeEvent}},{xtype:'displayfield',value:i18n('i18n.MemberCustEditView.timeHobbyEnd'),width:75},{xtype:'dpdtimefield',name:'endTime',flex:1,increment:60,format:'H 点',listeners:{scope:me,keypress:me.enterKeyEvent,select:me.selectEndTimeEvent}}]},{fieldLabel:i18n('i18n.MemberCustEditView.invoiceRequirements'),name:'billRequest',xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.memberData.getBillRequireStore()},{fieldLabel:i18n('i18n.MemberCustEditView.parkFee'),name:'hasStopCost',xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'name',valueField:'value',store:me.memberData.getBooleanStore()},{fieldLabel:i18n('i18n.MemberCustEditView.payWay'),name:'payType',xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.memberData.getPayWayStore()},{fieldLabel:i18n('i18n.MemberCustEditView.deliveryUpstairs'),name:'isSendToFloor',xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'name',valueField:'value',store:me.memberData.getBooleanStore()},{fieldLabel:i18n('i18n.MemberCustEditView.ortherRequirements'),colspan:3,width:582,name:'otherNeed',maxLength:10,emptyText:i18n('i18n.MemberCustEditView.m_max10')},{name:'shuttleAddress',hidden:true}]}];},getFbar:function(){var me=this;return[{xtype:'button',text:i18n('i18n.MemberCustEditView.submit'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.commitLinkmanAddressHobby},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),handler:function(){me.close();}}];},enterKeyEvent:function(field,event){var me=this;var form=me.down('form');if(event.getKey()==Ext.EventObject.ENTER){if(field.fieldLabel==i18n('i18n.MemberCustEditView.shuttleAddress')){form.getForm().findField('startTime').focus();}else if(field.name=='startTime'){form.getForm().findField('endTime').focus();}else if(field.name=='endTime'){form.getForm().findField('billRequest').focus();}else{if(field.next()!=null){field.next().focus();}else{me.down('button').focus();}}}},selectAddressEvent:function(combox,records){if(records.length>0){var addressTypeCombo=combox.next('combobox');addressTypeCombo.setValue(records[0].get('addressType'));combox.up('form').getForm().findField('shuttleAddress').setValue(records[0].get('shuttleAddress'));}},expandAddressEvent:function(combox){if(combox.getStore().getCount()==0){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.plesaeAddAddressContactWar'));}},selectStartTimeEvent:function(timefield,value){var endTimeField=timefield.next('timefield');if(!DpUtil.isEmpty(endTimeField.getValue())&&value>=endTimeField.getValue()){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.theTheStartTimeMustBeLaterThanEndTimePreferenceWar'));timefield.setValue(null);}},selectEndTimeEvent:function(timefield,value){var startTimeField=timefield.prev('timefield');if(!DpUtil.isEmpty(startTimeField.getValue())&&value<=startTimeField.getValue()){MessageUtil.showMessage(i18n('i18n.MemberCustEditView.theEndTimePreferenceMustBeLaterThanTheStartTimeWar'));timefield.setValue(null);}},commitLinkmanAddressHobby:function(){var me=this;var validateRs=me.validateLinkmanAddressHobby();if(validateRs.success){me.down('form').getForm().updateRecord(me.preferenceAddressRecord);if(me.viewStatus=='new'){me.memberData.getPreferenceAddressStore().insert(0,me.preferenceAddressRecord);}
me.close();}else if(!DpUtil.isEmpty(validateRs.message)){MessageUtil.showMessage(validateRs.message);}},validateLinkmanAddressHobby:function(){var me=this;var success=true;var message='';if(me.down('form').getForm().isValid()){if(me.down('form').getForm().findField('isMainAddress').getValue()==true){var recordIndex=me.memberData.getPreferenceAddressStore().find('isMainAddress',true);if(recordIndex!=-1&&me.memberData.getPreferenceAddressStore().getAt(recordIndex)!=me.preferenceAddressRecord){success=false;message=i18n('i18n.MemberCustEditView.oneAddressOnlyHaveOneAddress');return{'success':success,'message':message};}}
var addresses=me.memberData.getPreferenceAddressStore().getRange();var shuttleAddress=me.preferenceAddressRecord.get('address');var addressType=me.preferenceAddressRecord.get('addressType');shuttleAddress=me.down('form').getForm().findField('address').rawValue;addressType=me.down('form').getForm().findField('addressType').getValue();for(var i=0;i<addresses.length;i++){if(me.preferenceAddressRecord!=addresses[i]&&addresses[i].get('address')==shuttleAddress&&addresses[i].get('addressType')==addressType){success=false;message=i18n('i18n.MemberCustEditView.oneContactOnlyAddressPleaseUpdate');return{'success':success,'message':message};}}}else{success=false;}
return{'success':success,'message':message};},lockAllComponents:function(){var me=this;var addressHobby=me.down('form').getForm();addressHobby.getFields().each(function(field){field.setReadOnly(true);});}});Ext.define('MemberAccountEditWin',{extend:'PopWindow',layout:'fit',items:null,fbar:null,title:i18n('i18n.MemberCustEditView.memberAccountEditUI'),width:700,height:230,memberData:null,accountRecord:null,viewStatus:null,initComponent:function(){var me=this;me.items=me.getItems();me.fbar=me.getFbar();this.callParent();me.memberData.getBankNameStore().load();if(me.accountRecord!=null){var bankModel=Ext.create('BankSearchConditionModel');bankModel.set('accountBank',me.accountRecord.get('bank'));bankModel.set('accountBankId',me.accountRecord.get('bankId'));bankModel.set('accountBranch',me.accountRecord.get('subBankname'));bankModel.set('accountBranchId',me.accountRecord.get('subBanknameId'));me.memberData.getBankComboxStore().add(bankModel);me.down('form').loadRecord(me.accountRecord);if(DpUtil.isEmpty(me.down('form').getForm().findField('name').getValue())&&!DpUtil.isEmpty(me.accountRecord.get('financeLinkman'))){var linkmanStore=me.memberData.getContactStore();var isFind=false;var selectedLinkman=null;for(var i=0;i<linkmanStore.getCount()&&!isFind;i++){if(linkmanStore.getAt(i).get('name')==me.accountRecord.get('financeLinkman')&&linkmanStore.getAt(i).get('mobilePhone')==me.accountRecord.get('linkManMobile')&&linkmanStore.getAt(i).get('telPhone')==me.accountRecord.get('linkManPhone')){isFind=true;selectedLinkman=linkmanStore.getAt(i);}}
me.down('form').getForm().findField('name').select(selectedLinkman);}
if(me.viewStatus=='new'){me.down('form').getForm().reset();}
if(me.viewStatus=='view'){me.lockAllComponents();}}},getItems:function(){var me=this;return[{xtype:'noborderformpanel',layout:{type:'table',columns:3},defaultType:'textfield',defaults:{labelWidth:70,width:210,enableKeyEvents:true,listeners:{scope:me,keypress:me.enterKeyEvent},allowBlank:false},items:[{xtype:'queryCombox',fieldLabel:i18n('i18n.MemberCustEditView.branchBankName'),name:'subBanknameId',blankText:i18n('i18n.MemberCustEditView.branchBankNameAlert'),subBankWindow:null,store:me.memberData.getBankComboxStore(),displayField:'accountBranch',valueField:'accountBranchId',queryMode:'local',forceSelection:true,queryDelay:2000,listeners:{'expand':function(subBankCombox){if(subBankCombox.subBankWindow==null){subBankCombox.subBankWindow=Ext.create('BankSearchUI',{'memberData':me.memberData,'parent':subBankCombox});}else{subBankCombox.subBankWindow.searchConditionPanel.getForm().reset();me.memberData.getBankInfoStore().removeAll();}
subBankCombox.subBankWindow.show();var position=subBankCombox.getPosition();position[1]=position[1]+22;subBankCombox.subBankWindow.setPosition(position);},'change':function(subBankCombox){if(DpUtil.isEmpty(subBankCombox.getValue())){subBankCombox.setValue(null);var basicForm=me.down('form').getForm();basicForm.findField('bankProvinceId').setValue(null);basicForm.findField('bankCityId').setValue(null);basicForm.findField('bankId').setValue(null);}}},setValueComeback:function(backRecord){me.memberData.getBankComboxStore().add(backRecord);var basicForm=this.up('form').getForm();this.setValue(backRecord.get('accountBranchId'));basicForm.findField('subBankname').setValue(backRecord.get('accountBank'));basicForm.findField('bankId').setValue(backRecord.get('accountBankId'));basicForm.findField('bank').setValue(backRecord.get('accountBank'));basicForm.findField('bankProvinceName').setValue(backRecord.get('province'));basicForm.findField('bankCityName').setValue(backRecord.get('city'));basicForm.findField('bankProvinceId').setValue(backRecord.get('provinceId'));basicForm.findField('bankCityId').setValue(backRecord.get('cityId'));}},{xtype:'fieldcontainer',layout:{type:'hbox'},defaults:{xtype:'textfield',hideLabel:true,allowBlank:false,readOnly:true},items:[{xtype:'displayfield',value:i18n('i18n.MemberCustEditView.accountProvinceCityWar'),width:75},{name:'bankProvinceName',blankText:i18n('i18n.MemberCustEditView.openProvinceAlert'),flex:1},{name:'bankCityName',blankText:i18n('i18n.MemberCustEditView.openCityAlert'),flex:1}]},{xtype:'dpcombobox',fieldLabel:i18n('i18n.MemberCustEditView.bankName'),name:'bankId',blankText:i18n('i18n.MemberCustEditView.pleaseInputBank'),hideTrigger:true,store:me.memberData.getBankComboxStore(),displayField:'accountBank',valueField:'accountBankId',queryMode:'local',readOnly:true},{fieldLabel:i18n('i18n.MemberCustEditView.whetherTheDefaultAccount'),name:'isdefaultaccount',blankText:i18n('i18n.MemberCustEditView.isAcquiesceAccountAlert'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'name',valueField:'value',store:me.memberData.getBooleanStore()},{fieldLabel:i18n('i18n.MemberCustEditView.accountNo'),name:'bankAccount',regex:/^\d{0,}$/,maxLength:80,blankText:i18n('i18n.MemberCustEditView.accountNoAlert')},{fieldLabel:i18n('i18n.MemberCustEditView.nameOfAccountHolder'),name:'countName',maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),blankText:i18n('i18n.MemberCustEditView.openNameAlert')},{fieldLabel:i18n('i18n.MemberCustEditView.CRAccount'),name:'relation',maxLength:50,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',50),blankText:i18n('i18n.MemberCustEditView.CRAccountAlert')},{fieldLabel:i18n('i18n.MemberCustEditView.accountNature'),name:'accountNature',blankText:i18n('i18n.MemberCustEditView.accountNatureAlert'),xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.memberData.getAccountNatureStore()},{fieldLabel:i18n('i18n.MemberCustEditView.accountPurpose'),name:'accountUse',xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',store:me.memberData.getAccountUseStore(),blankText:i18n('i18n.MemberCustEditView.accountUseAlert')},{fieldLabel:i18n('i18n.MemberCustEditView.financeContact'),name:'name',blankText:i18n('i18n.MemberCustEditView.financeContactAlert'),xtype:'dpcombobox',displayField:'name',valueField:'name',queryMode:'local',store:me.memberData.getContactStore(),listeners:{scope:me,keypress:me.enterKeyEvent,select:me.selectLinkmanEvent}},{fieldLabel:i18n('i18n.MemberCustEditView.contactPhone'),name:'linkManMobile',blankText:i18n('i18n.MemberCustEditView.contactPhoneAlert'),readOnly:true,allowBlank:true},{fieldLabel:i18n('i18n.MemberCustEditView.contactTel'),name:'linkManPhone',blankText:i18n('i18n.MemberCustEditView.contactTelAlert'),readOnly:true,allowBlank:true},{name:'subBankname',hidden:true},{name:'bank',hidden:true},{name:'financeLinkmanId',allowBlank:true,hidden:true},{name:'financeLinkman',hidden:true},{name:'bankProvinceId',hidden:true},{name:'bankCityId',hidden:true}]}];},getFbar:function(){var me=this;return[{xtype:'button',text:i18n('i18n.MemberCustEditView.submit'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.commitMemberAccount},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),handler:function(){me.close();}}];},enterKeyEvent:function(field,event){var me=this;if(event.getKey()==Ext.EventObject.ENTER){if(field.next()!=null){field.next().focus();}else{me.down('button').focus();}}},commitMemberAccount:function(){var me=this;if(me.down('form').getForm().isValid()){var titleDescrip=(me.viewStatus=='new')?i18n('i18n.PotentialCustManagerView.add'):i18n('i18n.PotentialCustManagerView.update');MessageUtil.showQuestionMes(i18n('i18n.MemberCustEditView.sureYouWantTo')+titleDescrip+'这条账号信息?',function(btn){if(btn=='yes'){me.down('form').getForm().updateRecord(me.accountRecord);if(me.viewStatus=='new'){me.memberData.getAccountStore().insert(0,me.accountRecord);}
me.close();}});}},selectLinkmanEvent:function(combox,records){if(records.length>0){var form=combox.up('form').getForm();var mobile=form.findField('linkManMobile');mobile.setValue(records[0].get('mobilePhone'));var phone=form.findField('linkManPhone');phone.setValue(records[0].get('telPhone'));var linkmanName=form.findField('financeLinkman');linkmanName.setValue(records[0].get('name'));var linkmanName=form.findField('financeLinkmanId');linkmanName.setValue(records[0].get('id'));}},lockAllComponents:function(){var me=this;var accountForm=me.down('form').getForm();accountForm.getFields().each(function(field){field.setReadOnly(true);});}});Ext.define('BankSearchUI',{extend:'PopWindow',items:null,searchConditionPanel:null,buttonPanel:null,searchResultPanel:null,title:i18n('i18n.MemberCustEditView.sub-branchInformationQueryInterface'),layout:{type:'vbox',align:'stretch'},width:650,height:400,searchBankRecord:null,memberData:null,parent:null,listeners:{beforeclose:function(bankSearchWin){bankSearchWin.hide();return false;}},initComponent:function(){var me=this;me.searchConditionPanel=Ext.create('BankSearchConditionPanel',{'parent':me,'memberData':me.memberData});me.buttonPanel=Ext.create('BankButtonPanel',{'parent':me,'memberData':me.memberData});me.searchResultPanel=Ext.create('BankSearchResultGrid',{'memberData':me.memberData,'parent':me.parent});me.items=[{xtype:'basicpanel',items:[me.searchConditionPanel],height:50},me.buttonPanel,{xtype:'basicpanel',items:[me.searchResultPanel],flex:1}];this.callParent();me.searchBankRecord=Ext.create('BankSearchConditionModel');me.searchConditionPanel.getForm().loadRecord(me.searchBankRecord);}});Ext.define('BankSearchConditionPanel',{extend:'SearchFormPanel',memberData:null,layout:{type:'table',columns:4},items:null,defaultType:'textfield',defaults:{labelWidth:60,width:150},initComponent:function(){var me=this;me.items=me.getItems();this.callParent();me.memberData.getBankNameStore().load();},getItems:function(){var me=this;return[{xtype:'fieldcontainer',layout:{type:'hbox'},defaults:{xtype:'dpcombo',hideLabel:true,allowBlank:false},width:235,items:[{xtype:'displayfield',value:i18n('i18n.MemberCustEditView.accountProvinceCityWar'),width:75},{name:'provinceId',blankText:i18n('i18n.MemberCustEditView.openProvinceAlert'),store:me.memberData.getBankProvinceStore(),displayField:'name',valueField:'id',flex:1,queryMode:'local',listeners:{select:function(combo,records){if(records.length>0){var form=combo.up('form').getForm();form.findField('cityId').setValue();me.memberData.getBankCityStore().load({params:{bankprovince:records[0].get('id')}});}}}},{name:'cityId',blankText:i18n('i18n.MemberCustEditView.openCityAlert'),store:me.memberData.getBankCityStore(),displayField:'name',valueField:'id',queryMode:'local',forceSelection:true,flex:1,listConfig:{    loadMask:false}}]},{xtype:'dpcombo',name:'accountBank',fieldLabel:i18n('i18n.MemberCustEditView.bankName'),store:me.memberData.getBankNameStore(),displayField:'name',valueField:'name',flex:1,blankText:i18n('i18n.MemberCustEditView.pleaseInputBank'),editable:false},{fieldLabel:i18n('i18n.MemberCustEditView.branchBankName'),name:'accountBranch'}];}});Ext.define('BankButtonPanel',{extend:'NormalButtonPanel',items:null,parent:null,memberData:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'middlebuttonpanel'},{xtype:'rightbuttonpanel',items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.search'),scope:me,handler:me.searchBank},{xtype:'button',text:i18n('i18n.MemberCustEditView.reset'),scope:me,handler:me.resetCondition}]}];},searchBank:function(){var me=this;me.parent.searchConditionPanel.getForm().updateRecord(me.parent.searchBankRecord);var params={};params.bankView=me.parent.searchBankRecord.data;var searchSuccessFn=function(result){var bankView=result.bankViewList;if(bankView!=null&&bankView.length>0){me.memberData.getBankInfoStore().loadData(bankView);}else{MessageUtil.showMessage(i18n('i18n.MemberCustEditView.relevantBankInformationNotFound'));}};var failSuccessFn=function(result){if(!DpUtil.isEmpty(result.message)){MessageUtil.showMessage(result.message);}else{MessageUtil.showMessage(i18n('i18n.MemberCustEditView.serverExceptionWar'));}}
me.memberData.searchBankInfo(params,searchSuccessFn,failSuccessFn);},manageModel4BankCity:function(searchBankModel){var me=this;if(!Ext.isEmpty(searchBankModel)){var cityId=searchBankModel.get('cityId');if(!Ext.isEmpty(cityId)){var pca=cityId.split(i18n('i18n.PotentialCustManagerView.searchEndTime'));if(pca>1){searchBankModel.set('cityId',pca[1]);searchBankModel.set('provinceId',pca[0]);}}
return searchBankModel;}
return searchBankModel;},resetCondition:function(){var me=this;me.parent.searchConditionPanel.getForm().reset();}});Ext.define('BankSearchResultGrid',{extend:'PopupGridPanel',memberData:null,columns:[{text:i18n('i18n.MemberCustEditView.belongProvince'),dataIndex:'province'},{text:i18n('i18n.MemberCustEditView.belongCity'),dataIndex:'city'},{text:i18n('i18n.MemberCustEditView.bankAccount'),dataIndex:'accountBank'},{text:i18n('i18n.MemberCustEditView.branchBankName'),dataIndex:'accountBranch'}],store:null,parent:null,initComponent:function(){var me=this;me.store=me.memberData.getBankInfoStore();me.listeners={scope:me,itemdblclick:me.doubleClickEvent};this.callParent();},doubleClickEvent:function(view,record){var me=this;me.parent.setValueComeback(record);me.parent.subBankWindow.hide();}});Ext.define('MemberAddressEditwin',{extend:'PopWindow',title:i18n('i18n.MemberCustEditView.shuttleAddressEditUI'),items:null,fbar:null,width:500,height:180,layout:'fit',memberData:null,shuttleAddressRecord:null,viewStatus:null,initComponent:function(){var me=this;me.items=me.getItems();me.fbar=me.getFbar();this.callParent();if(me.shuttleAddressRecord!=null){me.down('form').getForm().loadRecord(me.shuttleAddressRecord);if(me.viewStatus=='new'){me.down('form').getForm().reset();}else if(me.viewStatus=='update'){me.down('form').getForm().findField('address').setValue(me.shuttleAddressRecord.get('address'));}else if(me.viewStatus=='view'){me.lockAllComponents();}}},getItems:function(){var me=this;var operateType=null;if(me.viewStatus=='update'){operateType='UPDATE';}else if(me.viewStatus=='view'){operateType='VIEW';}
return[{xtype:'noborderformpanel',layout:{type:'table',columns:3},defaultType:'textfield',defaults:{labelWidth:70,width:120,enableKeyEvents:true,listeners:{scope:me,keypress:me.enterKeyEvent}},items:[{fieldLabel:i18n('i18n.MemberCustEditView.addressType'),name:'addressType',colspan:3,width:310,xtype:'dpcombobox',queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code',allowBlank:false,store:me.memberData.getAddressTypeStore(),blankText:i18n('i18n.MemberCustEditView.addressTypeAlert')},{fieldLabel:i18n('i18n.PotentialCustEditView.address'),xtype:'areaaddresscombox',name:'area',colspan:3,width:310,operateType:operateType,selectedValue:me.shuttleAddressRecord.get('area'),tabPanel:['provincePanel','cityPanel','areaPanel'],blankText:i18n('i18n.MemberCustEditView.pleaseSelectProviceCityArea'),emptyText:i18n('i18n.MemberCustEditView.pleaseSelectProviceCityArea'),allowBlank:false,listeners:{change:function(combobox,newValue,oldValue){if(!DpUtil.isEmpty(newValue)){var array=combobox.getRawValue().split(i18n('i18n.PotentialCustManagerView.searchEndTime'));if(array.length==3){me.down('form').getForm().findField('provinceName').setValue(array[0]);me.down('form').getForm().findField('cityName').setValue(array[1]);me.down('form').getForm().findField('areaName').setValue(array[2]);me.down('form').getForm().findField('address').setValue(array[0]+array[1]+array[2]);}}}}},{xtype:'displayfield',width:75},{hideLabel:true,colspan:2,width:375,name:'address',allowBlank:false,maxLength:300,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',300),blankText:i18n('i18n.MemberCustEditView.detailAddressAlert'),emptyText:i18n('i18n.MemberCustEditView.detailAddressAlert')},{name:'provinceId',hidden:true},{name:'cityId',hidden:true},{name:'provinceName',hidden:true},{name:'cityName',hidden:true},{name:'areaName',hidden:true}]}];},getFbar:function(){var me=this;return[{xtype:'button',text:i18n('i18n.MemberCustEditView.submit'),disabled:('view'==me.viewStatus)?true:false,scope:me,handler:me.commitMemberAddress},{xtype:'button',text:i18n('i18n.ManualRewardIntegralEditView.b_cance'),handler:function(){me.close();}}];},enterKeyEvent:function(field,event){var me=this;var form=me.down('form');if(event.getKey()==Ext.EventObject.ENTER){if(field.name=='addressType'){form.getForm().findField('address').focus();}else{if(field.next()!=null){field.next().focus();}else{me.down('button').focus();}}}},commitMemberAddress:function(){var me=this;var validateRs=me.validateMemberAddress();var titleDescrip=(me.viewStatus=='new')?i18n('i18n.PotentialCustManagerView.add'):i18n('i18n.PotentialCustManagerView.update');if(validateRs.success){MessageUtil.showQuestionMes(i18n('i18n.MemberCustEditView.sureYouWantTo')+titleDescrip+'这条接送货地址?',function(btn){if(btn=='yes'){me.down('form').getForm().updateRecord(me.shuttleAddressRecord);me.manageModel4Area(me.shuttleAddressRecord);if(me.viewStatus=='new'){me.memberData.getShuttleAddressStore().insert(0,me.shuttleAddressRecord);}
me.close();}});}else if(!DpUtil.isEmpty(validateRs.message)){MessageUtil.showMessage(validateRs.message);}},manageModel4Area:function(shuttleAddressModel){var me=this;if(!Ext.isEmpty(shuttleAddressModel)){var area=shuttleAddressModel.get('area');if(!Ext.isEmpty(area)){var pca=area.split(i18n('i18n.PotentialCustManagerView.searchEndTime'));if(pca.length>2){shuttleAddressModel.set('area',pca[2]);shuttleAddressModel.set('city',pca[1]);shuttleAddressModel.set('province',pca[0]);}}
return shuttleAddressModel;}
return shuttleAddressModel;},validateMemberAddress:function(){var me=this;var success=true;var message='';var basicForm=me.down('form').getForm();if(basicForm.isValid()){var area=basicForm.findField('area').getValue();if(!Ext.isEmpty(area)){var pca=area.split(i18n('i18n.PotentialCustManagerView.searchEndTime'));if(pca.length>2){var addressRecords=me.memberData.getShuttleAddressStore().getRange();var addressType=basicForm.findField('addressType').getValue();area=pca[2];var address=basicForm.findField('address').getValue();for(var i=0;i<addressRecords.length;i++){if(me.shuttleAddressRecord!=addressRecords[i]&&(addressRecords[i].get('addressType')==addressType)&&(addressRecords[i].get('area')==area)&&(addressRecords[i].get('address')==address)){success=false;message=i18n('i18n.MemberCustEditView.thereSameShippingAddressInformationPleaseRe-entry');}}}else{success=false;message=i18n('i18n.MemberCustEditView.addressOfProvincesMunicipalitiesMustChooseToDistrict');}}else{success=false;message=i18n('i18n.MemberCustEditView.addressOfProvincesMunicipalitiesMustChooseToDistrict');}}else{success=false;message=i18n('i18n.MemberCustEditView.pleaseCheckWhetherTheRequiredCompletedWar');}
return{'success':success,'message':message};},lockAllComponents:function(){var me=this;var addressForm=me.down('form').getForm();addressForm.getFields().each(function(field){field.setReadOnly(true);});}});
var memberManagerDataControl=new MemberManagerData();Ext.define('Ext.ux.PageComboResizer',{extend:Object,pageSizes:[5,10,15,20,25,30,50],prefixText:'每页显示 ',postfixText:i18n('i18n.MemberManagerView.record'),constructor:function(config){Ext.apply(this,config);this.callParent(arguments);},init:function(pagingToolbar){var ps=this.pageSizes;var combo=Ext.create('Ext.form.ComboBox',{typeAhead:true,triggerAction:'all',lazyRender:true,mode:'local',width:45,store:ps,listeners:{select:function(c,r,s){pagingToolbar.store.pageSize=r[0].data.field1;pagingToolbar.store.loadPage(pagingToolbar.store.currentPage);}}});Ext.iterate(this.pageSizes,function(ps){if(ps==pagingToolbar.store.pageSize){combo.setValue(ps);return;}});var inputIndex=pagingToolbar.items.indexOf(pagingToolbar.items.get('refresh'));pagingToolbar.insert(++inputIndex,i18n('i18n.PotentialCustManagerView.searchEndTime'));pagingToolbar.insert(++inputIndex,this.prefixText);pagingToolbar.insert(++inputIndex,combo);pagingToolbar.insert(++inputIndex,this.postfixText);pagingToolbar.on({beforedestroy:function(){combo.destroy();}});}});Ext.define('MemberManagerPanel',{extend:'BasicPanel',parent:null,memberManagerConditionForm:null,memberManagerResultGrid:null,memberManagerButtonPanel:null,memberManagerData:null,layout:{type:'vbox',align:'stretch'},items:null,initComponent:function(){var me=this;var record=new SearchMemberConditionModel();me.memberManagerConditionForm=Ext.create('MemberManagerConditionForm',{'parent':me,'record':record,'memberManagerData':me.memberManagerData});me.memberManagerResultGrid=Ext.create('MemberManagerResultGrid',{'parent':me,'memberManagerData':me.memberManagerData});me.memberManagerButtonPanel=Ext.create('MemberManagerButtonPanel',{'parent':me,'memberManagerData':me.memberManagerData});me.items=[{xtype:'basicpanel',height:80,items:[me.memberManagerConditionForm]},{xtype:'basicpanel',height:36,items:[me.memberManagerButtonPanel]},{xtype:'basicpanel',flex:1,items:[me.memberManagerResultGrid]}];this.callParent();me.memberManagerConditionForm.loadRecord(record);DpUtil.defaultDept(me.memberManagerConditionForm,'deptId');}});Ext.define('MemberManagerButtonPanel',{extend:'NormalButtonPanel',memberManagerData:null,parent:null,initComponent:function(){this.items=this.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'leftbuttonpanel',width:430,items:[{xtype:'button',text:i18n('i18n.MemberManagerView.maintenanceMemberInformation'),hidden:!isPermission('/customer/MemberManagerUBtn.action'),scope:me,handler:function(){me.maintainMemberInfo('update');}},{xtype:'button',text:i18n('i18n.MemberManagerView.t_memDeptChange'),hidden:!isPermission('/customer/MemberManagerDeptChangeBtn.action'),scope:me,handler:me.changeMemberDept},{xtype:'button',text:i18n('i18n.MemberManagerView.t_viewMemDetail'),hidden:!isPermission('/customer/MemberManagerVBtn.action'),scope:me,handler:function(){me.maintainMemberInfo('view');}}]},{xtype:'middlebuttonpanel'},{xtype:'rightbuttonpanel',width:150,items:[{xtype:'button',text:i18n('i18n.PotentialCustManagerView.search'),hidden:!isPermission('/customer/MemberManagerSBtn.action'),scope:me,handler:me.searchScatterMemberList}]}];},changeMemberDept:function(){var me=this;var grid=me.parent.memberManagerResultGrid;var selection=grid.getSelectionModel().getSelection();if(selection.length!=1){MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.operation_message'));return;}
if(top.User.deptId==selection[0].get('deptId')){MessageUtil.showMessage(i18n('i18n.MemberManagerView.t_cannotChangeDept'));return;}
if('1'==selection[0].get('status')){MessageUtil.showMessage(i18n('i18n.MemberManagerView.t_memberInfoIsApply'));return;}
Ext.create('ChangeMemberDeptWin',{'memberData':me.memberManagerData,'updateMemberParent':me.parent,'operateGrid':me.parent.memberManagerResultGrid,'changeMemberDeptRecord':me.member2ChangeMemberDept(selection[0]),'viewStatus':'NEW'}).show();},searchScatterMemberList:function(){var me=this;if(!me.validateCondition()){MessageUtil.showMessage(i18n('i18n.MemberUpgradeView.message_notAllNull'));return;}
if(!me.parent.memberManagerConditionForm.getForm().isValid()){MessageUtil.showMessage(i18n('i18n.MemberManagerView.pleaseCheckTheInputQueryFillInTheCorrect'));return;}
me.memberManagerData.getMemberSearchStore().loadPage(1);},validateCondition:function(){var me=this;var form=me.parent.memberManagerConditionForm;var flag=false;form.getForm().getFields().each(function(field){if(!(DpUtil.isEmpty(field.getValue()))){flag=true;}});return flag;},maintainMemberInfo:function(viewValue){var me=this;var grid=me.parent.memberManagerResultGrid;var selection=grid.getSelectionModel().getSelection();if(selection.length!=1){MessageUtil.showMessage(i18n('i18n.PotentialCustManagerView.operation_message'));return;}
if('update'==viewValue){if(top.User.deptId!=selection[0].get('deptId')){MessageUtil.showMessage(i18n('i18n.MemberManagerView.t_cannotUpdateMember'));return;}
if('1'==selection[0].get('status')){MessageUtil.showMessage(i18n('i18n.MemberManagerView.memberInformationCanNotModifiedApproval'));return;}}
me.getMemberEditWin(selection[0],me.memberManagerData,viewValue,me.parent);},member2ChangeMemberDept:function(memberRecord){var me=this;var changeMemberDept=Ext.create('ChangeMemberDeptModel');changeMemberDept.set('memberId',memberRecord.get('custId'));changeMemberDept.set('memberNumber',memberRecord.get('custNum'));changeMemberDept.set('fromDeptId',memberRecord.get('deptId'));changeMemberDept.set('fromDeptName',memberRecord.get('deptName'));changeMemberDept.set('toDeptId',memberRecord.get('toDeptId'));changeMemberDept.set('toDeptName',memberRecord.get('toDeptName'));return changeMemberDept;},getMemberEditWin:function(record,memberManagerData,viewStatus,updateMemberParent){var searchByIdSuccess=function(response){var memberInfo=response.member;Ext.create('MemberCustEditWindow',{'member':memberInfo,'updateMemberParent':updateMemberParent,'y':30,'viewStatus':viewStatus}).show();};var searchByIdFail=function(response){MessageUtil.showErrorMes(response.message);};var params={'searchCustCondition':{'memberId':record.get('custId'),'deptId':record.get('deptId')}};memberManagerData.acquireMemberById(params,searchByIdSuccess,searchByIdFail);}});Ext.define('MemberManagerConditionForm',{extend:'SearchFormPanel',id:'memberManagerConditionFormId',parent:null,record:null,layout:{type:'table',columns:4},defaultType:'textfield',memberManagerData:null,initComponent:function(){var me=this;me.defaults=me.getDefaultsContainer();me.items=me.getItems();this.callParent();},getItems:function(){var me=this;return[{xtype:'belongdeptcombox',fieldLabel:i18n('i18n.ScatterUpgradeView.belongdeptName'),maxLength:50,forceSelection:true,name:'deptId'},{fieldLabel:i18n('i18n.MemberCustEditView.custNo'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'custNumber'},{fieldLabel:i18n('i18n.PotentialCustManagerView.customerName'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'custName'},{fieldLabel:i18n('i18n.MemberCustEditView.custLevel'),name:'custGrad',maxLength:10,xtype:'combobox',store:me.memberManagerData.getMemberGradeStore(),queryMode:'local',forceSelection:true,displayField:'codeDesc',valueField:'code'},{fieldLabel:i18n('i18n.MemberCustEditView.contactNo'),maxLength:40,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',40),name:'linkManNumber'},{fieldLabel:i18n('i18n.ManualRewardIntegralEditView.name'),maxLength:80,maxLengthText:i18n('i18n.ManualRewardIntegralEditView.m_maxLength',80),name:'linkManName'},{fieldLabel:i18n('i18n.MemberCustEditView.mobileNo'),maxLength:11,regex:DpUtil.linkWayLimit('M'),regexText:i18n('i18n.MemberCustEditView.pleaseInputCorrectMobilePhone'),name:'mobile'},{fieldLabel:i18n('i18n.MemberCustEditView.telephoneNo'),regex:DpUtil.linkWayLimit('T'),regexText:i18n('i18n.MemberManagerView.pleaseEnterTheCorrectPhoneNumber'),maxLength:16,name:'telePhone'}];},getDefaultsContainer:function(){var me=this;return{labelWidth:70,width:195,enableKeyEvents:true,listeners:{scope:me,keypress:me.keypressEvent,change:me.changeEvent}};},keypressEvent:function(field,event){var me=this;if(event.getKey()==Ext.EventObject.ENTER){me.parent.memberManagerButtonPanel.searchScatterMemberList();}},changeEvent:function(field,newValue){var me=this;if(('belongdeptcombox'==field.getXType()||'combobox'==field.getXType())&&Ext.isEmpty(newValue)){field.setValue(null);}}});Ext.define('MemberManagerResultGrid',{extend:'SearchGridPanel',parent:null,memberManagerData:null,initComponent:function(){var me=this;me.listeners=me.getMylistener();me.store=me.memberManagerData.initMemberSearchStore(me.beforeLoadScatterFn);me.selModel=Ext.create('Ext.selection.CheckboxModel',{'mode':'SINGLE'});me.dockedItems=me.getMyDockedItems();me.columns=me.getColumns();this.callParent();},features:[{ftype:'groupingsummary',startCollapsed:true,groupHeaderTpl:'{name} ({rows.length})',hideGroupedHeader:true,enableGroupingMenu:false}],getMylistener:function(){var me=this;return{scope:me,itemdblclick:function(grid,record){me.parent.memberManagerButtonPanel.getMemberEditWin(record,me.memberManagerData,'view',me.parent);},scrollershow:function(scroller){if(scroller&&scroller.scrollEl){scroller.clearManagedListeners();scroller.mon(scroller.scrollEl,'scroll',scroller.onElScroll,scroller);}}};},getColumns:function(){var me=this;return[{header:i18n('i18n.MemberManagerView.customerGrouping'),dataIndex:'custGroup'},{header:i18n('i18n.ChangeContactAffiliatedRelationView.custId'),hidden:true,dataIndex:'custId'},{header:i18n('i18n.MemberCustEditView.custNo'),dataIndex:'custNum',hidden:true},{header:i18n('i18n.PotentialCustManagerView.customerName'),dataIndex:'custName',hidden:true},{header:i18n('i18n.MemberCustEditView.custLevel'),dataIndex:'custGrade',hidden:true},{header:i18n('i18n.MemberCustEditView.contactNo'),dataIndex:'contactNum'},{header:i18n('i18n.PotentialCustManagerView.contactName'),dataIndex:'contactName'},{header:i18n('i18n.MemberCustEditView.mobileNo'),dataIndex:'mobileNum'},{header:i18n('i18n.MemberCustEditView.telephoneNo'),dataIndex:'telNum'},{header:i18n('i18n.ScatterUpgradeView.belongDeptId'),hidden:true,dataIndex:'deptId'},{header:i18n('i18n.ScatterUpgradeView.belongdeptName'),dataIndex:'deptName'},{header:i18n('i18n.MemberManagerView.approvalStatus'),hidden:true,dataIndex:'status'}];},getMyDockedItems:function(){var me=this;return[{xtype:'pagingtoolbar',plugins:[Ext.create('Ext.ux.PageComboResizer')],store:me.store,dock:'bottom',displayInfo:true}];},beforeLoadScatterFn:function(store,operation,eOpts){var searchConditionForm=Ext.getCmp('memberManagerConditionFormId');if(searchConditionForm!=null){searchConditionForm.getForm().updateRecord(searchConditionForm.record);var searchCustCondition=searchConditionForm.record.data;var searchParams={'searchCustCondition.deptId':searchCustCondition.deptId,'searchCustCondition.custNumber':searchCustCondition.custNumber,'searchCustCondition.custName':searchCustCondition.custName,'searchCustCondition.custGrad':searchCustCondition.custGrad,'searchCustCondition.linkManNumber':searchCustCondition.linkManNumber,'searchCustCondition.linkManName':searchCustCondition.linkManName,'searchCustCondition.mobile':searchCustCondition.mobile,'searchCustCondition.telePhone':searchCustCondition.telePhone};Ext.apply(operation,{params:searchParams});}}});Ext.onReady(function(){var params=['MEMBER_GRADE','TRADE','CUSTOMER_NATURE','COMP_NATURE','CUSTOMER_TYPE','CUST_POTENTIAL','CARGO_POTENTIAL','FIRM_SIZE','CREDIT_GRADE','ADDRESS_TYPE','LOGIST_DECI','PAY_WAY','PREFERENCE_CHANNEL','PREFERENCE_SERVICE','BILL_REQUIRE','ACCOUNT_NATURE','ACCOUNT_USE','GENDER','MARKETINFO'];initDataDictionary(params);memberManagerDataControl.initSelfDefineLinkmanType(DataDictionary);Ext.create('Ext.container.Viewport',{layout:'fit',items:[Ext.create('MemberManagerPanel',{'memberManagerData':memberManagerDataControl})]});});